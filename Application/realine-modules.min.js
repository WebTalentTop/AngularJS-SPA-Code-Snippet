function aCtx(){for(var e=window;e;){if(e.videoRoomAppContext)return e.videoRoomAppContext;e=e.opener}return window.top.videoRoomAppContext}function VideoRoomAppContext(){this.getJanusMng=function(){return JanusMng},this.getVideoRoomMng=function(){return VideoRoomMng},this.getNotificationMng=function(){return new NotificationMng},this.mUI=new MessengerUIMng}function MessengerUIMng(){this.mWnd=window}function FDSizeAndPosition(){this.el=null,this.initLeft=0,this.initTop=0,this.initWidth=0,this.initHeight=0,this.X=0,this.Y=0,this.gapEM=3,this.gapPX=0,this.nX=0,this.nY=0,this.resizingMethod=null,this.abuttingEl=null}function adjustElementPosition(e){e.offsetHeight+e.offsetTop>window.innerHeight&&(e.style.top=window.innerHeight-e.offsetHeight-4+"px"),e.offsetWidth+e.offsetLeft>window.innerWidth&&(e.style.left=window.innerWidth-e.offsetWidth-4+"px")}function logMessage(e,t,n){if(console.log("-- "+(e?e:"")+": "+new Date+" -------------------"),n&&console.log("-- event: "+n.toString()),t instanceof Array)for(var i=0;i<t.length;i++)console.log(t[i]);else console.log(t);console.log(" -------------------")}function confirmDlg(e,t,n,i,s,o){var r=[];return r.push(new Option("Ok",function(e){t&&t(e),removeFD(e)},"_img/common/checked.png","",!0)),r.push(new Option("Cancel",function(e){n&&n(e),removeFD(e)},"_img/common/cancel.png")),optionDlg(e,r,s,o,i)}function confirmIncomingRing(e,t,n,i,s,o){var r=[];return r.push(new Option("Accept",function(e){t&&t(e),removeFD(e)},"_img/common/checked.png","",!0)),r.push(new Option("Decline",function(e){n&&n(e),removeFD(e)},"_img/common/cancel.png")),optionDlg(e,r,s,o,i)}function trace(e){if("\n"===e[e.length-1]&&(e=e.substring(0,e.length-1)),window.performance){var t=(window.performance.now()/1e3).toFixed(3);console.log(t+": "+e)}else console.log(e)}function maybeFixConfiguration(e){if(e)for(var t=0;t<e.iceServers.length;t++)e.iceServers[t].hasOwnProperty("urls")&&(e.iceServers[t].url=e.iceServers[t].urls,delete e.iceServers[t].urls)}function requestUserMedia(e){return new Promise(function(t,n){var i=function(e){t(e)},s=function(e){n(e)};try{getUserMedia(e,i,s)}catch(o){n(o)}})}function bind2this(e){for(var t in e)"function"==typeof e[t]&&(e[t]=e[t].bind(e))}function genRandomString(e){for(var t="",n=0;e>n;n++){var i=Math.floor(Math.random()*genRandomString.charSet.length);t+=genRandomString.charSet.substring(i,i+1)}return t}function genRandomID(e){for(var t=(new Date).getTime()%604800+"",n=0;e>n;n++){var i=Math.floor(Math.random()*genRandomString.charSet.length);t+=genRandomString.charSet.substring(i,i+1)}return parseInt(t)}function EventCallback(){this.onEvSuccess=function(e,t,n){alertMng.alert("Success: "+e)},this.onEvError=function(e,t,n){alertMng.alert("Error: "+e)}}function objToString(e,t){var n="";for(var i in e)"function"!=typeof e[i]&&(t!==!0||e.hasOwnProperty(i))&&(n+=", "+i+": "+e[i]);return n.length>0?n.substr(1):""}function openWin(e,t,n,i){n||(n=.75*screen.height),i||(i=n*aCtx().getVideoRoomMng().getAspectRatio());var s=(screen.width-i)/2;0>s&&(s=0);var o=(screen.height-n)/2-getRootElementFontSize();return 0>o&&(o=0),window.open(e,t,"titlebar=no,close=no,menubar=no,location=no,resizable=no,scrollbars=yes,status=no,width="+i+",height="+n+",top="+o+",left="+s)}function getRootElementFontSize(){return parseFloat(getComputedStyle(document.documentElement).fontSize)}function getChildsWidthAmount(e){for(var t=0,n=e.childNodes.length-1;n>0;n--)t+=e.childNodes.item(n).clientWidth;return t}function NotificationMng(){}function PluginHandler(e,t,n){this.plugin=t,this.handlerId=n,this.janusSignalSession=e,bind2this(this)}function JSIG(){}function VideoRoom(e){this.room=e,this.description=null,this.max_publishers=null,this.bitrate=null,this.fir_freq=null,this.record=null,this.num_participants=null,this.publisherPluginHandler=null,this.remoteFeedsPluginHandlers={},this.vrLifeCycleListeners=[],this.videoRoomUI=new VideoRoomUI}function VideoRoomUI(){this.wnd=null,this.roomPanel=null,this.localVideoPanel=null}function setSourceToMainVideo(e){reattachMediaStream(document.querySelector(".mainvideo"),e)}function onWndResized(e){resizedTimer&&clearTimeout(resizedTimer),resizedTimer=setTimeout(function(){e.target.removeEventListener("resize",onWndResized),e.srcElement.removeEventListener("resize",onWndResized);var t=e.target.outerHeight-e.target.innerHeight,n=e.target.outerWidth-e.target.innerWidth,i=(e.target.innerHeight+e.target.innerWidth)/2;e.target.resizeTo(i*VideoRoomMng.getAspectRatio()+n,i+t);var s=e.target.document.querySelector(".local_video_panel"),o=getFDRootNode(s);o.offsetLeft>o.parentNode.clientWidth-2*getRootElementFontSize()&&(o.style.left=o.parentNode.clientWidth-2*getRootElementFontSize()+"px",o.style.right=o.parentNode.clientWidth-(o.parentNode.clientWidth-2*getRootElementFontSize())-o.offsetWidth+"px"),o.offsetTop>o.parentNode.clientHeight-2*getRootElementFontSize()&&(o.style.top=o.parentNode.clientHeight-2*getRootElementFontSize()+"px",o.style.bottom=o.parentNode.clientHeight-(o.parentNode.clientHeight-2*getRootElementFontSize())-o.offsetHeight+"px"),setTimeout(function(){e.target.addEventListener("resize",onWndResized)},700)},500)}function vrLifeCycleListenerStd(e,t){switch(t){case"listener added":break;case"created":break;case"joined":}}function PluginHandlerVideoRoom(e,t,n){PluginHandler.call(this,e,PluginHandlerVideoRoom.PLUGIN_NAME_VIDEOROOM,n),this.vRoom=t,this.feed=null,this.webRTCSession=new WRTCSession(this)}function PluginHandlerVideoRoomFeed(e,t,n){PluginHandlerVideoRoom.call(this,e,t,n),this.feed=null,this.rfdisplay=null}function JanusSignalSession(e){this.sessionId=null,this.connected=!1,this.transport=e,this.transactionHandlers={},this.pluginHandlers={},this.signallingEventsListeners=null,this.keepaliveTimeoutId=null}function SignallingEventsListeners(){this.onSEvError=function(e,t){alertMng.alert("Session error: sessionid="+e.sessionId+", Message: "+t)},this.onSEvSuccess=function(e){},this.onSEvMessage=function(e,t){},this.onSEvClose=function(e){}}function LPTransport(){this.connected=null,this.sessionId=null}function TransportEventsHandler(){this.onTEvError=function(e,t){alertMng.alert(e)},this.onTEvInit=function(e,t){alertMng.alert("Transport initialized"+(e?": "+e:"."))},this.onTEvMessage=function(e,t){alertMng.alert("got: "+e)},this.onTEvClose=function(e,t){alertMng.alert("Transport closed"+(e?": "+e:"."))}}function Transport(){}function WRTCSession(e){this.webrtcStuff={started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,sdpSent:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},this.appAgentWebRTC=e}function AppAgentWebRTC(){this.publisherPluginHandler=null,this.aawConsentDialog=function(){throw new Error("abstract function is being invoked")},this.aawOnLocalStream=function(){throw new Error("abstract function is being invoked")},this.aawOnRemoteStream=function(){throw new Error("abstract function is being invoked")},this.aawOnData=function(){throw new Error("abstract function is being invoked")},this.aawOnDataopen=function(){throw new Error("abstract function is being invoked")}}function WSTransport(e){this.serverURL=e,this.ws=null,this.transportEventsHandler=null}!function(e){"use strict";e.realineMessenger=e.angular.module("realineMessenger",["realine","ui.bootstrap.modal","ui.select","angularFileUpload","ngFileUpload"]).run([function(){}]).config(["$routeProvider",function(e){e.when("/",{title:"Realine Messenger",header:"Realine Messenger",keywords:"Realine",description:"Realine Messenger",pageDisplayName:"Messenger",templateUrl:"/Application/Modules/Messenger/Html/MessengerPage.html",general:!0})}]).run(["pageNavigationService","appConfig",function(e,t){e.addPageLinks({Login:new PageLink(t.login,!0,!0),Messenger:new PageLink("/",!0)})}]),e.app.extendAppModules(["realineMessenger"])}(window),function(e){"use strict";e.realineMessenger.constant("MessengerConstants",{StreamObjectType:"946d5193-1360-4937-ae48-a42000f54808"}),e.realineMessenger.constant("fileExtensions",{image:[".jpg",".jpeg",".png",".gif",".bmp",".tiff"],document:[".doc",".docx",".rtf"],excel:[".xls, .xlsx"],presentation:[".ppt","pptx"],text:[".txt",".me"],pdf:[".pdf"]})}(window),function(e){"use strict";e.realineMessenger.constant("MessengerEnums",{UserStatuses:{Unknown:"Unknown",Online:"Online",Offline:"Offline",Away:"Away",Busy:"Busy"},MessageType:{TextMessage:"TextMessage",AddParticipants:"AddParticipants",LeaveConversation:"LeaveConversation",RenameConversation:"RenameConversation",Attachment:"Attachment",Redirect:"Redirect",UserRedirect:"UserRedirect",MessageDeleted:"MessageDeleted",ParticipantRemoved:"ParticipantRemoved",GroupConversationCreated:"GroupConversationCreated",ParticipantJoined:"ParticipantJoined"},MessageState:{Success:"Success",Sending:"Sending",Error:"Error"},FileUploadState:{Pending:"Pending",Success:"Success",Failed:"Failed",Cancelled:"Cancelled"},PropertyNames:{Id:"Id",Name:"Name",FirstName:"FirstName",LastName:"LastName",About:"About",AvatarThumb:"AvatarThumb",AvatarSourceUrl:"AvatarSourceUrl",IsRead:"IsRead",Text:"Text",AuthorId:"AuthorId",ConversationId:"ConversationId",CreateDate:"CreateDate",MessageType:"MessageType",Content:"Content",AutoReplied:"AutoReplied",RedirectedTo:"RedirectedTo",ReadBy:"ReadBy",IsDeleted:"IsDeleted",State:"State",LocalMasterId:"LocalMasterId",AuthorVisible:"AuthorVisible",Status:"Status",FullName:"FullName",GroupId:"GroupId",BackgroundUrl:"BackgroundUrl",ContextGlobalMasterId:"ContextGlobalMasterId",ContextName:"ContextName",MessengerProfileType:"MessengerProfileType",IsLoggedIn:"IsLoggedIn",DisplayName:"DisplayName",Title:"Title",Subtitle:"Subtitle",UnreadMessagesCount:"UnreadMessagesCount",LastMessageDate:"LastMessageDate",LastMessageText:"LastMessageText",BusinessObjecType:"BusinessObjecType",BusinessObjecId:"BusinessObjecId",BusinessTransactionId:"BusinessTransactionId",RequestId:"RequestId",IsJoinedConversation:"IsJoinedConversation",IsMuted:"IsMuted",Type:"Type",StreamId:"StreamId",CompanyId:"CompanyId",IsSelected:"IsSelected",TagType:"FolderType",UnreadConversationsCount:"UnreadConversationsCount",FileName:"FileName",FileType:"FileType",FileData:"FileData"},FileType:{Document:0,Image:1},ConversationType:{Private:"Private",Group:"Group",Public:"Public"},MessengerProfileType:{User:0,Company:1},MessengerPanelOpenAction:{None:"none",Minimize:"minimize",Maximize:"maximize"},OrderDirection:{Asc:0,Desc:1},TagType:{Draft:0,Inbox:1,Archive:2,CustomFolder:4,Starred:5},CacheAction:{Add:"Add",Remove:"Remove"}})}(window),function(e){"use strict";e.realineMessenger.filter("chatMessageDate",["$filter",function(e){return function(t){if(!angular.isDate(t))return"";var n=new Date,i=e("date")(t,"shortTime");return t.getFullYear()===n.getFullYear()&&t.getMonth()===n.getMonth()&&t.getDate()===n.getDate()?i:t.getFullYear()===n.getFullYear()?e("date")(t,"d MMM")+" "+i:e("date")(t,"d MMM, yyyy")+" "+i}}])}(window),function(e){"use strict";e.realineMessenger.factory("AttachmentModel",["MessengerEnums","EntityModel","utils","Domains",function(e,t,n,i){function s(){var e,t;try{e=JSON.parse(this.getFileData())}catch(i){e=null}this.setFileData(e),n.common.isNullOrUndefined(e)||(this.isImageFile()?(this.setOriginalFileUrl(e.Url),this.thumbnailImage=e.ResizedImages.findItem(function(e){return"small"===e.Size}),null!==this.thumbnailImage&&this.setThumbnailUrl(this.thumbnailImage.Url)):(t=String.format(o,e.FileId),this.setOriginalFileUrl(t)))}var o=i.MessengerDocumentStorage+"/api/document/getByGlobalUnitId?globalUnitId={0}",r=t.extend({init:function(e){this._super(e),this.__ClassName="AttachmentModel",s.call(this)},getFileName:function(){return this.get(e.PropertyNames.FileName)},setFileName:function(t){this.set(e.PropertyNames.FileName,t)},getFileType:function(){return this.get(e.PropertyNames.FileType)},setFileType:function(t){this.set(e.PropertyNames.FileType,t)},getFileData:function(){return this.get(e.PropertyNames.FileData)},setFileData:function(t){this.set(e.PropertyNames.FileData,t)},isImageFile:function(){return this.getFileType()===e.FileType.Image},getOriginalFileUrl:function(){return this.get("OriginalFileUrl")},setOriginalFileUrl:function(e){this.set("OriginalFileUrl",e)},getThumbnailUrl:function(){return this.get("ThumbnailUrl")},setThumbnailUrl:function(e){this.set("ThumbnailUrl",e)},getThumbnailImage:function(){return this.thumbnailImage}});return r}])}(window),function(e){"use strict";e.realineMessenger.factory("ConversationModel",["MessageModel","MessengerEnums","MessengerConstants","businessObjectService","EntityModel","UniqueEntityCollection","CoreEnums","profileCacheService","utils","conversationTagService",function(e,t,n,i,s,o,r,a,d,c){function l(e){var t=this.getUnreadMessagesCount()+e;u.call(this,t)}function u(e){this.set(t.PropertyNames.UnreadMessagesCount,e)}function h(){var e;if(this.data.DisplayName)return void this.setTitle(this.data.DisplayName);var t=this.Participants.filter(function(e){return!this.currentUser.Profiles.containsById(e.getId())},this);return 1===t.length?(e=t[0].getTitle(),void this.setTitle(e)):0===t.length?void this.setTitle("Empty group"):void this.setTitle(String.format("{0} + {1}",t[0].data.Name,t.length-1))}function g(){var e=null;return p.isNullOrUndefined(this.data.BusinessObjecId)||p.isNullOrUndefined(this.data.BusinessObjecType)||p.isNullOrUndefined(this.data.BusinessTransactionId)||this.isStream()?void this.setSubtitle(""):(e=i.getName(this.data.BusinessObjecType),d.common.isNullOrEmpty(e)&&(e="Unknown"),void this.setSubtitle(String.format("{0} - {1}",this.getBusinessTransactionId(),e)))}var f,p=d.common;return f=s.extend({init:function(e,t){this._super(e),this.__ClassName="ConversationModel",delete this.data.ParticipantProfileIds,delete this.data.Messages,this.currentUser=t,u.call(this,0),this.setLastMessageDate(new Date(0)),this.initParticipants(e.ParticipantProfileIds),this.validateLeftConversation(),this.initMessages(e.Messages),this.initTags(e.FolderIds),this.bindPropertyChanged(this.Property_Changed,this),g.call(this)},initParticipants:function(e){e||(e=[]);var t=e.map(function(e){return angular.isObject(e)?e:a.get(e)});t=t.filterDuplicates(function(e){return e.getId()}),this.Participants=new o,this.Participants.bindCollectionChanged(this.Participants_Changed,this),this.Participants.push(t),0===t.length&&h.call(this)},initMessages:function(t){t||(t=[]);var n=t.map(function(t){return new e(t)});this.Messages=new o,this.Messages.bindCollectionChanged(this.Messages_Changed,this),this.Messages.push(n)},initTags:function(e){var t,n;for(e||(e=[]),this.Tags=new o,this.Tags.Conversation=this,t=0;t<e.length;t++)n=c.getTags().findById(e[t]),null!==n?this.Tags.push(n):$log.debug(String.format("Tag with id {0} not found.",e[t]))},getDisplayName:function(){return this.get(t.PropertyNames.DisplayName)},setDisplayName:function(e){this.set(t.PropertyNames.DisplayName,e)},getTitle:function(){return this.get(t.PropertyNames.Title)},setTitle:function(e){this.set(t.PropertyNames.Title,e)},getSubtitle:function(){return this.get(t.PropertyNames.Subtitle)},setSubtitle:function(e){this.set(t.PropertyNames.Subtitle,e)},hasSubtitle:function(){return!d.common.isNullOrEmpty(this.getSubtitle())},getUnreadMessagesCount:function(){return this.get(t.PropertyNames.UnreadMessagesCount)},hasUnreadMessages:function(){return this.getUnreadMessagesCount()>0},getLastMessageDate:function(){return this.get(t.PropertyNames.LastMessageDate)},setLastMessageDate:function(e){this.set(t.PropertyNames.LastMessageDate,e)},getLastMessageText:function(){return this.get(t.PropertyNames.LastMessageText)},setLastMessageText:function(e){this.set(t.PropertyNames.LastMessageText,e)},getRequestId:function(){return this.get(t.PropertyNames.RequestId)},setRequestId:function(e){this.set(t.PropertyNames.RequestId,e)},isPrivate:function(){return this.getType()===t.ConversationType.Private},isGroup:function(){return this.getType()===t.ConversationType.Group},isPublic:function(){return this.getType()===t.ConversationType.Public},isBusinessObjectConversation:function(){return d.common.isNullOrUndefined(this.getBusinessObjecType())?!1:!this.isStream()},isStream:function(){return this.getBusinessObjecType()===n.StreamObjectType?!0:!1},getStreamId:function(){return this.getBusinessObjecId()},setStreamId:function(e){this.setBusinessObjecId(e)},getType:function(){return this.get(t.PropertyNames.Type)},setType:function(e){this.set(t.PropertyNames.Type,e)},getContact:function(){return this.isPrivate()?this.Participants.find(function(e){return!this.currentUser.Profiles.containsById(e.getId())},this):null},getAvatarThumbUrl:function(){return this.isPrivate()&&this.Participants.length()>1?this.getContact().getAvatarThumbUrl():null},isJoinedConversation:function(){return this.getIsJoinedConversation()},getIsJoinedConversation:function(){return this.get(t.PropertyNames.IsJoinedConversation)},setIsJoinedConversation:function(e){this.set(t.PropertyNames.IsJoinedConversation,e)},getBusinessObjecType:function(){return this.get(t.PropertyNames.BusinessObjecType)},getBusinessObjecId:function(){return this.get(t.PropertyNames.BusinessObjecId)},getBusinessTransactionId:function(){return this.get(t.PropertyNames.BusinessTransactionId)},getIsMuted:function(){return this.get(t.PropertyNames.IsMuted)},setIsMuted:function(e){this.set(t.PropertyNames.IsMuted,e)},Property_Changed:function(e){switch(e.property){case t.PropertyNames.DisplayName:h.call(this);break;case t.PropertyNames.BusinessObjecType:case t.PropertyNames.BusinessTransactionId:g.call(this)}},getParticipants:function(e){if(!e)return this.Participants.cloneArray();var t=this.Participants.filter(function(e){return!this.currentUser.Profiles.containsById(e.getId())},this);return t},Participants_Changed:function(e){switch(h.call(this),e.action){case r.CollectionAction.Add:this.onParticipantAdded(e);break;case r.CollectionAction.Remove:this.onParticipantRemoved(e);break;case r.CollectionAction.Replace:break;case r.CollectionAction.Reset:}},onParticipantAdded:function(e){this.validateLeftConversation(),this.bindParticipants(e.newItems)},onParticipantRemoved:function(e){this.unbindParticipants(e.oldItems),this.validateLeftConversation()},Participant_PropertyChanged:function(e){(e.property===t.PropertyNames.Name||e.property===t.PropertyNames.ContextName)&&h.call(this)},validateLeftConversation:function(){var e=this.Participants.containsAny(this.currentUser.Profiles.list);this.setIsJoinedConversation(e)},bindParticipants:function(e){var t;for(t=0;t<e.length;t++)e[t].bindPropertyChanged(this.Participant_PropertyChanged,this)},unbindParticipants:function(e){var t;for(t=0;t<e.length;t++)e[t].unbindPropertyChanged(this.Participant_PropertyChanged,this)},Messages_Changed:function(e){switch(e.action){case r.CollectionAction.Add:this.onMessagesAdded(e);break;case r.CollectionAction.Remove:this.onMessagesRemoved(e);break;case r.CollectionAction.Replace:break;case r.CollectionAction.Reset:}},onMessagesAdded:function(e){var t,n,i=0;for(t=0;t<e.newItems.length;t++)n=e.newItems[t],n.getIsRead()||i++,n.bindPropertyChanged(this.Message_PropertyChanged,this);(p.isNullOrUndefined(this.getLastMessageDate())||this.getLastMessageDate()<n.getCreateDate())&&(this.setLastMessageDate(n.getCreateDate()),this.setLastMessageText(n.getPlainText())),i>0&&l.call(this,i)},onMessagesRemoved:function(e){var t,n,i=0;for(t=0;t<e.oldItems.length;t++)n=e.oldItems[t],n.getIsRead()||i++,n.unbindPropertyChanged(this.Message_PropertyChanged,this);i>0&&l.call(this,-i),e.oldStartingIndex>this.Messages.length()&&(n=this.Messages.last(),n?(this.setLastMessageDate(n.getCreateDate()),this.setLastMessageText(n.getPlainText())):(this.setLastMessageDate(null),this.setLastMessageText(null)))},Message_PropertyChanged:function(e){switch(e.property){case t.PropertyNames.IsRead:e.newValue===!0&&l.call(this,-1);break;case t.PropertyNames.IsDeleted:e.newValue===!0&&this.Messages.last()===e.target&&this.setLastMessageText(e.target.getPlainText());break;case t.PropertyNames.CreateDate:this.Messages.last()===e.target&&this.setLastMessageDate(e.newValue)}}})}])}(window),function(e){"use strict";e.realineMessenger.factory("ConversationRecord",["MessengerEnums","EntityModel","utils",function(e,t,n){var i=t.extend({init:function(e){this._super({IsSelected:!1}),this.__ClassName="ConversationRecord",this.Conversation=e},getId:function(){return this.Conversation.getId()},setId:function(e){this.Conversation.setId(e)},getIsSelected:function(){return this.get(e.PropertyNames.IsSelected)},setIsSelected:function(t){this.set(e.PropertyNames.IsSelected,t)}});return i}])}(window),function(e){"use strict";e.realineMessenger.factory("MessageModel",["MessengerEnums","events","messageBus","EntityModel","EntityCollection","AttachmentModel","profileCacheService","$sanitize","$filter","$sce","$log","$","utils",function(e,t,n,i,s,o,r,a,d,c,l,u,h){function g(){switch(this.getMessageType()){case e.MessageType.TextMessage:f.call(this);break;case e.MessageType.AddParticipants:p.call(this);break;case e.MessageType.Redirect:m.call(this);break;case e.MessageType.ParticipantRemoved:v.call(this);case e.MessageType.GroupConversationCreated:C.call(this)}h.common.isNullOrEmpty(this.getRedirectedTo())||this.setRedirectedTo(r.get(this.getRedirectedTo()))}function f(){var e,t,n=[],i=this.getContent();if(h.common.isNullOrEmpty(i)||h.common.isNullOrEmpty(i.AttachedFiles))return void(this.AttachedFiles=[]);for(e=0;e<i.AttachedFiles.length;e++)t=new o(i.AttachedFiles[e]),n.push(t);this.AttachedFiles=n}function p(){var e=this.data.Content.ParticipantsProfileIds;e=e.filterDuplicates(function(e){return e}),this.data.Content.Participants=e.map(function(e){return r.get(e)})}function m(){var e=this.getRedirectDestinationUserId();e&&(this.redirectDestinationUser=r.get(e)),h.common.isNullOrEmpty(this.getText())&&(this.setText("Sorry, I cannot answer right now."),y.call(this))}function v(){this.data.Content.Participants=r.get(this.data.Content.ParticipantsProfileIds)}function C(){var e=this.getChildConversationParticipants();h.common.isNullOrUndefined(this.data.Content)&&(this.data.Content={}),this.data.Content.InitialParticipants=e.map(function(e){return r.get(e)})}function y(){this.htmlText=this.getText(),this.htmlText=d("linky")(this.htmlText,"_blank")}function b(){if(this.getIsDeleted())return w.call(this);var e,t=null===this.getText()?"":this.getText();return this.AttachedFiles.length>0&&(e=this.AttachedFiles.map(function(e){return e.getFileName()}),t+=" ",t+=e.join(", ")),t}function S(){var e=this.getAddedParticipants().map(function(e){return e.getName()}).join(", ");return String.format("{0} added {1} to this conversation",this.Author.getName(),e)}function M(){return String.format("{0} left conversation",this.Author.getName())}function P(){return String.format("{0} changed topic of conversation to {1}",this.Author.getName(),this.getConversationNewName())}function I(){return this.getHtmlText()}function w(){return"Message has been removed"}function T(){return String.format("{0} removed {1} from this conversation",this.Author.getName(),this.getRemovedParticipant().getName())}function R(){var e=this.getChildConversationParticipants().map(function(e){return e.getName()}).join(", ");return String.format("{0} created a group conversation with {1}",this.Author.getName(),e)}var A=i.extend({init:function(t){this._super(t),this.__ClassName="MessageModel",h.common.isNullOrUndefined(this.getState())&&this.setState(e.MessageState.Success),y.call(this),this.Author=r.get(this.getAuthorId()),g.call(this),this.initReaders()},getText:function(){return this.get(e.PropertyNames.Text)},setText:function(t){return this.set(e.PropertyNames.Text,t)},getHtmlText:function(){return this.htmlText},getIsRead:function(){return this.get(e.PropertyNames.IsRead)},setIsRead:function(t){this.set(e.PropertyNames.IsRead,t)},getConversationId:function(){return this.get(e.PropertyNames.ConversationId)},getLocalMasterId:function(){return this.get(e.PropertyNames.LocalMasterId)},getAuthorId:function(){return this.get(e.PropertyNames.AuthorId)},getMessageType:function(){return this.get(e.PropertyNames.MessageType)},setMessageType:function(t){return this.set(e.PropertyNames.MessageType,t)},getState:function(){return this.get(e.PropertyNames.State)},setState:function(t){return this.set(e.PropertyNames.State,t)},getRequestId:function(){return this.get(e.PropertyNames.RequestId)},getIsDeleted:function(){return this.get(e.PropertyNames.IsDeleted)},setIsDeleted:function(t){return this.set(e.PropertyNames.IsDeleted,t)},getContent:function(){return this.get(e.PropertyNames.Content)},getConversationNewName:function(){return this.data.Content.Name},hasRedirectDestinationUser:function(){return h.common.isNullOrUndefined(this.data.Content)},getRedirectDestinationUserId:function(){return this.data.Content},getRedirectDestinationUser:function(){return this.redirectDestinationUser},setCreateDate:function(t){return this.set(e.PropertyNames.CreateDate,t)},getCreateDate:function(){return this.get(e.PropertyNames.CreateDate)},getAddedParticipants:function(){return this.data.Content.Participants},getRemovedParticipant:function(){return this.data.Content.Participants},getChildConversationParticipants:function(){return h.common.isNullOrUndefined(this.data.Content)||h.common.isNullOrUndefined(this.data.Content.InitialParticipants)?[]:this.data.Content.InitialParticipants},getParentConversationId:function(){return this.data.Content.ConversationId},getAutoReplied:function(){return this.get(e.PropertyNames.AutoReplied)},hasRedirectedTo:function(){return!h.common.isNullOrEmpty(this.getRedirectedTo())},getRedirectedTo:function(){return this.get(e.PropertyNames.RedirectedTo)},setRedirectedTo:function(t){this.set(e.PropertyNames.RedirectedTo,t)},getReadBy:function(){return this.get(e.PropertyNames.ReadBy)},setReadBy:function(t){return this.set(e.PropertyNames.ReadBy,t)},markReadByUser:function(e){this.Readers.containsById(e)||(this.getReadBy().push(e),this.Readers.push(r.get(e)))},getPlainText:function(){switch(this.getMessageType()){case e.MessageType.TextMessage:return b.call(this);case e.MessageType.AddParticipants:return S.call(this);case e.MessageType.LeaveConversation:return M.call(this);case e.MessageType.RenameConversation:return P.call(this);case e.MessageType.Redirect:return I.call(this);case e.MessageType.ParticipantRemoved:return T.call(this);case e.MessageType.GroupConversationCreated:return R.call(this);default:l.debug("getPlainText: unknown message type - "+this.getMessageType())}},isNotificationMessage:function(){return this.getMessageType()===e.MessageType.TextMessag?!1:!0},initReaders:function(){var e,t=this.getReadBy();t||(t=[],this.setReadBy([])),e=t.map(function(e){return r.get(e)}),this.Readers=new s,this.Readers.push(e)}});return A}])}(window),function(e){"use strict";e.realineMessenger.factory("MessageRecord",["EntityModel","MessengerEnums",function(e,t){var n=e.extend({init:function(e){this._super({AuthorVisible:!0}),this.__ClassName="MessageRecord",this.Message=e},getId:function(){return this.Message.getId()},setId:function(e){this.Message.setId(e)},getAuthorVisible:function(){return this.get(t.PropertyNames.AuthorVisible)},setAuthorVisible:function(e){this.set(t.PropertyNames.AuthorVisible,e)},getIsSelected:function(){return this.get(t.PropertyNames.IsSelected)},setIsSelected:function(e){this.set(t.PropertyNames.IsSelected,e)}});return n}])}(window),function(e){"use strict";e.realineMessenger.factory("ProfileModel",["MessengerEnums","EntityModel","utils","$log",function(e,t,n,i){function s(e){n.common.isNullOrEmpty(e.Name)?n.common.isNullOrEmpty(e.FullName)?n.common.isNullOrEmpty(e.FirstName)||n.common.isNullOrEmpty(e.LastName)||this.setName(e.FirstName+" "+e.LastName):this.setName(e.FullName):this.setName(e.Name)}var o="data loaded",r=t.extend({init:function(e,t){var i=angular.extend({},e);this._super(i),this.__ClassName="ProfileModel",s.call(this,e),n.common.isUndefined(t)?this.isLoaded=!0:this.isLoaded===!0&&(this.isLoaded=!0)},getGlobalMasterId:function(){return i.error("ProfileModel->getGlobalMasterId"),this.get(e.PropertyNames.GlobalMasterId)},setGlobalMasterId:function(t){i.error("ProfileModel->setGlobalMasterId"),this.set(e.PropertyNames.GlobalMasterId,t)},getGroupId:function(){return this.get(e.PropertyNames.GroupId)},setGroupId:function(t){this.set(e.PropertyNames.GroupId,t)},getName:function(){return this.get(e.PropertyNames.Name)},setName:function(t){this.set(e.PropertyNames.Name,t)},getTitle:function(){return this.getMessengerProfileType()===e.MessengerProfileType.Company?String.format("{0} ({1})",this.getName(),this.getContextName()):this.getName()},getMessengerProfileType:function(){return this.get(e.PropertyNames.MessengerProfileType)},setMessengerProfileType:function(t){this.set(e.PropertyNames.MessengerProfileType,t)},getIsLoggedIn:function(){return this.get(e.PropertyNames.IsLoggedIn)},setIsLoggedIn:function(t){this.set(e.PropertyNames.IsLoggedIn,t)},getAvatarThumbUrl:function(){return this.get(e.PropertyNames.AvatarThumb)},setAvatarThumbUrl:function(t){this.set(e.PropertyNames.AvatarThumb,t)},getAvatarSourceUrl:function(){return this.get(e.PropertyNames.AvatarSourceUrl)},setAvatarSourceUrl:function(t){this.set(e.PropertyNames.AvatarSourceUrl,t)},getContextGlobalMasterId:function(){return this.get(e.PropertyNames.ContextGlobalMasterId)},setContextGlobalMasterId:function(t){this.set(e.PropertyNames.ContextGlobalMasterId,t)},getContextName:function(){return this.get(e.PropertyNames.ContextName)},setContextName:function(t){this.set(e.PropertyNames.ContextName,t)},getContextNameText:function(){return n.common.isNullOrUndefined(this.getContextName)?"":this.getContextName()},setData:function(e){this.setGroupId(e.GroupId),s.call(this,e),this.setMessengerProfileType(e.MessengerProfileType),this.setContextGlobalMasterId(e.ContextGlobalMasterId),this.setContextName(e.ContextName),this.setAvatarThumbUrl(e.AvatarThumb),this.setAvatarSourceUrl(e.AvatarSourceUrl),this.isLoaded=!0,this.fireLoaded()},setUserData:function(e){this.setName(e.FirstName+" "+e.LastName),this.setAvatarThumbUrl(e.AvatarThumb),this.setAvatarSourceUrl(e.AvatarSourceUrl)},bindLoaded:function(e,t){this.eventManager.bind(o,e,t)},unbindLoaded:function(e,t){this.eventManager.detach(o,e,t)},fireLoaded:function(){var e={type:o,sender:this};this.eventManager.fire(e)}});return r}])}(window),function(e){"use strict";e.realineMessenger.factory("TagModel",["MessengerEnums","EntityModel","utils","$log",function(e,t,n,i){var s=t.extend({init:function(e){this._super(e),this.__ClassName="TagModel"},getDisplayName:function(){return this.get(e.PropertyNames.DisplayName)},setDisplayName:function(t){this.set(e.PropertyNames.DisplayName,t)},getTagType:function(){return this.get(e.PropertyNames.TagType)},setTagType:function(t){this.set(e.PropertyNames.TagType,t)},getUnreadConversationsCount:function(){return this.get(e.PropertyNames.UnreadConversationsCount)},setUnreadConversationsCount:function(t){this.set(e.PropertyNames.UnreadConversationsCount,t)},incUnreadConversationsCount:function(){this.setUnreadConversationsCount(this.getUnreadConversationsCount()+1)},decUnreadConversationsCount:function(){return 0===this.getUnreadConversationsCount()?void i.debug(String.format('Invalid decrease operation for tag "{0}"',this.getDisplayName())):void this.setUnreadConversationsCount(this.getUnreadConversationsCount()-1)}});return s}])}(window),function(e){"use strict";e.realineMessenger.factory("UserModel",["MessengerEnums","EntityModel","UniqueEntityCollection","ProfileModel","utils",function(e,t,n,i,s){function o(e){c.isNullOrEmpty(e.Name)?c.isNullOrEmpty(e.FullName)?this.setName(e.FirstName+" "+e.LastName):this.setName(e.FullName):this.setName(e.Name)}function r(e){var t,n,o=[];if(!s.common.isNullOrUndefined(e)){for(t=0;t<e.length;t++)n=new i(e[t]),o.push(n);
this.Profiles.push(o)}}var a,d="data loaded",c=s.common;return a=t.extend({init:function(t,i){var a=angular.extend({},t);a.Id=a.GroupId,delete a.GroupId,this._super(a),this.__ClassName="UserModel",o.call(this,t),s.common.isNullOrUndefined(this.getStatus())&&this.setStatus(e.UserStatuses.Unknown),delete this.data.Profiles,this.Profiles=new n,r.call(this,t.Profiles),c.isUndefined(i)?this.isLoaded=!0:this.isLoaded===!0&&(this.isLoaded=!0)},getName:function(){return this.get(e.PropertyNames.Name)},setName:function(t){this.set(e.PropertyNames.Name,t)},getFullName:function(){return this.get(e.PropertyNames.FullName)},setFullName:function(t){this.set(e.PropertyNames.FullName,t)},getFirstName:function(){return this.get(e.PropertyNames.FirstName)},setFirstName:function(t){this.set(e.PropertyNames.FirstName,t)},getLastName:function(){return this.get(e.PropertyNames.LastName)},setLastName:function(t){this.set(e.PropertyNames.LastName,t)},getAvatarThumbUrl:function(){return this.get(e.PropertyNames.AvatarThumb)},setAvatarThumbUrl:function(t){this.set(e.PropertyNames.AvatarThumb,t)},getStatus:function(){return this.get(e.PropertyNames.Status)},setStatus:function(t){this.set(e.PropertyNames.Status,t)},isUnknown:function(){return this.getStatus()===e.UserStatuses.Unknown},isOnline:function(){return this.getStatus()===e.UserStatuses.Online},isOffline:function(){return this.getStatus()===e.UserStatuses.Offline},isAway:function(){return this.getStatus()===e.UserStatuses.Away},isBusy:function(){return this.getStatus()===e.UserStatuses.Busy},getStausName:function(){return this.getStatus().toLowerCase()},setData:function(e){o.call(this,e),this.setAvatarThumbUrl(e.AvatarThumb),r.call(this,e.Profiles),this.isLoaded||(this.isLoaded=!0,this.fireLoaded())},bindLoaded:function(e,t){this.eventManager.bind(d,e,t)},unbindLoaded:function(e,t){this.eventManager.detach(d,e,t)},fireLoaded:function(){var e={type:d,sender:this};this.eventManager.fire(e)}})}])}(window),function(e){"use strict";e.realineMessenger.factory("BusyIndicator",["$log",function(e){var t=Class.extend({init:function(){this.__ClassName="BusyIndicator",this.requestCount=0},begin:function(){this.requestCount++},end:function(){return this.requestCount<1?void e.debug("BusyIndicator: tried to decrease counter: "+this.requestCount):void this.requestCount--},isBusy:function(){return this.requestCount>0},reset:function(){this.requestCount=0}});return t}])}(window),function(e){"use strict";e.realineMessenger.factory("contactsCacheService",["$q","$log","profileCacheService","EntityModelCacheService","UserModel","messengerUserService","utils",function(e,t,n,i,s,o,r){var a=i.extend({init:function(){this._super(s),this.defers={}},get:function(n){var i=this.dict[n];return i?i:(i=new s({GlobaIndexId:n},!1),this.dict[n]=i,this.defers[n]=e.defer(),function(e,n){var i={ProfileGroupIds:[e.getId()]};o.searchUsers(i).then(function(i){if(!i.data.Status)return t.debug("Failed to get users by ids. "+i.Message),void n.defers[e.getId()].reject(!1);if(r.common.isNullOrUndefined(i.data.Model.List)||0===i.data.Model.List.length)return t.debug(String.format("Not found user by id {0}",e.getId())),void n.defers[e.getId()].reject("Not found");var s=i.data.Model.List[0];e.setData(s),n.processAddedEntity(e)},function(i){t.debug("Failed to get user by id."+i),n.defers[e.getId()].reject(i)})}(i,this),i)},getp:function(e){return this.get(e),this.defers[e].promise},clear:function(){this._super(),this.defers={}},processAddedEntity:function(t){var i;t.Profiles.forEach(function(e){n.put(e)}),i=this.defers[t.getId()],r.common.isUndefined(i)&&(i=e.defer(),this.defers[t.getId()]=i),i.resolve(t)}});return new a}])}(window),function(e){"use strict";e.realineMessenger.factory("conversationProviderService",["messengerHub","PendingConversationsManager","UniqueEntityCollection","EntityDictionary","ConversationModel","utils","EventManager","MessengerEnums","CoreEnums","$q","$log",function(e,t,n,i,s,o,r,a,d,c,l){function u(e){var t,n,i=[];for(t=0;t<e.length;t++)n=h.call(this,e[t]),i.push(n);return i}function h(e){var t;return this.cache.containsId(e.Id)?this.cache.get(e.Id):(t=new s(e,this.user),this.cache.add(t),t)}function g(e){var t,n=[];for(t=0;t<e.length;t++)n.push(f.call(this,e[t]));return n}function f(e){var t;return this.cache.containsId(e.Id)?this.cache.get(e.Id):(t=new s(e,this.user),this.user.Profiles.containsAnyId(e.Participants)&&this.cache.add(t),t)}function p(e){var t,n=[];for(t=0;t<e.length;t++)n.push(f.call(this,e[t]));return n}var m="conversation cache changed",v=Class.extend({init:function(){this.__ClassName="ConversationProviderService",this.user=null,this.cache=new i,this.eventManager=new r,this.cache.bindDictionaryChanged(this.onCacheChanged,this)},setUser:function(e){o.common.isNullOrUndefined(this.user)||this.user===e||this.clear(),this.user=e},put:function(e){this.cache.contains(e)||this.cache.add(e)},get:function(e){return this.cache.get(e)},clear:function(){this.cache.clear()},loadConversations:function(t){return e.getConversations(t).then(function(e){var t=u.call(this,e.Conversations);return t}.bind(this))},loadConversation:function(t){var n;return this.cache.containsId(t.ConversationId)?(n=c.defer(),n.resolve(this.cache.get(t.ConversationId)),n.promise):e.getConversation(t).then(function(e){return o.common.isNullOrUndefined(e)?null:h.call(this,e)}.bind(this))},loadPrivateConversation:function(t){var n,i;return i=this.findPrivateConversationLocaly(t.OtherUserId),o.common.isNullOrUndefined(i)?e.findPrivateConversation(t).then(function(e){return o.common.isNullOrUndefined(e)?null:h.call(this,e)}.bind(this)):(n=c.defer(),n.resolve(i),n.promise)},findPrivateConversationLocaly:function(e){var t,n,i=this.cache.list();for(t=0;t<i.length;t++)if(n=i[t],n.isPrivate()&&1!==n.Participants.length()&&(n.Participants.get(0).getId()===e||n.Participants.get(1).getId()===e))return n;return null},loadObjectConversations:function(t){return e.getObjectConversations(t).then(function(e){return g.call(this,e.Conversations)}.bind(this))},loadStreamsConversations:function(t){return e.getStreamsConversations(t).then(function(e){return p.call(this,e.Conversations)}.bind(this))},onCacheChanged:function(e){switch(e.action){case d.DictionaryAction.Add:this.fireAdd(e.items);break;case d.DictionaryAction.Remove:this.fireRemove(e.items)}},bindCacheChanged:function(e,t){this.eventManager.bind(m,e,t)},unbindCacheChanged:function(e,t){this.eventManager.detach(m,e,t)},fireAdd:function(e){var t={action:a.CacheAction.Add,items:e};this.fireCollectionChanged(t)},fireRemove:function(e){var t={action:a.CacheAction.Remove,items:e};this.fireCollectionChanged(t)},fireCollectionChanged:function(e){e.type=m,e.sender=this,this.eventManager.fire(e)}});return new v}])}(window),function(e){"use strict";e.realineMessenger.factory("conversationService",["conversationProviderService","PendingConversationsManager","UniqueEntityCollection","MessengerEnums","CoreEnums","observable","utils","$q","$log",function(e,t,n,i,s,o,r,a,d){var c=Class.extend({init:function(){this.__ClassName="ConversationService",this.list=new n,this.pendingConversations=new t,this.pendingConversations.bindConversationInitialized(this.onConversationInitialized,this),this.bindEvents()},getList:function(){return this.list},getPending:function(){return this.pendingConversations},clear:function(){this.list.clear(),this.pendingConversations.clear()},bindEvents:function(){this.list.bindCollectionChanged(this.conversations_CollectionChanged,this)},onConversationInitialized:function(t){e.put(t.conversation),this.list.unshift(t.conversation)},conversations_CollectionChanged:function(e){switch(e.action){case s.CollectionAction.Add:this.onConversations_Added(e);break;case s.CollectionAction.Remove:this.onConversations_Removed(e);break;case s.CollectionAction.Replace:break;case s.CollectionAction.Reset:this.onConversations_Reset(e)}},onConversations_Added:function(e){o.bindPropertyChanged(e.newItems,this.Conversation_PropertyChanged,this)},onConversations_Removed:function(e){o.unbindPropertyChanged(e.oldItems,this.Conversation_PropertyChanged,this)},onConversations_Reset:function(e){o.unbindPropertyChanged(e.oldList,this.Conversation_PropertyChanged,this),o.bindPropertyChanged(e.newList,this.Conversation_PropertyChanged,this)},Conversation_PropertyChanged:function(e){var t;e.property===i.PropertyNames.LastMessageDate&&(t=this.list.indexOf(e.target),0!==t&&this.list.move(t,0))}});return new c}])}(window),function(e){"use strict";e.realineMessenger.factory("conversationTagService",["UniqueEntityCollection","messengerHub","TagModel","$q",function(e,t,n,i){var s=new e,o=Class.extend({init:function(){},getTags:function(){return s},findByType:function(e){return s.find(function(t){return t.getTagType()===e})},clear:function(){s.clear()},loadTags:function(){return t.getTagsList().then(function(e){var t,i,o,r=[];for(t=0;t<e.Folders.length;t++)o=s.findById(e.Folders[t].Id),i=new n(e.Folders[t]),o?(o.setDisplayName(i.getDisplayName()),o.setUnreadConversationsCount(i.getUnreadConversationsCount())):r.push(i);for(s.push(r),t=0;t<s.length();t++)o=s.get(t),e.Folders.findById(o.getId())||s.remove(o);return e}.bind(this),function(e){return $log.debug("Failed to load tags. "+e),i.reject(e)})}});return new o}])}(window),function(e){"use strict";e.realineMessenger.factory("currentStreamsService",["messageBus","events","utils",function(e,t,n){var i=Class.extend({init:function(){this.company=null,this.streams=[]},getCurrentStreams:function(){var e=[];return Array.prototype.push.apply(e,this.streams),e},hasStreams:function(){return this.streams.length>0},getCurrentCompany:function(){return this.company},streamsAreaOpened:function(i,s,o){if(n.common.isNullOrEmpty(n.common.isNullOrUndefined(s)||0===s.length))throw new Error("Number of streams must be more then zero");this.isAreaChanged(i,s)&&(this.company=i,this.streams.length=0,Array.prototype.push.apply(this.streams,s),o&&e.fire({type:t.openMessenger,state:"maximize"}),e.fire({type:t.streamsAreaOpened,data:{Company:i,Streams:this.streams}}))},streamsAreaClosed:function(i){if(n.common.isNullOrEmpty(n.common.isNullOrUndefined(i)||0===i.length))throw new Error("Number of streams must be more then zero");e.fire({type:t.streamsAreaClosed,data:{Streams:i}}),this.streams.length=0},createStreamConversation:function(n,i,s){e.fire({type:t.createStreamConversation,data:{SubscriberMasterUserId:n,Stream:i,CompanyName:s}})},isAreaChanged:function(e,t){return null===this.company||this.company.Id!==e.Id?!0:0===this.streams.length?!0:this.streams.join()!=t.join()?!0:void 0}});return new i}])}(window),function(e){"use strict";e.realineMessenger.factory("EntityModelCacheService",["utils",function(e){function t(e){var t=this.dict[e.getId()];return t?(t!==e&&n(e,t),t):(this.dict[e.getId()]=e,this.processAddedEntity(e),e)}function n(e,t){var n;for(var i in e.data)n=e.data[i],angular.isFunction(n)||t.set(i,e.data[i])}var i=Class.extend({init:function(e){this.dict={},this.EntityModelClass=e},put:function(e){var n;if(angular.isArray(e))for(n=0;n<e.length;n++)t.call(this,e[n]);else if(angular.isObject(e))return t.call(this,e)},putRaw:function(e){var t=this.dict[e.Id];return t?t:(e=new this.EntityModelClass(e),this.put(e),e)},get:function(e){var t=this.dict[e];return t?t:null},isCached:function(e){return this.dict.hasOwnProperty(e)},getAll:function(){var e=[];for(var t in this.dict)e.push(this.dict[t]);return e},clear:function(){this.dict={}},processAddedEntity:function(e){}});return i}])}(window),function(e){"use strict";e.realineMessenger.factory("EventScheduler",["$timeout","$interval",function(e,t){var n=Class.extend({init:function(e,t){this.interval=null,this.stopTimer=null,this.callbackFunc=e,this.eventInterval=t},start:function(){this.interval||(this.callbackFunc(),this.interval=t(this.callbackFunc,this.eventInterval)),this.stopTimer&&(e.cancel(this.stopTimer),this.stopTimer=null),this.stopTimer=e(this.stop.bind(this),this.eventInterval)},stop:function(){this.interval&&(t.cancel(this.interval),this.interval=null),this.stopTimer&&(e.cancel(this.stopTimer),this.stopTimer=null)}});return n}])}(window),function(e){"use strict";e.realineMessenger.factory("fileHelper",["fileExtensions","_","utils",function(e,t,n){return{isImage:function(i){if(n.common.isNullOrEmpty(i))return!1;var s=i.lastIndexOf(".");if(0>s)return!1;var o=i.slice(s).toLowerCase(),r=t.findIndex(e.image,function(e){return o==e});return r>-1}}}])}(window),function(e){"use strict";e.realineMessenger.factory("HistoryMessagesProvider",["messengerHub","MessageModel","$q","$log","utils",function(e,t,n,i,s){var o=Class.extend({init:function(e){this.settings=angular.extend({},e)},load:function(){var e;return this.settings.history.length()===this.settings.loadedMessages.length()?this.loadFromServer():(e=this.settings.history.length()-this.settings.loadedMessages.length(),e>=this.settings.batchSize?this.loadFromHistory():this.loadFromHistory().then(function(e){return e<this.settings.batchSize?this.loadFromServer(this.settings.batchSize-e).then(function(t){return e+t}):e}.bind(this)))},loadFromHistory:function(){var e,t=this.settings.history,i=this.settings.loadedMessages,s=t.length()-i.length(),o=s-this.settings.batchSize,r=this.settings.batchSize;if(0>o&&(r+=o,o=0),0===i.length())for(;o>0&&!t.get(o-1).getIsRead();)o--,r++;e=t.sublist(o,r),i.unshift(e);var a=n.defer();return a.resolve(e.length),a.promise},loadFromServer:function(i){var o={ConversationId:this.settings.conversationId,Skip:this.settings.loadedMessages.length(),Take:s.common.isNullOrUndefined(i)?this.settings.batchSize:i};return e.getConversationMessages(o).then(function(e){var n=e.map(function(e){return new t(e)});return n.length>0&&this.settings.history.unshift(n),n.length}.bind(this),function(e){return n.reject(e)})}});return o}])}(window),function(e){"use strict";e.realineMessenger.factory("hubConnection",["$q","$log","$","$rootScope","CrossDomainStorage","EventManager","CoreEnums","utils","authConstants","Domains","signalRUtils",function(e,t,n,i,s,o,r,a,d,c,l){function u(){return s.get(d.localStorage).then(function(e){var t={};t[d.header]=e.value,n.connection.hub.qs=t})}function h(e){switch(e){case n.signalR.connectionState.connecting:return r.HubConnectionState.Connecting;case n.signalR.connectionState.connected:return r.HubConnectionState.Connected;case n.signalR.connectionState.reconnecting:return r.HubConnectionState.Reconnecting;case n.signalR.connectionState.disconnected:return r.HubConnectionState.Disconnected;default:t.error(String.format("Unknown messenger hub state {0}",e))}}var g="state_changed",f="disconnected",p=!1;n.connection.hub.logging=!0,n.connection.hub.url=c.MessengerServer;var m=Class.extend({init:function(){this.eventManager=new o,this.isConnected=!1,this.state=r.HubConnectionState.Disconnected,this.bindHubEvents()},connect:function(){return this.connectInternal()},connectInternal:function(){return u().then(function(){return l.callMethod(n.connection.hub.start,n.connection.hub).then(function(){this.isConnected=!0}.bind(this),function(t){return e.reject(t)})}.bind(this),function(t){return e.reject(t)})},disconnect:function(){n.connection.hub.stop()},getState:function(){return this.state},bindHubEvents:function(){n.connection.hub.stateChanged(function(e){var t=h(e.newState),n=h(e.oldState);this.state=t,this.fireStateChanged(t,n)}.bind(this)),n.connection.hub.reconnecting(function(){p=!0}),n.connection.hub.reconnected(function(){p=!1}),n.connection.hub.disconnected(function(){n.connection.hub.lastError&&t.info("Disconnect reason: "+n.connection.hub.lastError.message);var e=n.connection.hub.lastError?n.extend({},n.connection.hub.lastError):null;this.fireDisconnected(p,e)}.bind(this)),n.connection.hub.error(function(e){t.debug("Hub connection error: "+e)}.bind(this))},bindStateChanged:function(e,t){this.eventManager.bind(g,e,t)},unbindStateChanged:function(e,t){this.eventManager.detach(g,e,t)},fireStateChanged:function(e,t){var n=this.eventManager.fire({type:g,newState:e,oldState:t});n&&i.safeApply()},bindDisconnected:function(e,t){this.eventManager.bind(f,e,t)},unbindDisconnected:function(e,t){this.eventManager.detach(f,e,t)},fireDisconnected:function(e,t){var n=this.eventManager.fire({type:f,triedToReconnect:e,lastError:t});n&&i.safeApply()}});return new m}])}(window),function(e){"use strict";e.realineMessenger.factory("messenger",["MessengerEnums","messengerUserService","authService","currentCompanyService","contactsCacheService","profileCacheService","UniqueEntityCollection","utils","$q","$log",function(e,t,n,i,s,o,r,a,d,c){var l=Class.extend({init:function(){this.currentUserPromise=null,this.currentUser=null,this.currentProfilePromise=null,this.currentProfile=null,this.friends=new r,this.colleagues=new r},getFriends:function(){return this.friends},getColleagues:function(){return this.colleagues},getCurrentUser:function(){var e;return null!==this.currentUserPromise?this.currentUserPromise:this.currentUser?(e=d.defer(),e.resolve(this.currentUser),e.promise):(e=d.defer(),t.getCurrentContexts().then(function(t){if(!t.data.Status)return c.error("Failed to load company users. "+errorMessageProvider.getApiErrorMessage(t.data)),void e.reject(t);var n=s.putRaw(t.data.Model);return s.getp(n.getId())}).then(function(t){null!==this.currentUserPromise&&(this.currentUser=t),e.resolve(t)}.bind(this),function(t){e.reject(t)})["finally"](function(){this.currentUserPromise=null}),this.currentUserPromise=e.promise,this.currentUserPromise)},getCurrentProfile:function(){var e;return this.currentProfilePromise?this.currentProfilePromise:this.currentProfile?(e=d.defer(),e.resolve(this.currentProfile),e.promise):(e=d.defer(),this.getCurrentUser().then(function(t){this.currentProfile=this.currentUser.Profiles.find(function(e){return e.getIsLoggedIn()}),e.resolve(this.currentProfile)}.bind(this),function(t){e.reject(t)})["finally"](function(){this.currentProfilePromise=null}.bind(this)),this.currentProfilePromise=e.promise,this.currentProfilePromise)},changeCompany:function(e){null!==this.currentUser&&this.loadNewProfile(e)},logoutCompany:function(){null!==this.currentUser&&(this.currentProfile=this.currentUser.Profiles.find(function(t){return t.getMessengerProfileType()===e.MessengerProfileType.User}),this.currentUser.Profiles.forEach(function(e){e.setIsLoggedIn(!1)}),this.currentProfile.setIsLoggedIn(!0))},logout:function(){this.currentUserPromise=null,this.currentUser=null,this.currentProfilePromise=null,this.currentProfile=null,this.friends.clear(),this.colleagues.clear()},loadNewProfile:function(e){var n=d.defer();this.currentProfilePromise=n.promise,t.getCurrentContexts().then(function(e){var t,i;return e.data.Status?(i=e.data,t=i.Profiles.findItem(function(e){return e.IsLoggedIn}),this.currentUser.Profiles.containsById(t.Id)?(t=this.currentUser.Profiles.find(function(e){return e.getId()===t.Id},this),this.currentUser.Profiles.forEach(function(e){e.setIsLoggedIn(!1)}),this.currentProfile=t,this.currentProfile.setIsLoggedIn(!0)):(t&&(t=o.putRaw(t)),this.currentUser.Profiles.push(t),this.currentProfile=t),void n.resolve(this.currentProfile)):(c.error("Failed to load company users. "+errorMessageProvider.getApiErrorMessage(e.data)),void n.reject(e))}.bind(this),function(e){n.reject(e)})}});return new l}])}(window),function(e){"use strict";e.realineMessenger.factory("messengerHub",["$q","$log","$","$rootScope","HubBase","MessengerEnums","utils","Domains","signalRUtils",function(e,t,n,i,s,o,r,a,d){function c(e){return e.CreateDate=new Date(e.CreateDate),e.MessageType=v(e.MessageType),e}function l(e){var t,n,i,s=[];for(t=0;t<e.length;t++)n=c.call(this,e[t]),n.MessageType!=o.MessageType.Redirect?s.push(n):(i=f(n),s.push(i));return s}function u(e){return e.Type=C(e.Type),e.Messages?(e.Messages.reverse(),e.Messages=l.call(this,e.Messages),e):e}function h(e){var t;for(t=0;t<e.length;t++)u.call(this,e[t]);return e}function g(e){var t;for(t in e)e[t]=p(e[t]);return e}function f(e){var t={Id:e.Id,ConversationId:e.ConversationId,IsRead:e.IsRead,Text:e.Content.AwayMessage,AuthorId:e.Content.RecipientUserId,CreateDate:e.CreateDate,MessageType:o.MessageType.Redirect,Content:e.Content.RedirectUserId,OriginalMessage:e.Text};return t}function p(e){switch(e){case 0:return o.UserStatuses.Offline;case 1:return o.UserStatuses.Online;case 2:return o.UserStatuses.Away;case 3:return o.UserStatuses.Busy;default:return t.error(String.format("Unknown server user status {0}",e)),o.UserStatuses.Unknown}}function m(e){switch(e){case o.UserStatuses.Offline:return 0;case o.UserStatuses.Online:return 1;case o.UserStatuses.Away:return 2;case o.UserStatuses.Busy:return 3;default:t.error(String.format("Unknown user status {0}",e))}}function v(e){switch(e){case 0:return o.MessageType.AddParticipants;case 1:return o.MessageType.LeaveConversation;case 2:return o.MessageType.RenameConversation;case 3:return o.MessageType.TextMessage;case 4:return o.MessageType.Attachment;case 6:return o.MessageType.Redirect;case 9:return o.MessageType.ParticipantRemoved;case 10:return o.MessageType.GroupConversationCreated;case 11:return o.MessageType.ParticipantJoined;default:return t.error(String.format("Unknown MessageType: {0}",e)),o.MessageType.TextMessage}}function C(e){switch(e){case 0:return o.ConversationType.Private;case 1:return o.ConversationType.Group;case 2:return o.ConversationType.Public;default:return t.error(String.format("Unknown ConversationType value: {0}",e)),o.ConversationType.Group}}function y(e){switch(e){case o.ConversationType.Private:return 0;case o.ConversationType.Group:return 1;case o.ConversationType.Public:return 2;default:return t.error(String.format("Unknown ConversationType enum value: {0}",e)),1}}var b="message_received",S="conversation_created",M="user_typing_message",P="user status changed",I="load settings",w="message read",T="messages deleted",R="tag saved",A="tag deleted",U="conversation tagged",D="conversation muted",_="conversation unmuted",N="start videochat",E=s.extend({init:function(){this._super(n.connection.messageHub)},getConversations:function(e){return d.callMethod(this.hub.server.getConversations,this.hub,[e]).then(function(e){return e.Conversations=h.call(this,e.Conversations),e}.bind(this))},getConversation:function(e){return d.callMethod(this.hub.server.getConversation,this.hub,[e]).then(function(e){return e?u.call(this,e):null}.bind(this))},getObjectConversations:function(e){var t={BusinessObjectId:e};return d.callMethod(this.hub.server.getObjectConversations,this.hub,[t]).then(function(e){return e.Conversations=h.call(this,e.Conversations),e}.bind(this))},getStreamsConversations:function(e){var t={StreamId:e};return d.callMethod(this.hub.server.getStreamsConversations,this.hub,[t]).then(function(e){return e.Conversations=h.call(this,e.Conversations),e}.bind(this))},findPrivateConversation:function(e){return d.callMethod(this.hub.server.findPrivateConversation,this.hub,[e]).then(function(e){return e?u.call(this,e):null}.bind(this))},getConversationMessages:function(e){return d.callMethod(this.hub.server.getConversationMessages,this.hub,[e]).then(function(e){return l.call(this,e.reverse())}.bind(this))},createConversation:function(e){var t=angular.extend({},e);return t.Type=y(t.Type),d.callMethod(this.hub.server.createConversation,this.hub,[t])},destroyConversation:function(e){return d.callMethod(this.hub.server.destroyConversation,this.hub,[e])},deleteMessages:function(e,t){var n={ConversationId:e,MessageIds:t};return d.callMethod(this.hub.server.deleteMessage,this.hub,[n])},addParticipants:function(e){return d.callMethod(this.hub.server.addParticipants,this.hub,[e])},removeParticipant:function(e,t){var n={ConversationId:e,ProfileId:t};return d.callMethod(this.hub.server.removeUser,this.hub,[n])},sendMessage:function(e){return d.callMethod(this.hub.server.sendMessage,this.hub,[e])},notifyMessageTyping:function(e){return d.callMethod(this.hub.server.notifyMessageTyping,this.hub,[{ConversationId:e,TypingTimeout:1e3}])},leaveConversation:function(e){return d.callMethod(this.hub.server.leaveConversation,this.hub,[e])},joinConversation:function(e){return d.callMethod(this.hub.server.join,this.hub,[{ConversationId:e}])},getUserStatuses:function(e){return d.callMethod(this.hub.server.getUserStatuses,this.hub,[e]).then(function(e){return g(e)}.bind(this))},setUserStatus:function(e){var t=m(e);return d.callMethod(this.hub.server.setUserStatus,this.hub,[t])},setTemporaryAwayStatus:function(e){return d.callMethod(this.hub.server.setUserStatus,this.hub,[e])},setUserSettings:function(e){return d.callMethod(this.hub.server.setUserSettings,this.hub,[e])},saveTag:function(e){return d.callMethod(this.hub.server.saveTag,this.hub,[e])},deleteTag:function(e){return d.callMethod(this.hub.server.deleteTag,this.hub,[e])},startVideoChat:function(e){return d.callMethod(this.hub.server.startVideoChat,this.hub,[e])},tagConversation:function(e){return d.callMethod(this.hub.server.tagConversation,this.hub,[e])},markMessagesAsRead:function(e){return d.callMethod(this.hub.server.markMessagesAsRead,this.hub,[e])},renameConversation:function(e){return d.callMethod(this.hub.server.renameConversation,this.hub,[e])},getTagsList:function(){return d.callMethod(this.hub.server.getTagsList,this.hub,[])},muteConversation:function(e){return d.callMethod(this.hub.server.muteConversation,this.hub,[e])},unmuteConversation:function(e){return d.callMethod(this.hub.server.unmuteConversation,this.hub,[e])},bindHubEvents:function(){this.hub.client.onCreateConversation=function(e){u.call(this,e),this.fireConversationCreated(e)}.bind(this),this.hub.client.onSendMessage=function(e){var t=c.call(this,e);e.MessageType===o.MessageType.Redirect&&(t=f(e)),this.fireMessageReceived(t)}.bind(this),this.hub.client.onNotifyMessageTyping=function(e){this.fireNotifyMessageTyping(e)}.bind(this),this.hub.client.onUserStatusChanged=function(e){e.Status=p(e.Status),this.fireUserStatusChanged(e)}.bind(this),this.hub.client.onLoad=function(e){e.Value.SettingStatus=p(e.Value.SettingStatus),e.Value.CurrentStatus=p(e.Value.CurrentStatus),this.fireLoadUserSettings(e)}.bind(this),this.hub.client.onMessageRead=function(e){this.fireMessageRead(e)}.bind(this),this.hub.client.onMessageDeleted=function(e){r.common.isNullOrUndefined(e.MessageId)||(e.MessageIds=e.MessageId),this.fireMessagesDeleted(e)}.bind(this),this.hub.client.onTagSaved=function(e){this.fireTagSaved(e)}.bind(this),this.hub.client.onTagDeleted=function(e){this.fireTagDeleted(e)}.bind(this),this.hub.client.onConversationMuted=function(e){this.fireConversationMuted(e)}.bind(this),this.hub.client.onConversationUnmuted=function(e){this.fireConversationUnmuted(e)}.bind(this),this.hub.client.onConversationTagged=function(e){this.fireConversationTagged(e)}.bind(this),this.hub.client.onVideoChatStarted=function(e){this.fireStartVideoChat(e)}.bind(this),this.hub.client.onConversationTaged=function(e){this.fireConversationTagged(e)}.bind(this)},bindConversationCreated:function(e,t){this.eventManager.bind(S,e,t)},unbindConversationCreated:function(e,t){this.eventManager.detach(S,e,t)},fireConversationCreated:function(e){var t=this.eventManager.fire({type:S,conversation:e});t&&i.safeApply()},bindMessageReceived:function(e,t){this.eventManager.bind(b,e,t)},unbindMessageReceived:function(e,t){this.eventManager.detach(b,e,t)},fireMessageReceived:function(e){var t=this.eventManager.fire({type:b,message:e});t&&i.safeApply()},bindNotifyMessageTyping:function(e,t){this.eventManager.bind(M,e,t)},unbindNotifyMessageTyping:function(e,t){this.eventManager.detach(M,e,t)},fireNotifyMessageTyping:function(e){var t=this.eventManager.fire({type:M,data:e});t&&i.safeApply()},bindUserStatusChanged:function(e,t){this.eventManager.bind(P,e,t)},unbindUserStatusChanged:function(e,t){this.eventManager.detach(P,e,t)},fireUserStatusChanged:function(e){var t=this.eventManager.fire({type:P,data:e});t&&i.safeApply()},bindLoadUserSettings:function(e,t){this.eventManager.bind(I,e,t)},unbindLoadUserSettings:function(e,t){this.eventManager.detach(I,e,t)},fireLoadUserSettings:function(e){var t=this.eventManager.fire({type:I,data:e});t&&i.safeApply()},bindMessageRead:function(e,t){this.eventManager.bind(w,e,t)},unbindMessageRead:function(e,t){this.eventManager.detach(w,e,t)},fireMessageRead:function(e){var t=this.eventManager.fire({type:w,data:e});t&&i.safeApply()},bindMessagesDeleted:function(e,t){this.eventManager.bind(T,e,t)},unbindMessagesDeleted:function(e,t){this.eventManager.detach(T,e,t)},fireMessagesDeleted:function(e){var t=this.eventManager.fire({type:T,data:e});t&&i.safeApply()},bindTagSaved:function(e,t){this.eventManager.bind(R,e,t)},unbindTagSaved:function(e,t){this.eventManager.detach(R,e,t)},fireTagSaved:function(e){var t=this.eventManager.fire({type:R,data:e});t&&i.safeApply()},bindTagDeleted:function(e,t){this.eventManager.bind(A,e,t)},unbindTagDeleted:function(e,t){this.eventManager.detach(A,e,t)},fireTagDeleted:function(e){var t=this.eventManager.fire({type:A,data:e});t&&i.safeApply()},bindConversationTagged:function(e,t){this.eventManager.bind(U,e,t)},unbindConversationTagged:function(e,t){this.eventManager.detach(U,e,t)},fireConversationTagged:function(e){var t=this.eventManager.fire({type:U,data:e});t&&i.safeApply()},bindConversationMuted:function(e,t){this.eventManager.bind(D,e,t)},unbindConversationMuted:function(e,t){this.eventManager.detach(D,e,t)},fireConversationMuted:function(e){var t=this.eventManager.fire({type:D,data:e});t&&i.safeApply()},bindConversationUnmuted:function(e,t){this.eventManager.bind(_,e,t)},unbindConversationUnmuted:function(e,t){this.eventManager.detach(_,e,t)},fireConversationUnmuted:function(e){var t=this.eventManager.fire({type:_,data:e});t&&i.safeApply()},bindStartVideoChat:function(e,t){this.eventManager.bind(N,e,t)},unbindStartVideoChat:function(e,t){this.eventManager.detach(N,e,t)},fireStartVideoChat:function(e){var t=this.eventManager.fire({type:N,videoChat:e});t&&i.safeApply()}});return new E}])}(window),function(e){"use strict";e.realineMessenger.factory("messengerRemoteControlService",["MessengerEnums","messageBus","events","$log","utils",function(e,t,n,i,s){var o=Class.extend({init:function(){},createConversation:function(e){t.fire({type:n.createConversation,data:e})},openConversation:function(e,i){var s=null;i&&(s=i.messageText),t.fire({type:n.conversationOpen,conversation:e,messageText:s})},createPrivateConversation:function(t,n){this.createConversation({participants:[{MasterUserId:t,CompanyId:n}],messageText:null,type:e.ConversationType.Private})},createChildGroupConversation:function(t){var n={type:e.ConversationType.Group,messageText:null};angular.extend(n,t),this.createConversation(n)},createBusinessObjectConversation:function(e,i){t.fire({type:n.createBusinessObjectConversation,data:{businessObjectType:e,businessObjectId:i}})},createStreamConversation:function(e,i){t.fire({type:n.createStreamConversation,data:{SubscriberMasterUserId:e,Stream:i}})},showStreamsConversations:function(e){t.fire({type:n.showStreamsConversations,data:{Streams:e}})},hideStreamsConverations:function(e){t.fire({type:n.hideStreamsConversations,data:{Streams:e}})},openChildConversation:function(e){t.fire({type:n.openChildConversation,data:{conversationId:e}})},openMessenger:function(){t.fire({type:n.openMessenger})},setUserStatus:function(e){t.fire({type:n.setUserStatus,data:{status:e}})},setupUnavailableMessage:function(){t.fire({type:n.setupUnavailableMessage})},closeAllConversationTabs:function(){t.fire({type:n.closeAllChatTabs})},setMuteAllConversations:function(e){t.fire({type:n.setMuteAllConversations,value:e})}});return new o}])}(window),function(e){"use strict";e.realineMessenger.factory("messengerSettingsService",["utils","$window","$log",function(e,t,n){var i="messenger_settings",s=Class.extend({init:function(){var s=null;if(this.settings={isPanelVisible:!0,isPanelMinimized:!0},s=t.localStorage[i],!e.common.isNullOrUndefined(s))try{s=JSON.parse(s),
angular.extend(this.settings,s)}catch(o){n.error("Failed to parse messenger settings. "+o)}},save:function(){t.localStorage[i]=JSON.stringify(this.settings)},getIsPanelVisible:function(){return this.settings.isPanelVisible},setIsPanelVisible:function(e){this.settings.isPanelVisible=e,this.save()},getIsPanelMinimized:function(){return this.settings.isPanelMinimized},setIsPanelMinimized:function(e){this.settings.isPanelMinimized=e,this.save()}});return new s}])}(window),function(e){"use strict";e.realineMessenger.factory("messengerUserService",["baseApiService","Domains",function(e,t){var n=e.extend({_domain:t.MessengerUser,init:function(e){this._super(e)},searchUsers:function(e){return this._sendGetQuery("SearchUsers",e)},searchFriends:function(e){return this._sendGetQuery("SearchFriends",e)},getCurrentContexts:function(){return this._sendGetQuery("GetCurrentContexts")},getCompanyUsers:function(e){return this._sendGetQuery("GetCompanyUsers",e)}});return new n("User")}])}(window),function(e){"use strict";e.realineMessenger.factory("notificationHub",["HubBase","utils","signalRUtils","$rootScope","$q","$log","$",function(e,t,n,i,s,o,r){function a(e){}var d="contact added",c="contact removed",l="user info changed",u="company info changed",h="company user added",g="notification received",f=e.extend({init:function(){this._super(r.connection.notificationHub)},notifyContactAdded:function(e){return n.callMethod(this.hub.server.notifyContactAdded,this.hub,[e])},bindHubEvents:function(){this.hub.client.onContactAdded=function(e){this.fireNotifyContactAdded(e)}.bind(this),this.hub.client.onContactRemoved=function(e){this.fireContactRemoved(e)}.bind(this),this.hub.client.onUserInfoChanged=function(e){this.fireUserInfoChanged(e)}.bind(this),this.hub.client.onCompanyInfoChanged=function(e){this.fireCompanyInfoChanged(e)}.bind(this),this.hub.client.onCompanyUserAdded=function(e){this.fireCompanyUserAdded(e)}.bind(this),this.hub.client.onNotification=function(e){a(e),this.fireNotificationReceived(e)}.bind(this)},dummy:function(){return n.callMethod(this.hub.server.dummy,this.hub,[])},bindNotifyContactAdded:function(e,t){this.eventManager.bind(d,e,t)},unbindNotifyContactAdded:function(e,t){this.eventManager.detach(d,e,t)},fireNotifyContactAdded:function(e){var t=this.eventManager.fire({type:d,data:e});t&&i.safeApply()},bindContactRemoved:function(e,t){this.eventManager.bind(c,e,t)},unbindContactRemoved:function(e,t){this.eventManager.detach(c,e,t)},fireContactRemoved:function(e){var t=this.eventManager.fire({type:c,data:e});t&&i.safeApply()},bindUserInfoChanged:function(e,t){this.eventManager.bind(l,e,t)},unbindUserInfoChanged:function(e,t){this.eventManager.detach(l,e,t)},fireUserInfoChanged:function(e){var t=this.eventManager.fire({type:l,data:e});t&&i.safeApply()},bindCompanyInfoChanged:function(e,t){this.eventManager.bind(u,e,t)},unbindCompanyInfoChanged:function(e,t){this.eventManager.detach(u,e,t)},fireCompanyInfoChanged:function(e){var t=this.eventManager.fire({type:u,data:e});t&&i.safeApply()},bindCompanyUserAdded:function(e,t){this.eventManager.bind(h,e,t)},unbindCompanyUserAdded:function(e,t){this.eventManager.detach(h,e,t)},fireCompanyUserAdded:function(e){var t=this.eventManager.fire({type:h,data:e});t&&i.safeApply()},bindNotificationReceived:function(e,t){this.eventManager.bind(g,e,t)},unbindNotificationReceived:function(e,t){this.eventManager.detach(g,e,t)},fireNotificationReceived:function(e){var t=this.eventManager.fire({type:g,data:e});t&&i.safeApply()}});return new f}])}(window),function(e){"use strict";e.realineMessenger.factory("PendingConversationsManager",["EntityCollection","CoreEnums","MessengerEnums","EventManager","observable","utils",function(e,t,n,i,s,o){var r="conversation initialized",a=Class.extend({init:function(t){this.__ClassName="PendingConversationsManager",this.eventManager=new i,this.pendingConversations=new e,this.pendingConversations.bindCollectionChanged(this.pendingConversations_CollectionChanged,this)},push:function(e){this.pendingConversations.push(e)},remove:function(e){this.pendingConversations.remove(e)},clear:function(){this.pendingConversations.clear()},findByRequestId:function(e){var t=this.pendingConversations.find(function(t){return t.getRequestId()===e});return t},pendingConversations_CollectionChanged:function(e){switch(e.action){case t.CollectionAction.Add:this.onConversations_Added(e);break;case t.CollectionAction.Remove:this.onConversations_Removed(e);break;case t.CollectionAction.Replace:break;case t.CollectionAction.Reset:this.onConversations_Reset(e)}},onConversations_Added:function(e){s.bindPropertyChanged(e.newItems,this.Conversation_PropertyChanged,this)},onConversations_Removed:function(e){s.unbindPropertyChanged(e.oldItems,this.Conversation_PropertyChanged,this)},onConversations_Reset:function(e){s.unbindPropertyChanged(e.oldList,this.Conversation_PropertyChanged,this),s.bindPropertyChanged(e.newList,this.Conversation_PropertyChanged,this)},Conversation_PropertyChanged:function(e){e.property===n.PropertyNames.Id&&o.common.isNullOrEmpty(e.oldValue)&&(this.pendingConversations.remove(e.target),this.fireConversationInitialized(e.target))},bindConversationInitialized:function(e,t){this.eventManager.bind(r,e,t)},unbindConversationInitialized:function(e,t){this.eventManager.detach(r,e,t)},fireConversationInitialized:function(e){var t={type:r,sender:this,conversation:e};this.eventManager.fire(t)}});return a}])}(window),function(e){"use strict";e.realineMessenger.factory("profileCacheService",["$q","$log","EntityModelCacheService","ProfileModel","messengerUserService","utils",function(e,t,n,i,s,o){var r=n.extend({init:function(){this._super(i),this.defers={}},get:function(n){var r=this.dict[n];return r?r:(r=new i({Id:n},!1),this.dict[n]=r,this.defers[n]=e.defer(),function(e,n){var i={Ids:[e.getId()]};s.searchUsers(i).then(function(i){if(!i.data.Status)return t.debug("Failed to get global users by ids. "+i.Message),void n.defers[e.getId()].reject(!1);if(o.common.isNullOrUndefined(i.data.Model.List)||0===i.data.Model.List.length)return t.debug(String.format("Not found global user by id {0}",e.getId())),void n.defers[e.getId()].reject("Not found");var s=i.data.Model.List[0],r=s.Profiles.findById(e.getId());return null==r?void t.debug("Profile was not found by Id="+e.getId()):(e.setData(r),void n.processAddedEntity(e))},function(i){t.debug("Failed to get user by id."+e.getId()),n.defers[e.getId()].reject(error)})}(r,this),r)},getp:function(e){return this.get(e),this.defers[e].promise},clear:function(){this._super(),this.defers={}},processAddedEntity:function(t){var n;n=this.defers[t.getId()],o.common.isUndefined(n)&&(n=e.defer(),this.defers[t.getId()]=n),n.resolve(t)}});return new r}])}(window),function(e){"use strict";e.realineMessenger.factory("signalRUtils",["$q","$log","$",function(e,t,n){return{callMethod:function(t,n,i){var s=e.defer();try{t.apply(n,i).done(function(e){s.resolve(e)}).fail(function(e){s.reject(e)})}catch(o){s.reject(o)}return s.promise}}}])}(window),function(e){"use strict";e.realineMessenger.factory("TypingUsersManager",["ObservableCollection","$timeout","$log",function(e,t,n){var i=300,s=Class.extend({init:function(t){this.list=new e,this.typingTimeoutInterval=t},add:function(e){var t=this.list.find(function(t){return t.user.getId()===e.getId()});t?this.updateInternal(t):this.addInternal(e)},addInternal:function(e){var n={user:e,timer:t(this.remove.bind(this,e),this.typingTimeoutInterval+i)};this.list.push(n)},updateInternal:function(e){t.cancel(e.timer),e.timer=t(this.remove.bind(this,e.user),this.typingTimeoutInterval+i)},remove:function(e){var n=this.list.find(function(t){return t.user.getId()===e.getId()});if(n){var i=this.list.indexOf(n);t.cancel(n.timer),this.list.removeAt(i)}},clear:function(){var e;for(e=0;e<this.list.length();e++)t.cancel(this.list.gte(e).timer);this.list.clear()}});return s}])}(window),function(e){"use strict";e.realineMessenger.factory("UserActivitySensor",["EventManager","utils","$document","$",function(e,t,n,i){var s="mousemove keydown wheel DOMMouseScroll mousewheel mousedown touchstart touchmove MSPointerDown MSPointerMove",o="user activity",r=Class.extend({init:function(){this.eventManager=new e,this.sensorId=t.common.newGuid(),this.element=n,this.events=i.trim((s+" ").split(" ").join("."+this.sensorId+" ")),this.mouse={pageX:null,pageY:null},this.isMonitoring=!1},isEnabled:function(){return this.isMonitoring},start:function(){this.isMonitoring||(this.element.on(this.events,this.handleEvent.bind(this)),this.isMonitoring=!0)},stop:function(){this.isMonitoring&&(this.element.off("."+this.sensorId),this.isMonitoring=!1)},handleEvent:function(e){if("mousemove"===e.type){if(e.pageX===this.mouse.pageX&&e.pageY===this.mouse.pageY)return;if("undefined"==typeof e.pageX&&"undefined"==typeof e.pageY)return}this.fire(),this.mouse.pageX=e.pageX,this.mouse.pageY=e.pageY},bind:function(e,t){this.eventManager.bind(o,e,t)},unbind:function(e,t){this.eventManager.detach(o,e,t)},fire:function(){var e={type:o,sender:this};this.eventManager.fire(e)},reset:function(){this.stop()}});return r}])}(window),function(e,t,n){"use strict";function i(t,n){return function(){n.apply(t,e.makeArray(arguments))}}function s(t,n){var s,o,r,a,d;for(s in t)if(t.hasOwnProperty(s)){if(o=t[s],!o.hubName)continue;d=n?o.on:o.off;for(r in o.client)if(o.client.hasOwnProperty(r)){if(a=o.client[r],!e.isFunction(a))continue;d.call(o,r,i(o,a))}}}if("function"!=typeof e.signalR)throw new Error("SignalR: SignalR is not loaded. Please ensure jquery.signalR-x.js is referenced before ~/signalr/js.");var o=e.signalR;e.hubConnection.prototype.createHubProxies=function(){var t={};return this.starting(function(){s(t,!0),this._registerSubscribedHubs()}).disconnected(function(){s(t,!1)}),t.eventFeedHub=this.createHubProxy("eventFeedHub"),t.eventFeedHub.client={},t.eventFeedHub.server={dummy:function(){return t.eventFeedHub.invoke.apply(t.eventFeedHub,e.merge(["Dummy"],e.makeArray(arguments)))},getCurrentContext:function(){return t.eventFeedHub.invoke.apply(t.eventFeedHub,e.merge(["GetCurrentContext"],e.makeArray(arguments)))}},t.hubBase=this.createHubProxy("hubBase"),t.hubBase.client={},t.hubBase.server={getCurrentContext:function(){return t.hubBase.invoke.apply(t.hubBase,e.merge(["GetCurrentContext"],e.makeArray(arguments)))}},t.messageHub=this.createHubProxy("messageHub"),t.messageHub.client={},t.messageHub.server={addParticipants:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["AddParticipants"],e.makeArray(arguments)))},attachBusinessObject:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["AttachBusinessObject"],e.makeArray(arguments)))},createConversation:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["CreateConversation"],e.makeArray(arguments)))},deleteMessage:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["DeleteMessage"],e.makeArray(arguments)))},deleteTag:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["DeleteTag"],e.makeArray(arguments)))},destroyConversation:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["DestroyConversation"],e.makeArray(arguments)))},findPrivateConversation:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["FindPrivateConversation"],e.makeArray(arguments)))},getConversation:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["GetConversation"],e.makeArray(arguments)))},getConversationMessages:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["GetConversationMessages"],e.makeArray(arguments)))},getConversations:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["GetConversations"],e.makeArray(arguments)))},getCurrentContext:function(){return t.messageHub.invoke.apply(t.messageHub,e.merge(["GetCurrentContext"],e.makeArray(arguments)))},getCurrentUserId:function(){return t.messageHub.invoke.apply(t.messageHub,e.merge(["GetCurrentUserId"],e.makeArray(arguments)))},getObjectConversations:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["GetObjectConversations"],e.makeArray(arguments)))},getStreamsConversations:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["GetStreamsConversations"],e.makeArray(arguments)))},getTagsList:function(){return t.messageHub.invoke.apply(t.messageHub,e.merge(["GetTagsList"],e.makeArray(arguments)))},getUserStatuses:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["GetUserStatuses"],e.makeArray(arguments)))},join:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["Join"],e.makeArray(arguments)))},leaveConversation:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["LeaveConversation"],e.makeArray(arguments)))},markMessagesAsRead:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["MarkMessagesAsRead"],e.makeArray(arguments)))},muteConversation:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["MuteConversation"],e.makeArray(arguments)))},notifyMessageTyping:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["NotifyMessageTyping"],e.makeArray(arguments)))},removeUser:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["RemoveUser"],e.makeArray(arguments)))},renameConversation:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["RenameConversation"],e.makeArray(arguments)))},saveTag:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["SaveTag"],e.makeArray(arguments)))},sendMessage:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["SendMessage"],e.makeArray(arguments)))},setTemporaryAwayStatus:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["SetTemporaryAwayStatus"],e.makeArray(arguments)))},setUserSettings:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["SetUserSettings"],e.makeArray(arguments)))},setUserStatus:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["SetUserStatus"],e.makeArray(arguments)))},startVideoChat:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["StartVideoChat"],e.makeArray(arguments)))},tagConversation:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["TagConversation"],e.makeArray(arguments)))},unmuteConversation:function(n){return t.messageHub.invoke.apply(t.messageHub,e.merge(["UnmuteConversation"],e.makeArray(arguments)))}},t.notificationHub=this.createHubProxy("notificationHub"),t.notificationHub.client={},t.notificationHub.server={dummy:function(){return t.notificationHub.invoke.apply(t.notificationHub,e.merge(["Dummy"],e.makeArray(arguments)))},getCurrentContext:function(){return t.notificationHub.invoke.apply(t.notificationHub,e.merge(["GetCurrentContext"],e.makeArray(arguments)))},notifyContactAdded:function(n){return t.notificationHub.invoke.apply(t.notificationHub,e.merge(["NotifyContactAdded"],e.makeArray(arguments)))}},t},o.hub=e.hubConnection("/signalr",{useDefaultPath:!1}),e.extend(o,o.hub.createHubProxies())}(window.jQuery,window),function(e,t){e.positionDropdownMenu=function(n,i){var s,o,r=e(i),a=r.clone(),d=e("body"),c=e(n);a.css("visibility","hidden"),a.offset({left:"-1000px",top:"-1000px"}),d.append(a),o=a.outerHeight(),a.remove(),s=c.offset(),s.width=c.width(),s.height=c.height(),o+s.top+s.height<t.innerHeight?r.css({left:"auto",right:d.outerWidth()-(s.left+s.width)+"px",top:s.top+s.height+"px",bottom:"auto"}):r.css({left:"auto",right:d.outerWidth()-(s.left+s.width)+"px",top:"auto",bottom:t.innerHeight-s.top+"px"})}}(jQuery,window),function(e){"use strict";e.realineMessenger.controller("ChatBubbleMessagesController",["EntityCollection","ObservableCollection","MessengerEnums","CoreEnums","conversationProviderService","events","messageBus","utils","$scope","$log","$timeout",function(e,t,n,i,s,o,r,a,d,c,l){var u=3,h=5e3,g=Class.extend({init:function(){d.controller=this,d.messages=new e,this.timers=new t,this.bindEvents()},onLoggedIn:function(){d.messages.clear()},onLoggedOut:function(){d.messages.clear(),this.timers.forEach(function(e){l.cancel(e.timer)}),this.timers.clear()},onNewMessageReceived:function(e){d.messages.length()===u&&d.messages.shift(),d.messages.push(e.message)},messages_Changed:function(e){switch(e.action){case i.CollectionAction.Add:this.onMessagesAdded(e);break;case i.CollectionAction.Remove:this.onMessagesRemoved(e)}},onMessagesAdded:function(e){var t;for(t=0;t<e.newItems.length;t++)this.createTimer(e.newItems[t])},onMessagesRemoved:function(e){var t;for(t=0;t<e.oldItems.length;t++)this.deleteTimer(e.oldItems[t])},createTimer:function(e){var t={message:e};t.timer=l(function(){d.messages.remove(e)},h),this.timers.push(t)},deleteTimer:function(e){var t=this.timers.find(function(t){return t.message===e});null!==t&&(l.cancel(t.timer),this.timers.remove(t))},onMessageClose:function(e,t){t.stopPropagation(),d.messages.remove(e)},onMessageClick:function(e){var t=s.get(e.getConversationId());d.messages.remove(e),null!==t&&r.fire({type:o.conversationOpen,conversation:t,messageText:null})},bindEvents:function(){r.bind(o.login,this.onLoggedIn,this),r.bind(o.logout,this.onLoggedOut,this),r.bind(o.newMessageReceived,this.onNewMessageReceived,this),d.messages.bindCollectionChanged(this.messages_Changed,this),d.$on("$destroy",function(){r.detach(o.login,this.onLoggedIn,this),r.detach(o.logout,this.onLoggedOut,this),r.detach(o.newMessageReceived,this.onNewMessageReceived,this)}.bind(this))}});return new g}])}(window),function(e){"use strict";e.realineMessenger.factory("ConversationItemController",["messengerHub","TagModel","conversationTagService","MessengerEnums","CoreEnums","observable","utils","$log","$filter",function(e,t,n,i,s,o,r,a,d){var c=Class.extend({init:function(e){this.__ClassName="ConversationItemController",this.scope=e,this.scope.controller=this,this.setupScopeConversation(),this.setupParticipant()},initUI:function(){this.updateStar(),this.updateTitle(),this.updateParticipants(),this.updateLastMessageDate(),this.updateLastMessageText(),this.updateAvatar(),this.updateUnreadMessagesCount()},setupScopeConversation:function(){},conversaton_onPropertyChanged:function(e){switch(e.property){case i.PropertyNames.Title:this.updateTitle();break;case i.PropertyNames.LastMessageDate:this.updateLastMessageDate();break;case i.PropertyNames.LastMessageText:this.updateLastMessageText();break;case i.PropertyNames.UnreadMessagesCount:this.updateUnreadMessagesCount()}},onParticipantPropertyChanged:function(e){switch(e.property){case i.PropertyNames.AvatarThumb:this.updateAvatar()}},updateStar:function(){var e=this.scope.conversation.Tags.find(function(e){return e.getTagType()===i.TagType.Starred});this.scope.starConversation(!r.common.isNullOrUndefined(e))},updateSelection:function(){this.scope.setSelection(this.scope.conversationRecord.getIsSelected())},updateTitle:function(){this.scope.setTitle(this.scope.conversation.getTitle())},updateParticipants:function(){var e,t="",n=this.scope.conversation.getParticipants(!0);for(n=_.sortBy(n,function(e){return e.getName()}),e=0;e<n.length;e++)t.length>0&&(t+=", "),r.common.isNullOrEmpty(n[e].getName())||(t+=n[e].getName());this.scope.setParticipants(t)},updateLastMessageDate:function(){var e=this.scope.conversation.getLastMessageDate();this.scope.setTime(this.dateFilter()(e,"longDateOnly"))},updateLastMessageText:function(){var e=this.scope.conversation.getLastMessageText();r.common.isNullOrUndefined(e)&&(e=""),this.scope.setLastMessageText(e)},updateAvatar:function(){},updateUnreadMessagesCount:function(){this.scope.setUnreadMessagesCount(this.scope.conversation.getUnreadMessagesCount())},getConversationAvatarUrl:function(){var e=this.scope.conversation.getAvatarThumbUrl();return r.common.isNullOrEmpty(e)?this.scope.conversation.isPrivate()?"/Images/no_profile_photo.png":"/images/blank_group.png":e},setupParticipant:function(){var e;return this.scope.conversation.isPrivate()?(e=this.scope.conversation.Participants.find(function(e){return!this.scope.conversation.currentUser.Profiles.containsById(e.getId())},this),void(e!==this.participant&&(this.unsubscribeParticipant(),this.participant=e,this.scope.participant=e,r.common.isNullOrUndefined(this.participant)||this.participant.bindPropertyChanged(this.onParticipantPropertyChanged,this)))):void this.unsubscribeParticipant()},unsubscribeParticipant:function(){r.common.isNullOrUndefined(this.participant)||(this.participant.unbindPropertyChanged(this.onParticipantPropertyChanged,this),this.participant=null)},bindEvents:function(){this.scope.conversation.bindPropertyChanged(this.conversaton_onPropertyChanged,this),this.scope.conversation.Participants.bindCollectionChanged(this.onParticipantsCollectionChanged,this),this.scope.conversation.Tags.bindCollectionChanged(this.onConversationTags_Changed,this),o.bindPropertyChanged(this.scope.conversation.Participants.list,this.Participant_PropertyChanged,this),this.scope.$on("$destroy",function(){this.onDestroy()}.bind(this))},onDestroy:function(){this.scope.conversation.unbindPropertyChanged(this.conversaton_onPropertyChanged,this),this.scope.conversation.Participants.unbindCollectionChanged(this.onParticipantsCollectionChanged,this),this.scope.conversation.Tags.unbindCollectionChanged(this.onConversationTags_Changed,this),this.unsubscribeParticipant(),o.unbindPropertyChanged(this.scope.conversation.Participants.list,this.Participant_PropertyChanged,this)},onParticipantsCollectionChanged:function(e){switch(this.updateAvatar(),this.setupParticipant(),this.updateParticipants(),e.action){case s.CollectionAction.Add:this.onParticipantAdded(e);break;case s.CollectionAction.Remove:this.onParticipantRemoved(e)}},onParticipantAdded:function(e){o.bindPropertyChanged(e.newItems,this.Participant_PropertyChanged,this)},onParticipantRemoved:function(e){o.unbindPropertyChanged(e.oldItems,this.Participant_PropertyChanged,this)},Participant_PropertyChanged:function(e){switch(e.property){case i.PropertyNames.Name:this.updateParticipants()}},dateFilter:function(){return this.dateFilterInstance||(this.dateFilterInstance=d("timeago")),this.dateFilterInstance},onConversationOpen:function(){this.scope.onConversationOpen({conversation:this.scope.conversation})},onConversationTags_Changed:function(e){this.updateStar()},onStarConversation:function(t){if(t.stopPropagation(),!this.updating){var s,o=n.findByType(i.TagType.Starred);this.scope.conversation.Tags.containsById(o)?s=this.scope.conversation.Tags.filter(function(e){return e.getId()!==o.getId()}).map(function(e){return e.getId()}):(s=this.scope.conversation.Tags.map(function(e){return e.getId()}),s.push(o.getId())),this.updating=!0,e.tagConversation({ConversationId:this.scope.conversation.getId(),FolderIds:s}).then(function(){},function(e){a.debug("Failed to tagConversation. "+e)})["finally"](function(){this.updating=!1}.bind(this))}}});return c}])}(window),function(e){"use strict";e.realineMessenger.factory("ConversationViewController",["$log","$timeout","$q","$","MessageModel","MessengerEnums","TypingUsersManager","EventScheduler","CoreEnums","ObservableCollection","UniqueEntityCollection","HistoryMessagesProvider","BusyIndicator","UserActivitySensor","businessObjectService","pageNavigationService","events","utils","$http","$uibModal","messenger",function(e,t,n,i,s,o,r,a,d,c,l,u,h,g,f,p,m,v,C,y,b){var S=3e3,M=1e3,P=Class.extend({init:function(e,t,n,i,s,o,d){this.__ClassName="ConversationViewController",this.scope=e,this.messenger=t,this.hubConnection=n,this.messengerHub=i,this.messageBus=s,this.profileCacheService=o,this.busyIndicator=new h,this.userActivityMonitor=new g,this.options=angular.extend({},d),this.scope.controller=this,this.scope.message=null,this.typingUsersManager=new r(M),this.eventScheduler=new a(this.notifyMessageTyping.bind(this),M),this.messages=new l,this.unreadMessages=new l,this.readTimers=new c,this.historyProvider=null,this.isMenuVisible=!1,this.displayNameEditMode=!1,this.newDisplayName=null,this.isParticpantPickerVisible=!1,this.isFileUploaderVisible=!1,this.otherContacts=null,this.files=[],this.bindMessengerEvents(),this.bindEvents(),this.scope.$on("$destroy",function(){this.onDestroy()}.bind(this)),this.scope.loadMoreMessages=this.loadMoreMessages.bind(this),this.scope.$watch("conversation",function(e,t){this.onConversationChanged(e,t)}.bind(this)),this.scope.$watch("isConversationActive",this.onIsConversationActiveChanged.bind(this))},getMessagesBatchSize:function(){return this.options.messagesBatchSize},onConversationChanged:function(t,n){null!=n&&(n.unbindPropertyChanged(this.conversation_PropertyChanged,this),n.Messages.unbindCollectionChanged(this.conversationMessages_CollectionChanged,this),this.historyProvider=null),this.reset(),null!=t&&(e.debug("onConversationChanged"),t.bindPropertyChanged(this.conversation_PropertyChanged,this),t.Messages.bindCollectionChanged(this.conversationMessages_CollectionChanged,this),this.historyProvider=new u({conversationId:this.scope.conversation.getId(),history:this.scope.conversation.Messages,loadedMessages:this.messages,batchSize:this.getMessagesBatchSize()}),v.common.isNullOrEmpty(this.scope.conversation.getId())||this.historyProvider.load())},reset:function(){this.readTimers.forEach(function(e){t.cancel(e)}),this.readTimers.clear(),this.messages.clear(),this.unreadMessages.clear(),this.typingUsersManager.clear(),this.historyProvider=null,this.loadDefer=null,this.busyIndicator.reset(),this.userActivityMonitor.stop(),this.readTimer&&(t.cancel(this.readTimer),this.readTimer=null)},conversation_PropertyChanged:function(e){e.property===o.PropertyNames.Id},conversationMessages_CollectionChanged:function(t){switch(t.action){case d.CollectionAction.Add:this.conversationMessages_MessagesAdded(t);break;case d.CollectionAction.Remove:this.conversationMessages_MessagesRemoved(t);break;default:e.debug("conversationMessages: unsupported action. "+t.action)}},conversationMessages_MessagesAdded:function(e){e.newStartingIndex>=this.messages.length()?this.messages.push(e.newItems):this.messages.unshift(e.newItems)},conversationMessages_MessagesRemoved:function(e){var t,n=-1;for(t=0;t<e.oldItems.length;t++)if(this.messages.containsById(e.oldItems[t].getId())){n=this.messages.indexOf(e.oldItems[t]);break}-1!==n&&this.messages.removeAt(n,e.oldItems.length)},messages_CollectionChanged:function(e){switch(e.action){case d.CollectionAction.Add:this.messages_MessagesAdded(e)}},messages_MessagesAdded:function(e){var t=e.newItems.filter(function(e){return!e.getIsRead()});t.length>0&&this.unreadMessages.push(t)},unreadMessages_CollectionChanged:function(e){switch(e.action){case d.CollectionAction.Add:this.scope.isConversationActive&&this.userActivityMonitor.start();break;case d.CollectionAction.Remove:this.userActivityMonitor.stop()}},onIsConversationActiveChanged:function(e,t){e&&this.unreadMessages.length()>0?this.userActivityMonitor.start():this.userActivityMonitor.stop()},onSendMessage:function(){(this.scope.message||0!==this.files.length)&&this.isSendButtonEnabled()&&!this.busyIndicator.isBusy()&&(this.scope.conversation.getId()?this.scope.conversation.isJoinedConversation()?this.sendMessage():this.joinConversation().then(function(){this.sendMessage()}.bind(this)):this.createNewConversation(this.scope.message))},sendMessage:function(){this.messenger.getCurrentProfile().then(function(e){var t=v.common.newGuid(),n=new s({Id:t,ConversationId:this.scope.conversation.getId(),Text:this.scope.message,MessageType:o.MessageType.TextMessage,State:o.MessageState.Sending,AuthorId:e.getId(),CreateDate:new Date,IsDeleted:!1,IsRead:!0,Content:{AttachedFiles:this.prepareAttachments()}});return this.scope.message=null,this.scope.conversation.Messages.push(n),this.sendMessageInternal(t,n)}.bind(this),function(t){e.debug("Failed to load current global user. "+t)})},sendMessageInternal:function(t,i){var s;if(this.hubConnection.getState()!==d.HubConnectionState.Connected)return i.setState(o.MessageState.Error),s=n.defer(),s.reject("No connection"),s.promise;var r={ConversationId:this.scope.conversation.getId(),Message:i.getText(),RequestId:t,AttachedFiles:i.getContent(),ProfileId:i.getAuthorId()};return this.messengerHub.sendMessage(r).then(function(e){i.setState(o.MessageState.Success)}.bind(this),function(t){i.setState(o.MessageState.Error),e.error("Failed to send message. "+t)}.bind(this))["finally"](function(){this.files.length=0}.bind(this))},prepareAttachments:function(){var e,t,n,i=[];for(e=0;e<this.files.length;e++)n=this.files[e],n.result&&(t={FileName:n.name},n.isImage?t.FileType=o.FileType.Image:t.FileType=o.FileType.Document,t.FileData=JSON.stringify(n.result),i.push(t));return i},joinConversation:function(){return this.busyIndicator.begin(),this.messengerHub.joinConversation(this.scope.conversation.getId()).then(function(){},function(t){e.error("Failed to join conversation: "+t),n.reject(t)}.bind(this))["finally"](function(){this.busyIndicator.end()}.bind(this))},createNewConversation:function(t,n){this.scope.conversation.setRequestId(v.common.newGuid());var i={RequestId:this.scope.conversation.getRequestId(),DisplayName:this.scope.conversation.getDisplayName(),Participants:this.scope.conversation.Participants.map(function(e){return e.getId()}),BusinessObjecType:this.scope.conversation.getBusinessObjecType(),BusinessObjecId:this.scope.conversation.getBusinessObjecId(),BusinessTransactionId:this.scope.conversation.getBusinessTransactionId(),Message:t,Type:this.scope.conversation.getType()};return n&&Array.prototype.push.apply(i.Participants,n),this.busyIndicator.begin(),this.messengerHub.createConversation(i).then(null,function(t){e.error("Failed to create conversation: "+t)}.bind(this))["finally"](function(){this.busyIndicator.end()}.bind(this))},onMessageKeyPress:function(e){if(27==e.keyCode)return!1;if(13==e.keyCode)if(e.ctrlKey){var t=this.scope.message||"";if("number"==typeof e.target.selectionStart&&"number"==typeof e.target.selectionEnd){var n=e.target.selectionStart;this.scope.message=t.slice(0,n)+"\r\n"+t.slice(e.target.selectionEnd),e.target.selectionStart=e.target.selectionEnd=n+1}else if(document.selection&&document.selection.createRange){e.target.focus();var i=document.selection.createRange();i.text="\r\n",i.collapse(!1),i.select()}this.scope.conversation.getId()&&this.scope.conversation.isJoinedConversation()&&this.eventScheduler.start()}else this.eventScheduler.stop(),this.onSendMessage(),e.preventDefault&&e.preventDefault();else this.scope.conversation.getId()&&this.scope.conversation.isJoinedConversation()&&this.eventScheduler.start()},onSendMessageClick:function(){this.eventScheduler.stop(),this.onSendMessage()},loadMoreMessages:function(){if(this.loadDefer||!this.scope.conversation)return null;this.isLoading=!0,this.loadDefer=n.defer();var t=this.loadDefer.promise;return this.historyProvider.load().then(function(e){this.loadDefer.resolve(e),this.loadDefer=null}.bind(this),function(t){e.error("Failed to load messages. "+t),v.common.isNullOrEmpty(this.loadDefer)||(this.loadDefer.resolve(0),this.loadDefer=null)}.bind(this))["finally"](function(){this.isLoading=!1}.bind(this)),t},onShowMenu:function(){this.isMenuVisible=!0},onHideMenu:function(){this.isMenuVisible=!1},showUserPicker:function(){},onAddPeople:function(){},getParticipantsCount:function(){return this.scope.conversation?this.scope.conversation.isJoinedConversation()?this.scope.conversation.Participants.length()-1:this.scope.conversation.Participants.length():0},onManageParticipants:function(){this.isParticpantPickerVisible=!this.isParticpantPickerVisible,this.isParticpantPickerVisible||this.scope.hideParticipantsPanel()},onPeopleSelected:function(e){if(e&&0!==e.length){var t={ConversationId:this.scope.conversation.getId(),Participants:e};return this.scope.conversation.isPrivate()?void this.createChildConversation(e):void this.addPeopleToConversation(t)}},addPeopleToConversation:function(t){if(this.isConnected()){if(!this.scope.conversation.getId()){
if(this.busyIndicator.isBusy())return;return void this.createNewConversation(null,t.Participants)}this.messengerHub.addParticipants(t).then(function(e){}.bind(this),function(t){e.error("Failed to add participants to conversation. "+t)})}},onAddParticipant:function(t){var i={ConversationId:this.scope.conversation.getId(),Participants:[t.getId()]};return this.messengerHub.addParticipants(i).then(function(e){}.bind(this),function(t){return e.error("Failed to add participants to conversation. "+t),n.reject(t)})},onRemoveParticipant:function(t){return this.messengerHub.removeParticipant(this.scope.conversation.getId(),t.getId()).then(function(){},function(t){return e.error("Failed to remove participant from conversation. "+t),n.reject(t)})},onLeaveConversation:function(){this.canLeaveConversation()&&b.getCurrentProfile().then(function(t){var n={ConversationId:this.scope.conversation.getId(),ProfileId:t.getId()};this.messengerHub.leaveConversation(n).then(function(){}.bind(this),function(){e.debug("Failed to leave conversation.")})}.bind(this))},canTagConversation:function(){return this.scope.conversation&&this.scope.conversation.getId()?this.isConnected()&&this.scope.conversation.isJoinedConversation():!1},onTagConversation:function(){var e=y.open({templateUrl:"/Application/Modules/Messenger/Html/ConversationTagsDialog.html",controller:"ConversationTagsDialogController",size:"smm",backdrop:!1,resolve:{conversation:function(){return this.scope.conversation}.bind(this)}});e.result.then(function(e){}.bind(this))},getCustomTags:function(){return this.scope.conversation.Tags.filter(function(e){return e.getTagType()===o.TagType.CustomFolder})},onRemoveTag:function(t){var n=this.scope.conversation.Tags.filter(function(e){return e!==t}).map(function(e){return e.getId()});this.messengerHub.tagConversation({ConversationId:this.scope.conversation.getId(),FolderIds:n}).then(function(){},function(t){e.debug("Failed to tagConversation. "+t)})},onMuteConversation:function(){this.canMuteConversation()&&b.getCurrentProfile().then(function(e){this.muteConversationInternal(e.getId())}.bind(this))},muteConversationInternal:function(t){this.scope.conversation.getIsMuted()?this.messengerHub.unmuteConversation({ConversationId:this.scope.conversation.getId()}).then(function(){this.scope.conversation.setIsMuted(!1)}.bind(this),function(t){e.debug("Failed to mute conversation. "+t)}):this.messengerHub.muteConversation({ConversationId:this.scope.conversation.getId()}).then(function(){this.scope.conversation.setIsMuted(!0)}.bind(this),function(t){e.debug("Failed to mute conversation. "+t)})},canLeaveConversation:function(){return this.scope.conversation&&this.scope.conversation.getId()?this.isConnected()&&!this.scope.conversation.isPrivate()&&this.scope.conversation.Participants.length()>1&&this.scope.conversation.isJoinedConversation():!1},canAddPeople:function(){return this.scope.conversation.isBusinessObjectConversation()&&v.common.isNullOrUndefined(this.scope.currentCompany)?!1:this.scope.conversation.isJoinedConversation()&&this.isConnected()},canRenameConversation:function(){return this.isConnected()&&this.scope.conversation.isJoinedConversation()},canShowParticipants:function(){var e=!this.scope.conversation.isJoinedConversation();return 1!==this.scope.conversation.Participants.length()||e?!this.scope.conversation.isPrivate()&&(this.scope.conversation.Participants.length()>1&&!e||this.scope.conversation.Participants.length()>0&&e):!1},canMuteConversation:function(){return this.scope.conversation.getId()&&this.scope.conversation.isJoinedConversation()?!0:!1},canRemoveParticipants:function(){return!this.scope.conversation.isPrivate()&&this.scope.conversation.isJoinedConversation()},getOtherParticipants:function(){return this.scope.conversation?this.scope.conversation.Participants.filter(function(e){return!this.scope.currentUser.Profiles.containsById(e.getId())},this):[]},isSendButtonEnabled:function(){if(v.common.isNullOrUndefined(this.scope.conversation))return!1;var e=this.scope.conversation.Participants.length()>1;return e&&(this.scope.conversation.isPublic()||this.scope.conversation.isJoinedConversation())?!0:!1},isConnected:function(){return this.hubConnection.getState()!==d.HubConnectionState.Connected?!1:!0},isConversationCreated:function(){return v.common.isNullOrUndefined(this.scope.conversation)?!1:v.common.isNullOrEmpty(this.scope.conversation.getId())?!1:!0},onUserAction:function(){var e;0!==this.unreadMessages.length()&&(e=this.unreadMessages.cloneArray(),this.unreadMessages.clear(),this.createReadTimer(e))},createReadTimer:function(n){var i=t(function(){var t;if(this.readTimer=null,this.scope.conversation){if(!this.scope.isConversationActive)return void this.unreadMessages.push(n);t={ConversationId:this.scope.conversation.getId(),MessageIds:n.map(function(e){return e.getId()})},this.messengerHub.markMessagesAsRead(t).then(function(){var e;for(e=0;e<n.length;e++)n[e].setIsRead(!0)}.bind(this),function(t){e.debug("Failed to mark messages as read."),this.unreadMessages&&this.unreadMessages.push(n)}.bind(this))["finally"](function(){this.readTimers.remove(i)}.bind(this))}}.bind(this),S);this.readTimers.push(i)},bindMessengerEvents:function(){this.hubConnection.bindStateChanged(this.onMessengerStateChanged,this),this.messengerHub.bindConversationCreated(this.onConversationCreated,this),this.messengerHub.bindMessageReceived(this.onMessageReceived,this),this.messengerHub.bindNotifyMessageTyping(this.onNotifyMessageTyping,this)},unbindMessengerEvents:function(){this.hubConnection.unbindStateChanged(this.onMessengerStateChanged,this),this.messengerHub.unbindConversationCreated(this.onConversationCreated,this),this.messengerHub.unbindMessageReceived(this.onMessageReceived,this),this.messengerHub.unbindNotifyMessageTyping(this.onNotifyMessageTyping,this)},onMessengerStateChanged:function(e){this.ConnectionState=e.newState},onConversationCreated:function(e){if(v.common.isNullOrEmpty(this.scope.conversation.getId())&&!v.common.isNullOrEmpty(e.conversation.RequestId)&&this.scope.conversation.getRequestId()===e.conversation.RequestId){var t;this.scope.conversation.setId(e.conversation.Id),t=e.conversation.Messages.map(function(e){return new s(e)}),t.length>0&&(this.scope.conversation.Messages.push(t),this.scope.conversation.Messages.last().setIsRead(!0)),t.length>0&&this.scope.conversation.Messages.last().getMessageType()!==o.MessageType.Redirect&&(this.scope.message=null)}},onMessageReceived:function(t){if(this.scope.conversation&&this.scope.conversation.getId()===t.message.ConversationId){var n=null;n=this.scope.conversation.Participants.findById(t.message.AuthorId),n?this.typingUsersManager.remove(n):e.debug(String.format("Unknown participant {0} in conversation {1}."))}},onNotifyMessageTyping:function(t){if(t.data.ConversationId===this.scope.conversation.getId()&&!this.scope.currentUser.Profiles.containsById(t.data.ParticipantProfileId)){var n=this.scope.conversation.Participants.findById(t.data.ParticipantProfileId);return n||(n=this.scope.conversation.Participants.find(function(e){return e.Id()===t.data.ParticipantProfileId})),n?void this.typingUsersManager.add(n):void e.debug(String.format("Unknown participant {0} in conversation {1}."))}},notifyMessageTyping:function(){this.messengerHub.notifyMessageTyping(this.scope.conversation.getId())},createChildConversation:function(e){var t=this.scope.conversation.Participants.map(function(e){return e.getId()});Array.prototype.push.apply(t,e),this.messageBus.fire({type:m.createConversation,data:{participants:t,parentConversation:this.scope.conversation,type:o.ConversationType.Group,messageText:null}})},onOpenChildGroupConversation:function(e){this.messageBus.fire({type:m.openChildConversation,data:{conversationId:e.getParentConversationId()}})},onContactRedirectDestinationUser:function(e){var t,n=this.scope.conversation.Messages.indexOf(e),i=null,s=this.scope.conversation;n>0&&(t=s.Messages.get(n-1),t.getMessageType()===o.MessageType.TextMessage&&(i=t.getText()));var r="Redirected from: ";r+=this.scope.conversation.getDisplayName()?this.scope.conversation.getDisplayName():this.scope.currentUser.getName(),this.messageBus.fire({type:m.createConversation,data:{displayName:r,participants:[e.getRedirectDestinationUserId()],type:o.ConversationType.Group,messageText:i}})},onResendMessages:function(e){0!==e.length&&this.isSendButtonEnabled()&&(this.scope.conversation.isPublic()&&!this.scope.conversation.isJoinedConversation()?this.joinConversation().then(function(){this.resendMessagesInternal(e)}.bind(this)):this.resendMessagesInternal(e))},resendMessagesInternal:function(e){var t;for(t=0;t<e.length;t++)this.resendMessageInternal(e[t])},resendMessageInternal:function(e){this.scope.conversation.Messages.remove(e),e.setState(o.MessageState.Sending),e.setCreateDate(new Date),this.scope.conversation.Messages.push(e),this.sendMessageInternal(e.getId(),e)},onDeleteMessages:function(e){var t,n;if(0!==e.length)for(t=e.map(function(e){return e.getId()}),n=0;n<e.length;n++)e[n].setIsDeleted(!0)},changeConversationName:function(t){return this.newDisplayName===this.scope.conversation.getTitle()||v.common.isNullOrEmpty(this.newDisplayName)?void 0:this.scope.conversation.getId()?void this.messengerHub.renameConversation({ConversationId:this.scope.conversation.getId(),ConversationName:this.newDisplayName}).then(null,function(){e.error("Failed to rename conversation.")}):void this.scope.conversation.setDisplayName(this.newDisplayName)},onRenameConversation:function(){this.canRenameConversation()&&(this.newDisplayName=this.scope.conversation.getTitle(),this.displayNameEditMode=!0)},onHeaderClick:function(){this.onRenameConversation()},onNewDisplayNameChange:function(){this.displayNameEditMode&&(this.displayNameEditMode=!1,this.changeConversationName(this.newDisplayName))},onNewDisplayNameKeyPress:function(e){return 27==e.keyCode?(this.displayNameEditMode=!1,!1):void(13==e.keyCode&&(this.displayNameEditMode=!1,this.changeConversationName(this.newDisplayName)))},onDisplayNameFocus:function(e){e.target.setSelectionRange(0,e.target.value.length)},navigateToBOPage:function(){var e=f.getEditPage(this.scope.conversation.getBusinessObjecType());v.common.isNullOrUndefined(e)||p.changeLocation(e,{id:this.scope.conversation.getBusinessObjecId()})},bindEvents:function(){this.userActivityMonitor.bind(this.onUserAction,this),this.messages.bindCollectionChanged(this.messages_CollectionChanged,this),this.unreadMessages.bindCollectionChanged(this.unreadMessages_CollectionChanged,this)},unbindEvents:function(){this.userActivityMonitor.unbind(this.onUserAction,this),this.scope.conversation&&(this.scope.conversation.unbindPropertyChanged(this.conversation_PropertyChanged,this),this.scope.conversation.Messages.unbindCollectionChanged(this.conversationMessages_CollectionChanged,this))},onDestroy:function(){this.unbindMessengerEvents(),this.unbindEvents(),this.reset()}});return P}])}(window),function(e){"use strict";e.realineMessenger.controller("CreateConversationDialogController",["messengerUserService","messenger","MessengerEnums","CoreEnums","BusyIndicator","UserModel","messageBus","utils","FloatingWindowBase","wnd","errorMessageProvider","hubConnection","createConversationCallback","$scope","$log",function(e,t,n,i,s,o,r,a,d,c,l,u,h,g,f){var p=d.extend({init:function(e,t){this._super(e,t),this.isMinimized=!1,this.isCcLineVisible=!1,this.participants={},this.scope.selectedUsers={selected:[]},this.currentContextGlobalMasterId=null,this.messageText=null,this.conversationName=null,this.errorMessage=null,this.isFileUploaderVisible=!1,this.files=[],this.busyIndicator=new s,this.bindEvents(),this.loadData()},bindEvents:function(){},onCloseClick:function(){this.close()},onMinimizeClick:function(){this.isMinimized=!this.isMinimized},buildContactList:function(e){var t,n,i,s=[];for(t=0;t<e.length;t++)n=e[t],this.participants.hasOwnProperty(n.getId())||(i=this.findAllowedProfiles(n),Array.prototype.push.apply(s,i));return s},findAllowedProfiles:function(e){var t,i;return null===this.currentContextGlobalMasterId?e.Profiles.cloneArray():1===e.Profiles.length()?[e.Profiles.get(0)]:(i=e.Profiles.find(function(e){return e.getContextGlobalMasterId()===this.currentContextGlobalMasterId},this),null!==i?[i]:t=e.Profiles.filter(function(e){return e.getMessengerProfileType()===n.MessengerProfileType.Company},this))},buildUserList:function(){return[]},adjustUsersList:function(){g.users=this.buildUserList()},refreshUsers:function(t){var n={Skip:0,Count:20,SearchString:t};e.searchUsers(n).then(function(e){if(!e.data.Status)return void f.error("Failed to load users. "+l.getApiErrorMessage(e.data));var t=e.data.Model.List.map(function(e){return new o(e)});g.users=this.buildContactList(t)}.bind(this),function(e){f.error("Failed to load users by keyword."+e)})},onUserSelected:function(e,t){g.users=[],this.participants[t.getGroupId()]=!0,this.adjustUsersList()},onUserRemoved:function(e,t){delete this.participants[t.getGroupId()],this.adjustUsersList()},getSelectedUsers:function(){return this.scope.selectedUsers.selected},loadData:function(){g.updating=!1,this.adjustUsersList()},onMessageKeyPress:function(e){if(27==e.keyCode)return!1;if(13==e.keyCode)if(e.ctrlKey){var t=this.controller.message||"";if("number"==typeof e.target.selectionStart&&"number"==typeof e.target.selectionEnd){var n=e.target.selectionStart;this.controller.message=t.slice(0,n)+"\r\n"+t.slice(e.target.selectionEnd),e.target.selectionStart=e.target.selectionEnd=n+1}else if(document.selection&&document.selection.createRange){e.target.focus();var i=document.selection.createRange();i.text="\r\n",i.collapse(!1),i.select()}}else this.onSendMessage(),e.preventDefault&&e.preventDefault()},canCreateConversation:function(){if(this.busyIndicator.isBusy())return!1;if(!this.isConnected())return!1;var e=this.getSelectedUsers().length>0;return e?!0:!1},isConnected:function(){return u.getState()!==i.HubConnectionState.Connected?!1:!0},onSendMessageClick:function(){this.onSendMessage()},onSendMessage:function(){this.messageText&&this.canCreateConversation()&&this.createNewConversation()},createNewConversation:function(){return this.busyIndicator.begin(),t.getCurrentProfile().then(function(e){return this.createNewConversationInternal(e)}.bind(this),function(e){f.debug("Failed to get global user during conversation creation.")})["finally"](function(){this.busyIndicator.end()}.bind(this))},createNewConversationInternal:function(e){var t={RequestId:a.common.newGuid(),DisplayName:this.conversationName,ParticipantProfilesId:this.getSelectedUsers().map(function(e){return e.getId()}),Type:n.ConversationType.Group,Message:{Message:this.messageText,AttachedFiles:{AttachedFiles:this.prepareAttachments()},ProfileId:e.getId()},ProfileId:e.getId()};return this.errorMessage=null,h(t).then(function(){this.close()}.bind(this),function(e){this.errorMessage=e,f.error("Failed to create conversation: "+e)}.bind(this))},prepareAttachments:function(){var e,t,i,s=[];for(e=0;e<this.files.length;e++)i=this.files[e],i.result&&(t={FileName:i.name},i.isImage?t.FileType=n.FileType.Image:t.FileType=n.FileType.Document,t.FileData=JSON.stringify(i.result),s.push(t));return s}});return new p(g,c)}])}(window),function(e){"use strict";e.realineMessenger.controller("MessengerToolbarController",["$scope","$log","$window","$","$q","$rootScope","MessengerEnums","MessengerConstants","events","messageBus","CoreEnums","utils","uiSettingsService","messengerRemoteControlService",function(e,t,n,i,s,o,r,a,d,c,l,u,h,g){function f(e){switch(e){case r.UserStatuses.Unknown:return"unknown";case r.UserStatuses.Online:return"online";case r.UserStatuses.Offline:return"offline";case r.UserStatuses.Away:return"away";case r.UserStatuses.Busy:return"busy"}}function p(e){switch(e){case r.UserStatuses.Unknown:return"Unknown";case r.UserStatuses.Online:return"Online";case r.UserStatuses.Offline:return"Offline";case r.UserStatuses.Away:return"Away";case r.UserStatuses.Busy:return"Busy"}}var m;return new(m=Class.extend({init:function(e){this.scope=e,this.scope.controller=this,this.isInitialized=!1,this.isStatusMenuVisible=!1,this.setUserStatus(r.UserStatuses.Offline),this.isMuteAllConversations=!1,this.bindEvents()},initContainer:function(){},deinitContainer:function(){},showStatusMenu:function(){this.isStatusMenuVisible=!0},hideStatusMenu:function(){this.isStatusMenuVisible=!1},onUserStatusChanged:function(e){this.setUserStatus(e.status)},setUserStatus:function(e){this.userStatus=e,this.userStatusStyle=f(e),this.userStatusTitle=p(e)},setUserStatusRemote:function(e){g.setUserStatus(e),this.hideStatusMenu()},setOnline:function(){this.setUserStatusRemote(r.UserStatuses.Online)},setOffline:function(){this.setUserStatusRemote(r.UserStatuses.Offline)},setAway:function(){this.setUserStatusRemote(r.UserStatuses.Away)},setBusy:function(){this.setUserStatusRemote(r.UserStatuses.Busy)},setupUnavailableMessage:function(){g.setupUnavailableMessage()},isConnected:function(){return this.userStatus!==r.UserStatuses.Offline},showActionsMenu:function(){this.isActionsMenuVisible=!0},hideActionsMenu:function(){this.isActionsMenuVisible=!1},closeAllConversationTabs:function(){g.closeAllConversationTabs()},setMuteAll:function(){g.setMuteAllConversations(!this.isMuteAllConversations)},canMuteAll:function(){return this.isConnected()},onMuteAllConversationsChanged:function(e){this.isMuteAllConversations=e.value},bindEvents:function(){c.bind(d.userStatusChanged,this.onUserStatusChanged,this),c.bind(d.muteAllConversationsChanged,this.onMuteAllConversationsChanged,this),this.scope.$on("$destroy",function(){c.detach(d.userStatusChanged,this.onUserStatusChanged,this),c.detach(d.muteAllConversationsChanged,this.onMuteAllConversationsChanged,this)}.bind(this))}}))(e)}])}(window),function(e){"use strict";e.realineMessenger.controller("ConversationContainerController",["$scope","$log","$q","ConversationViewController","hubConnection","messengerHub","profileCacheService","messenger","messageBus",function(e,t,n,i,s,o,r,a,d){var c=50,l={messagesBatchSize:c},u=i.extend({init:function(){this._super(e,a,s,o,d,r,l),this.__ClassName="ConversationContainerController"}});return new u}])}(window),function(e){"use strict";e.realineMessenger.controller("ConversationDayMessagesContainerController",["MessageRecord","ObservableCollection","UniqueEntityCollection","MessengerEnums","CoreEnums","utils","$scope","$log","$filter",function(e,t,n,i,s,o,r,a,d){function c(e,t){var n,s;return e.getMessageType()!==i.MessageType.TextMessage?!1:t.getMessageType()!==i.MessageType.TextMessage?!1:e.getAuthorId()!==t.getAuthorId()?!1:(n=h(e.getCreateDate(),g),s=h(t.getCreateDate(),g),n!==s?!1:!0)}function l(e){var t={list:new n};return t.list.push(e),t}function u(e){var t,n,i,s=[];for(n=l(e[0]),s.push(n),t=1;t<e.length;t++)i=e[t],c(n.list.last(),i)?n.list.push(i):(n=l(i),s.push(n));return s}var h=d("date"),g="yyyyMMdd HHmm",f=Class.extend({init:function(){this.__ClassName="ConversationDayMessagesContainerController",r.dayGroupController=this,this.messages=r.dayGroup.messages,this.messageGroups=new t,r.messageGroups=this.messageGroups,this.bindEvents(),this.addMessagesToBottom(this.messages.list)},bindEvents:function(){this.messages.bindCollectionChanged(this.messages_Changed,this),r.$on("$destroy",function(){this.messages.unbindCollectionChanged(this.messages_Changed,this)}.bind(this))},messages_Changed:function(e){switch(e.action){case s.CollectionAction.Add:this.onMessagesAdded(e);break;case s.CollectionAction.Remove:this.onMessagesRemoved(e);break;case s.CollectionAction.Replace:break;case s.CollectionAction.Reset:}},onMessagesAdded:function(e){e.newStartingIndex>=this.messages.length()-1?this.addMessagesToBottom(e.newItems):this.addMessagesToTop(e.newItems)},onMessagesRemoved:function(e){var t,n,i;if(0===this.messages.length())this.messageGroups.clear();else for(t=0;t<e.oldItems.length;t++)n=e.oldItems[t],i=this.findGroupByMessage(n),i&&(1===i.list.length()?this.messageGroups.remove(i):i.list.remove(n))},addMessagesToBottom:function(e){var t,n,i,s,o=this.messageGroups.last();if(null!==o){for(s=o.list.last(),i=0;i<e.length&&(t=e[i],c(s,t));i++)o.list.push(t);e=i<e.length?e.slice(i):[]}0!=e.length&&(n=u(e),this.messageGroups.push(n))},addMessagesToTop:function(e){var t,n,i,s,o=this.messageGroups.first();if(null!==o){for(s=o.list.first(),i=e.length-1;i>-1&&(t=e[i],c(s,t));i--)o.list.unshift(t);e=i>-1?e.slice(0,i+1):[]}0!=e.length&&(n=u(e),this.messageGroups.unshift(n))},findGroupByMessage:function(e){var t;for(t=0;t<this.messageGroups.length();t++)if(this.messageGroups.get(t).list.containsById(e.getId()))return this.messageGroups.get(t);return null}});return new f}])}(window),function(e){"use strict";e.realineMessenger.controller("ConversationListController",["ConversationRecord","conversationService","EntityCollection","CoreEnums","conversationProviderService","utils","messageBus","events","observable","MessengerEnums","$scope","$log",function(e,t,n,i,s,o,r,a,d,c,l,u){var h=20,g=Class.extend({init:function(e){this.__ClassName="ConversationListController",this.scope=e,l.conversations=new n,l.controller=this,this.canLoad=!0,this.isLoading=!1,l.conversationRecords=new n,this.activeFolder=null,this.bindEvents()},conversations_CollectionChanged:function(e){switch(e.action){case i.CollectionAction.Add:this.onConversationsAdded(e);break;case i.CollectionAction.Remove:this.onConversationsRemoved(e);break;case i.CollectionAction.Replace:break;case i.CollectionAction.Move:this.onConversationMoved(e);break;case i.CollectionAction.Reset:}},onConversationsAdded:function(t){var n=t.newItems.map(function(t){return new e(t)});d.bindPropertyChanged(t.newItems,this.Conversation_PropertyChanged,this),l.conversationRecords.insert(t.newStartingIndex,n),d.bindCollectionChanged(t.newItems.map(function(e){return e.Tags}),this.conversationTags_Changed,this)},onConversationsRemoved:function(e){d.unbindPropertyChanged(e.oldItems,this.Conversation_PropertyChanged,this),l.conversationRecords.removeAt(e.oldStartingIndex,e.oldItems.length),d.unbindCollectionChanged(e.oldItems.map(function(e){return e.Tags}),this.conversationTags_Changed,this)},onConversationMoved:function(e){l.conversationRecords.move(e.oldIndex,e.newIndex)},Conversation_PropertyChanged:function(e){var t;e.property===c.PropertyNames.LastMessageDate&&(t=this.scope.conversations.indexOf(e.target),0!==t&&this.scope.conversations.move(t,0))},conversationRecords_CollectionChanged:function(e){switch(e.action){case i.CollectionAction.Add:this.onConversationRecordsAdded(e);break;case i.CollectionAction.Remove:}},onConversationRecordsAdded:function(e){},conversationTags_Changed:function(e){switch(e.action){case i.CollectionAction.Remove:this.onConversationTagsRemoved(e)}},onConversationTagsRemoved:function(e){e.oldItems.indexOf(this.activeFolder)<0||this.scope.conversations.remove(e.sender.Conversation)},onSearchKeywordChanged:function(e,t){e!==t&&this.buildConversationList()},buildConversationList:function(){var t,n;o.common.isNullOrEmpty(l.searchKeyword)?t=l.conversations.map(function(t){return new e(t)}):(n=l.conversations.filter(function(e){return this.searchConversation(e)}.bind(this)),t=n.map(function(t){return new e(t)})),l.conversationRecords.clear(),l.conversationRecords.push(t)},searchConversation:function(e){if(o.common.isNullOrEmpty(l.searchKeyword))return!0;var t,n,i,s=l.searchKeyword.toLowerCase();if(!o.common.isNullOrEmpty(e.getTitle())&&(i=e.getTitle().toLowerCase(),i.indexOf(s)>-1))return!0;for(t=0;t<e.Participants.length();t++)if(n=e.Participants.get(t),!l.currentUser.Profiles.containsById(n.getId())&&!o.common.isNullOrEmpty(n.getName())&&(i=n.getName().toLowerCase(),i.indexOf(s)>-1))return!0;return!1},onConversationOpen:function(e){this.scope.onConversationOpen({conversation:e})},onConversationsScroll:function(e,t){if(e===t){if(this.isLoading)return;this.isLoading=!0,this.loadMoreConversations()["finally"](function(){this.isLoading=!1}.bind(this))}},onActiveFolderChanged:function(e){this.activeFolder!=e.folder&&(this.activeFolder=e.folder,l.conversations.clear()),this.activeFolder&&this.loadMoreConversations()},loadMoreConversations:function(){var e={Skip:l.conversations.length(),Take:h,GetUnreadOnly:!1,MessagesPerConversation:1,FolderId:this.activeFolder.getId()};if(!this.isLoading)return this.isLoading=!0,s.loadConversations(e).then(function(e){l.conversations.push(e)},function(e){u.debug("Failed to load more conversations."+e)})["finally"](function(){this.isLoading=!1}.bind(this))},bindEvents:function(){l.conversations.bindCollectionChanged(this.conversations_CollectionChanged,this),l.conversationRecords.bindCollectionChanged(this.conversationRecords_CollectionChanged,this),r.bind(a.activeFolderChanged,this.onActiveFolderChanged,this),l.$watch("searchKeyword",function(e,t){this.onSearchKeywordChanged(e,t)}.bind(this)),l.$on("$destroy",this.onDestroy.bind(this))},onDestroy:function(){l.conversations.unbindCollectionChanged(this.conversations_CollectionChanged,this),l.conversationRecords.unbindCollectionChanged(this.conversationRecords_CollectionChanged,this),r.detach(a.activeFolderChanged,this.onActiveFolderChanged,this)}});return new g(l)}])}(window),function(e){"use strict";e.realineMessenger.controller("ConversationListItemController",["ConversationItemController","MessengerEnums","$scope",function(e,t,n){var i=e.extend({init:function(e){this._super(e),this.__ClassName="ConversationListItemController",this.bindEvents()},initUI:function(){this._super(),this.updateSelection()},setupScopeConversation:function(){this.scope.conversation=this.scope.conversationRecord.Conversation},conversatonRecord_onPropertyChanged:function(e){e.property===t.PropertyNames.IsSelected&&this.updateSelection()},updateSelection:function(){this.scope.setSelection(this.scope.conversationRecord.getIsSelected())},bindEvents:function(){this._super(),this.scope.conversationRecord.bindPropertyChanged(this.conversatonRecord_onPropertyChanged,this)},onDestroy:function(){this._super(),this.scope.conversationRecord.unbindPropertyChanged(this.conversatonRecord_onPropertyChanged,this)}});return new i(n)}])}(window),function(e){"use strict";e.app.controller("ConversationMessageGroupController",["$scope","$log","MessengerEnums","CoreEnums","events","utils","observable",function(e,t,n,i,s,o,r){var a=Class.extend({init:function(){this.__ClassName="ConversationMessageGroupController",e.msgController=this,this.messages=e.messageGroup.list,this.changeLastMessage(this.messages.last()),this.isReadByOthers=!1,this.hasErrors=!0,this.initController(),this.bindEvents()},bindEvents:function(){this.messages.bindCollectionChanged(this.messages_Changed,this),e.$on("$destroy",function(){this.messages.unbindCollectionChanged(this.messages_Changed,this),this.message&&(this.message.Readers.unbindCollectionChanged(this.Readers_Changed,this),this.message.Author.unbindPropertyChanged(this.Author_PropertyChanged,this)),r.unbindPropertyChanged(this.messages.list,this.message_PropertyChanged,this)}.bind(this))},initController:function(){r.bindPropertyChanged(this.messages.list,this.message_PropertyChanged,this)},messages_Changed:function(e){switch(e.action){case i.CollectionAction.Add:this.onMessagesAdded(e);break;case i.CollectionAction.Remove:this.onMessagesRemoved(e);break;case i.CollectionAction.Replace:break;case i.CollectionAction.Reset:}},onMessagesAdded:function(e){e.newStartingIndex>=this.messages.length()-1,r.bindPropertyChanged(e.newItems,this.message_PropertyChanged,this),this.changeLastMessage(this.messages.last()),this.updateUnreadMark(),this.updateCommonErrorMark()},onMessagesRemoved:function(e){var t;r.unbindPropertyChanged(e.oldItems,this.message_PropertyChanged,this),t=e.oldItems.findItem(function(e){return e===this.message},this),t&&(this.message.Readers.unbindCollectionChanged(this.Readers_Changed,this),this.messages.length()>0&&(this.changeLastMessage(this.messages.last()),this.message.Readers.bindCollectionChanged(this.Readers_Changed,this))),this.updateUnreadMark(),this.updateCommonErrorMark()},message_PropertyChanged:function(t){switch(t.property){case n.PropertyNames.IsRead:this.updateUnreadMark();break;case n.PropertyNames.IsDeleted:t.newValue&&e.markAsDeleted(t.target),this.updateCommonErrorMark();break;case n.PropertyNames.State:e.setMessageState(t.target,this.message===t.target),this.updateCommonErrorMark();break;case n.PropertyNames.Id:e.changeMsgId(t.newValue,t.oldValue)}},Author_PropertyChanged:function(e){switch(e.property){case n.PropertyNames.AvatarThumb:this.updateAvatar();break;case n.PropertyNames.Name:this.updateUserName()}},changeLastMessage:function(t){this.message!=t&&(this.message&&(this.message.Readers.unbindCollectionChanged(this.Readers_Changed,this),this.message.Author.unbindPropertyChanged(this.Author_PropertyChanged,this)),this.message=t,e.message=t,o.common.isNullOrEmpty(t)||(this.message.Readers.bindCollectionChanged(this.Readers_Changed,this),this.message.Author.bindPropertyChanged(this.Author_PropertyChanged,this)),this.onLastMessageChanged())},onLastMessageChanged:function(){this.updateReadByOthersMark(),e.setMessageState&&e.setMessageState(this.message,!0)},updateAvatar:function(){e.updateAvatar(e.message.Author.getAvatarThumbUrl())},updateUserName:function(){e.updateUserName(e.message.Author.getName())},updateUnreadMark:function(){var e=this.messages.contains(function(e){return!e.getIsRead()});this.setIsReadStatus(!e)},setIsReadStatus:function(t){this.isRead!==t&&(this.isRead=t,angular.isFunction(e.setIsReadStatus)&&e.setIsReadStatus(this.isRead))},Readers_Changed:function(e){switch(e.action){case i.CollectionAction.Add:this.onReadersAdded(e)}},onReadersAdded:function(e){this.updateReadByOthersMark()},updateReadByOthersMark:function(t){this.message.Readers.length()>0&&this.isOutgoing()?(e.showReadByOthersMark&&e.showReadByOthersMark(!0),e.markAsSent&&e.markAsSent(this.message,!0,!1),this.isReadByOthers=!0):(e.showReadByOthersMark&&e.showReadByOthersMark(!1),this.isReadByOthers=!1)},readByOthersClick:function(){var t=this.message.Readers.cloneArray();t=_.sortBy(t,function(e){return e.getName()}),e.showReadersPanel(t)},updateCommonErrorMark:function(){var t=this.messages.contains(function(e){return e.getState()===n.MessageState.Error&&!e.getIsDeleted()});this.hasErrors!==t&&(this.hasErrors=t,e.setCommonErrorState(t))},updateUI:function(){this.updateUnreadMark(),this.updateReadByOthersMark(),this.messages.forEach(function(t){e.setMessageState(t,t===this.message)},this),this.updateCommonErrorMark(),this.updateAvatar()},isOutgoing:function(){return e.controller.isOutgoingMessage(this.message)},onResendMessages:function(){var t=this.messages.filter(function(e){return e.getState()===n.MessageState.Error});t.length>0&&e.controller.onResendMessages(t)},onDeleteMessages:function(){var t=this.messages.filter(function(e){return e.getState()===n.MessageState.Error});t.length>0&&e.controller.onDeleteMessages(t)}});return new a}])}(window),function(e){"use strict";e.realineMessenger.controller("ConversationMessagesContainerController",["ObservableCollection","UniqueEntityCollection","EntityCollection","MessengerEnums","MessageRecord","CoreEnums","utils","observable","$scope","$log","$filter",function(e,t,n,i,s,o,r,a,d,c,l){function u(e,t){var n,i;return n=p(e.getCreateDate(),m),i=p(t.getCreateDate(),m),n!==i?!1:!0}function h(e){var t={day:g(e.getCreateDate()),messages:new n};return t.messages.push(e),t}function g(e){var t=new Date(e.getTime());return t.setHours(0,0,0,0),t}function f(e){var t,n,i,s=[];for(n=h(e[0]),s.push(n),t=1;t<e.length;t++)i=e[t],u(n.messages.last(),i)?n.messages.push(i):(n=h(i),s.push(n));return s}var p=l("date"),m="yyyyMMdd",v=Class.extend({init:function(){this.__ClassName="ConversationMessagesContainerController",d.controller=this,this.messages=d.messages,this.messageDayGroups=new e,d.messageDayGroups=this.messageDayGroups,this.addMessagesToBottom(this.messages.list),
this.bindEvents()},bindEvents:function(){this.messages.bindCollectionChanged(this.messages_Changed,this),d.$on("$destroy",function(){this.messages.unbindCollectionChanged(this.messages_Changed,this)}.bind(this))},messages_Changed:function(e){switch(e.action){case o.CollectionAction.Add:this.onMessagesAdded(e);break;case o.CollectionAction.Remove:this.onMessagesRemoved(e);break;case o.CollectionAction.Replace:break;case o.CollectionAction.Reset:}},onMessagesAdded:function(e){e.newStartingIndex>=this.messages.length()-1?this.addMessagesToBottom(e.newItems):this.addMessagesToTop(e.newItems)},onMessagesRemoved:function(e){var t,n,i,s;if(0===this.messages.length())this.messageDayGroups.clear();else for(t=0;t<e.oldItems.length;t++)n=e.oldItems[t],i=g(n.getCreateDate()),s=this.messageDayGroups.find(function(e){return e.day.valueOf()==i.valueOf()}),null!==s?1===s.messages.length()?this.messageDayGroups.remove(s):s.messages.remove(n):c.debug("day group for message was not found.")},addMessagesToBottom:function(e){var t,n,i,s,o=this.messageDayGroups.last();if(null!==o){for(s=o.messages.last(),i=0;i<e.length&&(t=e[i],u(s,t));i++)o.messages.push(t);e=i<e.length?e.slice(i):[]}0!=e.length&&(n=f(e),this.messageDayGroups.push(n))},addMessagesToTop:function(e){var t,n,i,s,o=this.messageDayGroups.first();if(null!==o){for(s=o.messages.first(),i=e.length-1;i>-1&&(t=e[i],u(s,t));i--)o.messages.unshift(t);e=i>-1?e.slice(0,i+1):[]}0!=e.length&&(n=f(e),this.messageDayGroups.unshift(n))},onContactRedirectDestinationUser:function(e){d.onContactRedirectDestinationUser({message:e})},isOutgoingMessage:function(e){return d.currentUser.Profiles.containsById(e.getAuthorId())},onResendMessages:function(e){d.onResendMessages({messages:e})},onDeleteMessages:function(e){d.onDeleteMessages({messages:e})}});return new v}])}(window),function(e){"use strict";e.realineMessenger.controller("ConversationParticipantsPickerController",["messengerUserService","messenger","messengerHub","MessengerEnums","CoreEnums","BusyIndicator","UserModel","utils","errorMessageProvider","hubConnection","$scope","$log","$timeout","$q",function(e,t,n,i,s,o,r,a,d,c,l,u,h,g){var f=Class.extend({init:function(e){this.scope=e,this.scope.controller=this,this.currentContextGlobalMasterId=null,this.busyIndicator=new o,this.scope.selectedUsers={selected:this.scope.conversation.getParticipants(!0)},this.participants={},this.participants[this.scope.currentUser.getId()]=!0,this.registerParticipant(this.scope.selectedUsers.selected),this.bindEvents(),this.loadData()},bindEvents:function(){this.scope.$on("$destroy",function(){this.onDestroy()}.bind(this)),this.scope.conversation.Participants.bindCollectionChanged(this.Participants_Changed,this)},onDestroy:function(){this.scope.conversation.Participants.unbindCollectionChanged(this.Participants_Changed,this)},Participants_Changed:function(e){switch(e.action){case s.CollectionAction.Add:this.onParticipantAdded(e);break;case s.CollectionAction.Remove:this.onParticipantRemoved(e);break;case s.CollectionAction.Replace:}},onParticipantAdded:function(e){var t,n,i;for(t=0;t<e.newItems.length;t++)i=e.newItems[t],n=this.scope.selectedUsers.selected.findIndex(function(e){return e.getId()===i.getId()},this),0>n&&(this.scope.selectedUsers.selected.push(i),this.registerParticipant(i))},onParticipantRemoved:function(e){var t,n,i;for(t=0;t<e.oldItems.length;t++)i=e.oldItems[t],n=this.scope.selectedUsers.selected.findIndex(function(e){return e.getId()===i.getId()},this),n>-1&&(this.scope.selectedUsers.selected.splice(n,1),this.unregisterParticipant(i))},registerParticipant:function(e){if(angular.isArray(e))for(var t=0;t<e.length;t++)this.participants[e[t].getGroupId()]=!0;else this.participants[e.getGroupId()]=!0},unregisterParticipant:function(e){if(angular.isArray(e))for(var t=0;t<e.length;t++)delete this.participants[e[t].getGroupId()];else delete this.participants[e.getGroupId()]},isRegisteredUser:function(e){return this.participants.hasOwnProperty(e.getId())},isRegisteredProfile:function(e){return this.participants.hasOwnProperty(e.getGroupId())},buildContactList:function(e){var t,n,i,s=[];for(t=0;t<e.length;t++)n=e[t],this.isRegisteredUser(n)||(i=this.findAllowedProfiles(n),Array.prototype.push.apply(s,i));return s},findAllowedProfiles:function(e){var t,n;return null===this.currentContextGlobalMasterId?e.Profiles.cloneArray():1===e.Profiles.length()?[e.Profiles.get(0)]:(n=e.Profiles.find(function(e){return e.getContextGlobalMasterId()===this.currentContextGlobalMasterId},this),null!==n?[n]:t=e.Profiles.filter(function(e){return e.getMessengerProfileType()===i.MessengerProfileType.Company},this))},buildUserList:function(){return[]},adjustUsersList:function(){l.users=this.buildUserList()},refreshUsers:function(t){var n={Skip:0,Count:20,SearchString:t};e.searchUsers(n).then(function(e){if(!e.data.Status)return void u.error("Failed to load users. "+d.getApiErrorMessage(e.data));var t=e.data.Model.List.map(function(e){return new r(e)});l.users=this.buildContactList(t)}.bind(this),function(e){u.error("Failed to load users by keyword."+e)})},onUserSelected:function(e,t){l.users=[],this.adjustUsersList(),this.busyIndicator.begin(),this.onAddParticipant(t).then(function(){this.registerParticipant(t)}.bind(this),function(e){var n=this.scope.selectedUsers.selected.findIndex(function(e){return e.getId()===t.getId()},this);n>-1&&this.scope.selectedUsers.selected.splice(n,1)}.bind(this))["finally"](function(){this.busyIndicator.end()}.bind(this))},onUserRemoved:function(e,t){this.adjustUsersList(),this.busyIndicator.begin(),this.onRemoveParticipant(t).then(function(){this.unregisterParticipant(t)}.bind(this),function(){this.scope.selectedUsers.selected.push(t)}.bind(this))["finally"](function(){this.busyIndicator.end()}.bind(this))},onAddParticipant:function(e){var t={ConversationId:this.scope.conversation.getId(),ParticipantsProfileIds:[e.getId()]};return n.addParticipants(t).then(function(e){}.bind(this),function(e){return u.error("Failed to add participants to conversation. "+e),g.reject(e)})},onRemoveParticipant:function(e){return n.removeParticipant(this.scope.conversation.getId(),e.getId()).then(function(){},function(e){return u.error("Failed to remove participant from conversation. "+e),g.reject(e)})},getSelectedUsers:function(){return this.scope.selectedUsers.selected},canManageUsers:function(){return this.scope.conversation?this.busyIndicator.isBusy()?!1:this.isConnected()&&this.scope.conversation.isJoinedConversation():!1},isConnected:function(){return c.getState()!==s.HubConnectionState.Connected?!1:!0},loadData:function(){l.updating=!1,this.adjustUsersList()}});return new f(l)}])}(window),function(e){"use strict";e.app.controller("ConversationTagsDialogController",["conversation","BasePopupController","conversationTagService","messengerHub","MessengerEnums","CoreEnums","$scope","$log","$q","$uibModalInstance","$","utils",function(e,t,n,i,s,o,r,a,d,c,l,u){var h=t.extend({init:function(t){this._super(t,c),this.conversation=e,this.tags=n.getTags().filter(function(e){return e.getTagType()===s.TagType.CustomFolder}),this.conversationTags={selected:this.conversation.Tags.filter(function(e){return e.getTagType()===s.TagType.CustomFolder})},n.getTags().bindCollectionChanged(this.tags_Changed,this)},apply:function(){var e=this.conversationTags.selected.filter(function(e){return!this.conversation.Tags.containsById(e.getId())},this),t=this.conversation.Tags.filter(function(e){return e.getTagType()===s.TagType.CustomFolder&&this.conversationTags.selected.indexOf(e)<0},this),n=this.conversationTags.selected.map(function(e){return e.getId()}),o=this.conversation.Tags.filter(function(e){return e.getTagType()!==s.TagType.CustomFolder}).map(function(e){return e.getId()});return Array.prototype.push.apply(n,o),0===e.length&&0===t.length?void c.close():(this.updating=!0,void i.tagConversation({ConversationId:this.conversation.getId(),FolderIds:n}).then(function(){c.close()},function(e){a.debug("Failed to tagConversation. "+e)})["finally"](function(){this.updating=!1}.bind(this)))},createTag:function(){this.$scope.tag.$valid&&(this.entity={DisplayName:this.newTagName,FolderType:s.TagType.CustomFolder},this.updating=!0,i.saveTag(this.entity).then(function(){this.newTagName=null}.bind(this),function(e){a.error("Failed to save folder."+e)})["finally"](function(){this.entity=null,this.updating=!1}.bind(this)))},tags_Changed:function(e){switch(e.action){case o.CollectionAction.Add:this.onTagsAdded(e);break;case o.CollectionAction.Remove:this.onTagsRemoved(e)}},onTagsAdded:function(e){var t;Array.prototype.push.apply(this.tags,e.newItems),this.entity&&(t=e.newItems.findItem(function(e){return e.getDisplayName()===this.entity.DisplayName},this),null!==t&&this.conversationTags.selected.push(t))},onTagsRemoved:function(e){l.each(function(e,t){this.tags.removeElement(t),this.conversationTags.selected.removeElement(t)}.bind(this))},onDestroy:function(){n.getTags().unbindCollectionChanged(this.tags_Changed,this)}});return new h(r)}])}(window),function(e){"use strict";e.app.controller("FileUploaderContainerController",["$scope","$log","MessengerEnums","CoreEnums","events","utils","Domains","CrossDomainStorage","authConstants","Upload","customHeaders","errorMessageProvider","fileHelper",function(t,n,i,s,o,r,a,d,c,l,u,h,g){function f(e){var t,n="";for(var i in e)if(angular.isArray(e[i]))for(t=0;t<e[i].length;t++)n&&(n+="&"),n+=String.format("{0}={1}",i,encodeURIComponent(e[i][t]));else n&&(n+="&"),n+=String.format("{0}={1}",i,encodeURIComponent(e[i]));return n}function p(e,t){e.thumbnail=t.ResizedImages.findItem(function(e){return"small"===e.Size})}var m=a.MessengerImagesStorage+"/api/imagestorage/save/messenger",v=a.MessengerDocumentStorage+"/api/Document/Post",C=a.MessengerDocumentStorage+"/api/document/getByGlobalUnitId?globalUnitId={0}",y="1.0.0.0",b={Public:0,OnlyForAllowed:1,OnlyForMe:2},S=Class.extend({init:function(e){this.__ClassName="FileUploaderContainerController",this.scope=e,this.scope.controller=this,this.initController(),this.bindEvents()},bindEvents:function(){this.scope.$on("$destroy",function(){}.bind(this))},initController:function(){},uploadFiles:function(e,t){return d.get(c.localStorage).then(function(t){this.uploadFilesInternal(e,t.value)}.bind(this),function(e){n.debug("Failed to get token. "+e)})},uploadFilesInternal:function(t,i){e.angular.forEach(t,function(e){var t;e.isImage=g.isImage(e.name),t={url:this.buildUploadUrl(e),data:{file:e},headers:{}},t.headers[u.version]=y,t.headers[c.header]=i,e.upload=l.upload(t),e.upload.then(function(t){e.isImage?(e.result=t.data.Model,p(e,t.data.Model)):e.result={FileId:t.data.Model,FileUrl:String.format(C,t.data.Model)}},function(t){t.status>0&&(e.errorMsg=t.status+": "+h.getApiErrorMessage(t.data)),n.debug(String.format("Failed to upload file {0}. Error: {1}",e.name,JSON.stringify(t.data)))},function(t){e.progress=Math.min(100,parseInt(100*t.loaded/t.total))}),this.scope.files.push(e)},this)},buildUploadUrl:function(e){return e.isImage?this.buildImageUploadUrl(e):this.buildDocumentUploadUrl(e)},buildImageUploadUrl:function(e){return m},buildDocumentUploadUrl:function(e){var t=this.buildDocumentUploadRequest(e),n=f(t);return v+"?"+n},buildDocumentUploadRequest:function(e){var t={Filename:e.name,FileAccessType:b.Public};return t},onRemoveFile_Click:function(e){this.scope.files.removeElement(e)}});return new S(t)}])}(window),function(e){"use strict";e.realineMessenger.controller("MessengerBodyController",["$scope","$q",function(e,t){Class.extend({init:function(e){this._super(e)},load:function(){this._super()}})}])}(window),function(e){"use strict";e.realineMessenger.controller("MessengerPageController",["$scope","$q","$log","$timeout","BaseController","extendApplier","messenger","ObservableCollection","EntityCollection","MessengerEnums","CoreEnums","events","messageBus","utils",function(e,t,n,i,s,o,r,a,d,c,l,u,h,g){var f=s.extend({init:function(e){this._super(e),this.currentUser=null,this.isMuteAllConversations=!1,this.tabs=new a,this.bindEvents(),this.messagesTab={isMessagesTab:!0},this.tabs.push(this.messagesTab)},load:function(){this._super(),r.getCurrentUser().then(function(e){this.currentUser=e}.bind(this))},bindEvents:function(){this.tabs.bindCollectionChanged(this.Tabs_Changed,this),h.bind(u.conversationOpen,this.onRemoteConversationOpen,this),h.bind(u.closeAllChatTabs,this.onCloseAllChatTabs,this),h.bind(u.muteAllConversationsChanged,this.onMuteAllConversationsChanged,this),h.bind(u.activeFolderChanged,this.onActiveFolderChanged,this)},onDestroy:function(){h.detach(u.conversationOpen,this.onRemoveConversationOpen,this),h.detach(u.closeAllChatTabs,this.onCloseAllChatTabs,this),h.detach(u.muteAllConversationsChanged,this.onMuteAllConversationsChanged,this),h.detach(u.activeFolderChanged,this.onActiveFolderChanged,this)},isActiveTab:function(e){return e===this.activeTab},setActiveTab:function(e){this.activeTab=e},onTabClick:function(e){this.isActiveTab(e)||this.setActiveTab(e)},onTabCloseClick:function(e,t){var i=this.tabs.findIndex(function(t){return t===e},this);return 0>i?void n.debug("Tab was not found for closing."):(this.tabs.removeAt(i),void t.preventDefault())},Tabs_Changed:function(e){switch(e.action){case l.CollectionAction.Add:this.onTabAdded(e);break;case l.CollectionAction.Remove:this.onTabsRemoved(e);break;case l.CollectionAction.Move:}},onTabAdded:function(e){e.newItems.length===this.tabs.length()&&this.setActiveTab(e.newItems[0])},onTabsRemoved:function(e){var t=e.oldItems.findIndex(function(e){return this.isActiveTab(e)},this);0>t||(t+=e.oldStartingIndex,t>=this.tabs.length()&&(t=0===this.tabs.length()?null:this.tabs.length()-1),null===t?this.setActiveTab(null):this.setActiveTab(this.tabs.get(t)))},onConversationOpen:function(e){var t=this.tabs.find(function(t){return t.conversation&&t.conversation.getId()===e.getId()},this);return null===t&&(t={conversation:e},this.tabs.push(t)),null!==t?void this.setActiveTab(t):void 0},onRemoteConversationOpen:function(e){this.onConversationOpen(e.conversation)},onCloseAllChatTabs:function(e){this.tabs.length()>1&&this.tabs.removeAt(1,this.tabs.length()-1)},onMuteAllConversationsChanged:function(e){this.isMuteAllConversations=e.value},mustFlashTab:function(e){return e.conversation.hasUnreadMessages()&&!this.isMuteAllConversations&&!e.conversation.getIsMuted()&&!this.isActiveTab(e)},onActiveFolderChanged:function(e){this.setActiveTab(this.messagesTab)}});o.applyFn.bind(this,f,e)()}])}(window),function(e){"use strict";e.realineMessenger.controller("MessengerFoldersController",["messengerHub","hubConnection","messageBus","TagModel","UniqueEntityCollection","MessengerEnums","CoreEnums","utils","events","observable","conversationTagService","conversationProviderService","$scope","$log","$uibModal","$timeout",function(e,t,n,i,s,o,r,a,d,c,l,u,h,g,f,p){var m=500,v=Class.extend({init:function(e){this.__ClassName="MessengerFoldersController",this.scope=e,this.scope.controller=this,this.inboxFolder=null,this.starredFolder=null,this.draftFolder=null,this.archiveFolder=null,this.activeFolder=null,this.scope.foldersTreeExpanded=!0,this.tags=l.getTags(),this.customFolders=[],this.countersUpdateTimer=null,this.bindEvents(),this.isConnected()&&this.loadTags()},isActiveFolder:function(e){return this.activeFolder===e},onFolder_Click:function(e){this.activeFolder=e},loadTags:function(){return l.loadTags()},bindEvents:function(){this.tags.bindCollectionChanged(this.tags_Changed,this),t.bindStateChanged(this.onConnectionStateChanged,this),e.bindTagSaved(this.onTagSaved,this),e.bindTagDeleted(this.onTagDeleted,this),e.bindConversationTagged(this.onConversationTagged,this),u.bindCacheChanged(this.onConversationCacheChanged,this),this.scope.$watch("controller.activeFolder",this.onActiveFolderChanged),this.scope.$on("$destroy",this.onDestroy.bind(this))},onDestroy:function(){null!==this.countersUpdateTimer&&p.cancel(this.countersUpdateTimer),this.tags.unbindCollectionChanged(this.tags_Changed,this),t.unbindStateChanged(this.onConnectionStateChanged,this),e.unbindTagSaved(this.onTagSaved,this),e.unbindTagDeleted(this.onTagDeleted,this),e.unbindConversationTagged(this.onConversationTagged,this),u.unbindCacheChanged(this.onConversationCacheChanged,this)},onActiveFolderChanged:function(e){n.fire({type:d.activeFolderChanged,folder:e})},tags_Changed:function(e){switch(e.action){case r.CollectionAction.Add:this.onTagsAdded(e);break;case r.CollectionAction.Remove:this.onTagsRemoved(e)}},onTagsAdded:function(e){this.inboxFolder||(this.inboxFolder=this.findInboxFolder(),this.activeFolder||(this.activeFolder=this.inboxFolder)),this.starredFolder||(this.starredFolder=this.findStarredFolder()),this.draftFolder||(this.draftFolder=this.findDraftFolder()),this.archiveFolder||(this.archiveFolder=this.findArchiveFolder()),this.customFolders=this.findCustomFolders()},onTagsRemoved:function(e){this.inboxFolder&&(this.inboxFolder=this.findInboxFolder()),this.starredFolder&&(this.starredFolder=this.findStarredFolder()),this.draftFolder&&(this.draftFolder=this.findDraftFolder()),this.archiveFolder&&(this.archiveFolder=this.findArchiveFolder()),this.activeFolder&&(this.tags.containsById(this.activeFolder.getId())||(this.activeFolder=this.inboxFolder)),this.customFolders=this.findCustomFolders()},onConnectionStateChanged:function(e){e.newState===r.HubConnectionState.Connected&&this.loadTags()},onTagSaved:function(e){var t,n;n=this.tags.findById(e.data.Id),t=new i(e.data),n?(n.setDisplayName(t.getDisplayName()),n.setUnreadConversationsCount(t.getUnreadConversationsCount())):this.tags.push(t)},onTagDeleted:function(e){this.tags.removeById(e.data.FolderId)},onConversationTagged:function(e){var t=u.get(e.data.ConversationId);if(t){var n,i,s=e.data.FolderIds.filter(function(e){return!t.Tags.containsById(e)},this),o=t.Tags.filter(function(t){return e.data.FolderIds.indexOf(t.getId())<0},this),r=[];for(n=0;n<s.length;n++)i=this.tags.findById(s[n]),null!==i?r.push(i):g.debug("Tag not found "+s[n]);for(n=0;n<o.length;n++)t.Tags.remove(o[n]);for(n=0;n<r.length;n++)t.Tags.push(r[n]);if(t.hasUnreadMessages()){for(n=0;n<o.length;n++)o[n].decUnreadConversationsCount();for(n=0;n<r.length;n++)r[n].incUnreadConversationsCount()}}else this.loadTags()},onCreateTag_Click:function(){f.open({templateUrl:"/Application/Modules/Messenger/Html/TagEditDialog.html",controller:"TagEditDialogController",size:"smm",backdrop:!1,resolve:{entity:null}})},onEditTag_Click:function(e){f.open({templateUrl:"/Application/Modules/Messenger/Html/TagEditDialog.html",controller:"TagEditDialogController",size:"smm",backdrop:!1,resolve:{entity:e}})},onDeleteTag_Click:function(e){f.open({templateUrl:"/Application/Modules/Messenger/Html/TagDeleteDialog.html",controller:"TagDeleteDialogController",size:"smm",backdrop:!1,resolve:{entity:e}})},isConnected:function(){return t.getState()!==r.HubConnectionState.Connected?!1:!0},findPredefinedFolder:function(e){return this.tags.find(function(t){return t.getTagType()===e},this)},findInboxFolder:function(){return this.findPredefinedFolder(o.TagType.Inbox)},findStarredFolder:function(){return null},findDraftFolder:function(){return this.findPredefinedFolder(o.TagType.Draft)},findArchiveFolder:function(){return this.findPredefinedFolder(o.TagType.Archive)},findCustomFolders:function(){var e=this.tags.filter(function(e){return e.getTagType()===o.TagType.CustomFolder},this);return e.sort(function(e,t){return e.getDisplayName()<t.getDisplayName()?-1:e.getDisplayName()>t.getDisplayName()?1:0}),e},onConversationCacheChanged:function(e){switch(e.action){case o.CacheAction.Add:this.onConversationCache_Added(e);break;case o.CacheAction.Remove:this.onConversationCache_Removed(e)}},onConversationCache_Added:function(e){c.bindPropertyChanged(e.items,this.Conversation_PropertyChanged,this);var t=e.items.findItem(function(e){return e.hasUnreadMessages()},this);null!==t&&this.updateCounters()},onConversationCache_Removed:function(e){c.unbindPropertyChanged(e.items,this.Conversation_PropertyChanged,this)},Conversation_PropertyChanged:function(e){e.property===o.PropertyNames.UnreadMessagesCount&&(0===e.oldValue&&e.newValue>0?e.target.Tags.forEach(function(e){e.incUnreadConversationsCount()}):e.oldValue>0&&0===e.newValue&&e.target.Tags.forEach(function(e){e.decUnreadConversationsCount()}))},updateCounters:function(){null!==this.countersUpdateTimer&&p.cancel(this.countersUpdateTimer),this.countersUpdateTimer=p(function(){this.loadTags()}.bind(this),m)}});return new v(h)}])}(window),function(e){"use strict";e.realineMessenger.controller("MessengerPanelController",["$scope","$log","$window","$","$uibModal","$q","messenger","hubConnection","messengerHub","notificationHub","UserModel","$rootScope","MessageModel","ConversationModel","TagModel","ObservableCollection","EntityCollection","UniqueEntityCollection","MessengerEnums","MessengerConstants","messengerUserService","events","messageBus","contactsCacheService","profileCacheService","currentCompanyService","CoreEnums","utils","observable","conversationService","conversationProviderService","businessObjectService","currentStreamsService","messengerSettingsService","floatingWindowBuilder","errorMessageProvider","conversationTagService",function(e,t,n,i,s,o,r,a,d,c,l,u,h,g,f,p,m,v,C,y,b,S,M,P,I,w,T,R,A,U,D,N,E,x,k,O,F){function z(e){switch(e){case C.UserStatuses.Offline:return"Offline";case C.UserStatuses.Online:return"Online";case C.UserStatuses.Away:return"Away";case C.UserStatuses.Busy:return"Busy"}}function V(e){var t;return angular.isObject(e)?"ProfileModel"===e.__ClassName?(t=o.defer(),t.resolve(e),t.promise):(t=o.defer(),P.getp(e.GlobalIndexUserId).then(function(n){var i;i=R.common.isNullOrUndefined(e.CompanyId)?n.Profiles.find(function(e){return e.getMessengerProfileType()===C.MessengerProfileType.User}):n.Profiles.find(function(t){return t.getContextGlobalMasterId()===e.CompanyId}),R.common.isNullOrUndefined(i)?t.reject("Not found"):t.resolve(i)},function(e){t.reject(e)}),t.promise):I.getp(e)}function H(e,t){var n=o.defer();return P.getp(e).then(function(e){var i=e.Profiles.find(function(e){return e.getContextGlobalMasterId()===t});R.common.isNullOrUndefined(i)?n.reject("Not found"):n.resolve(i)},function(e){n.reject(e)}),n.promise}var L,B=10,q=20,j=1,G=100,$=5,W=R.common;return L=Class.extend({init:function(e){this.scope=e,this.scope.controller=this,e.messenger=this,this.user=null,this.currentCompanyId=null,this.userSettings={Settings:{}},this.currentUserStatus=C.UserStatuses.Offline,this.newUserStatus=null,e.friends=r.getFriends(),e.colleagues=r.getColleagues(),e.conversations=U.getList(),this.pendingConversations=U.getPending(),this.openedConversations=new m,this.conversationOpenedOnPage=null,e.recentConversations=[],this.requestCorrelationIds={},this.privateConversationRequests={},e.businessConversations=new v,e.streamConversations=new v,this.isInitialized=!1,this.wasConnected=!1,this.bindMessengerEvents(),this.bindEvents()},initContainer:function(){r.getCurrentUser().then(function(n){this.user=n,e.currentUser=this.user,this.currentCompanyId=null,D.setUser(this.user),a.connect().then(function(){this.wasConnected=!0,this.loadFriends().then(function(t){return e.friends.push(t),this.loadColleagues()}.bind(this)).then(function(t){e.colleagues.push(t)}.bind(this)).then(function(){this.updateContactsStatuses(),this.isInitialized=!0}.bind(this))}.bind(this),function(e){t.debug("Failed to connect to messenger server. "+e)}.bind(this))}.bind(this))},deinitContainer:function(){a.disconnect(),this.wasConnected=!1,e.currentUser=null,this.user=null,this.newUserStatus=null,P.clear(),I.clear(),e.businessConversations.clear(),e.streamConversations.clear(),this.openedConversations.clear(),U.clear(),D.clear(),F.clear(),this.requestCorrelationIds={},this.privateConversationRequests={},this.wasConnected=!1,r.logout()},onLoggedIn:function(){this.deinitContainer(),this.initContainer()},onLoggedOut:function(){this.deinitContainer()},isIntermediateConectionState:function(){return this.ConnectionState!==T.HubConnectionState.Connected&&this.ConnectionState!==T.HubConnectionState.Disconnected?!0:!1},onConversationClick:function(e){this.isInitialized&&this.openConversation(e)},openConversation:function(e,t){var n=null;t&&(n=t.messageText),M.fire({type:S.conversationOpen,conversation:e,messageText:n})},openMessage:function(e){var t=D.get(e.getConversationId());this.user.Profiles.containsById(e.getAuthorId())||e.isNotificationMessage()||this.isConversationOpened(t)||this.userSettings.Settings.Mute||t.getIsMuted()||M.fire({type:S.newMessageReceived,message:e})},addConversation:function(t,n){D.put(t),0!==t.Messages.length()&&(n?e.conversations.unshift(t):e.conversations.push(t))},isConversationOpened:function(e){return R.common.isNullOrUndefined(this.conversationOpenedOnPage)||this.conversationOpenedOnPage!==e?this.openedConversations.indexOf(e)>-1?!0:!1:!0},conversationCount:function(){return e.conversations.count()},onContactClick:function(e){this.ConnectionState===T.HubConnectionState.Connected&&this.isInitialized&&this.openPrivateConversation(e)},onCreateConversationClick:function(){this.createConversationWndPromise||(this.createConversationWndPromise=k.open({controller:"CreateConversationDialogController",templateUrl:"/Application/Modules/Messenger/Html/CreateConversationDialog.html",params:{createConversationCallback:this.createGroupConversation2.bind(this)}}).then(function(e){e.closed.then(function(){this.createConversationWndPromise=null}.bind(this))}.bind(this),function(e){t.debug("Failed to open CreateConversationDialog")}))},openPrivateConversation:function(e,n){this.privateConversationRequests.hasOwnProperty(e.getId())||(this.privateConversationRequests[e.getId()]={},this.findPrivateConversation(e.getId()).then(function(t){return R.common.isNullOrUndefined(t)?this.createPrivateConverstion(e.getId(),n):(this.openConversation(t,n),t)}.bind(this),function(e){return t.error("Failed to find conversation on server. "+e),o.reject(e)}).then(function(e){},function(e){t.error("Failed to create conversation on server. "+e)})["finally"](function(){delete this.privateConversationRequests[e.getId()]}.bind(this)))},findPrivateConversation:function(e){var t={OtherUserId:e,GetUnreadOnly:!1,MessagesPerConversation:j};return D.loadPrivateConversation(t)},createPrivateConverstion:function(e,n){r.getCurrentProfile().then(function(t){this.createPrivateConverstionInternal(e,n,t)}.bind(this),function(e){t.debug("Failed to get current global user. "+e)})},createPrivateConverstionInternal:function(e,t,n){var i=R.common.newGuid();this.requestCorrelationIds[i]=t;var s=[e,n.getId()],r={RequestId:i,DisplayName:null,Participants:s,Type:C.ConversationType.Private,Message:null};return d.createConversation(r)["catch"](function(e){return delete this.requestCorrelationIds[i],o.reject(e)}.bind(this))["finally"](function(){}.bind(this))},createGroupConversation:function(e){var t=R.common.newGuid();this.requestCorrelationIds[t]={};var n={RequestId:t,DisplayName:null,Participants:e.participants,Type:C.ConversationType.Group,ParentConversationId:e.parentConversationId?e.parentConversationId:null,Message:null};return d.createConversation(n)["finally"](function(){delete this.requestCorrelationIds[t]}.bind(this))},createGroupConversation2:function(e){return e.RequestId=R.common.newGuid(),this.requestCorrelationIds[e.RequestId]={},d.createConversation(e)["finally"](function(){}.bind(this))},loadConversations:function(){return this.loadUnreadConversationsOnly().then(function(e){return this.loadRegularConversations(e)}.bind(this))},loadRegularConversations:function(e){var t={Skip:0,Take:Math.max(q,e.length),GetUnreadOnly:!1,MessagesPerConversation:j},n=o.defer();return this.loadRegularConversationsInternal(t,e,n),n.promise},loadRegularConversationsInternal:function(n,i,s){D.loadConversations(n).then(function(t){return e.conversations.push(t),0===i.length?void s.resolve(e.conversations.length()):e.conversations.containsById(i[i.length-1].getId())?void s.resolve(e.conversations.length()):(n.Take=q,n.Skip=e.conversations.length(),void this.loadRegularConversationsInternal(n,i,s))}.bind(this),function(e){t.error("Failed to get list of regular conversations. "+e),s.reject(e)})},loadUnreadConversationsOnly:function(){var e={Skip:0,Take:q,GetUnreadOnly:!0,MessagesPerConversation:j},t=o.defer(),n=[];return this.loadConversationsInternal(e,n,t),t.promise},loadConversationsInternal:function(e,n,i){D.loadConversations(e).then(function(t){Array.prototype.push.apply(n,t),t.length===e.Take?(e.Skip=n.length,this.loadConversationsInternal(e,n,i)):i.resolve(n)}.bind(this),function(e){t.error("Failed to get list of unread conversations. "+e),i.reject(e)})},loadUnreadConversations:function(){var e={Skip:0,Count:q,GetUnreadOnly:!0,MessagesPerConversation:j},t=[];this.loadUnreadConversationsInternal(e,t)},loadUnreadConversationsInternal:function(e,n){d.getConversations(e).then(function(t){var i,s;for(i=0;i<t.Conversations.length;i++)s=D.get(t.Conversations[i].Id),s?this.updateConversation(s,t.Conversations[i]):(s=new g(t.Conversations[i],this.user),this.addConversation(s,!0));t.Conversations.length>0&&Array.prototype.push.apply(n,t.Conversations),t.Conversations.length===e.Take&&(e.Skip=n.length,this.loadUnreadConversationsInternal(e,n))}.bind(this),function(e){t.error("Failed to get list of conversations. "+e)})},updateConversation:function(e,t){var n,i,s=t.ParticipantProfileIds.filter(function(t){return null===e.Participants.findById(t)});s.length>0&&(s=s.map(function(e){return I.get(e)}),e.Participants.push(s)),e.setDisplayName(t.DisplayName),0!==t.Messages.length&&(0===e.Messages.length()?n=t.Messages:(i=e.Messages.get(e.Messages.length()-1),n=t.Messages.filter(function(e){return e.CreateDate>i.getCreateDate()||e.CreateDate===i.getCreateDate()&&e.Id!==i.getId()})),n.length>0&&(n=n.map(function(e){return new h(e)}),e.Messages.push(n)))},loadFriends:function(){var e=o.defer(),t=[],n={Skip:0,Take:200};return this.loadFriendsInternal(n,e,t),e.promise},loadFriendsInternal:function(e,n,i){b.searchUsers(e).then(function(s){if(!s.data.Status)return t.error("Failed to load friends. "+O.getApiErrorMessage(s.data)),void n.reject(s);var o=s.data.Model.List.map(function(e){return P.putRaw(e)});o.length>0&&Array.prototype.push.apply(i,o),i.length<s.data.Model.RowCount?(e.Skip=i.length,this.loadFriendsInternal(e,n,i)):(i=_.sortBy(i,function(e){return e.getName()}),n.resolve(i))}.bind(this),function(e){n.reject(e)})},loadColleagues:function(){var e;return this.currentCompanyId=w.getCurrentCompanyId(),void 0===this.currentCompanyId&&(this.currentCompanyId=null),R.common.isNullOrUndefined(this.currentCompanyId)?(e=o.defer(),e.resolve([]),e.promise):this.loadColleaguesByCompany(this.currentCompanyId)},loadColleaguesByCompany:function(e){var t=o.defer(),n=[];this.currentCompanyId=e;var i={Skip:0,Count:100,CompanyGlobalId:e};return this.loadColleaguesInternal(i,t,n),t.promise},loadColleaguesInternal:function(e,n,i){b.getCompanyUsers(e).then(function(s){if(!s.data.Status)return t.error("Failed to load company users. "+O.getApiErrorMessage(s.data.Message)),void n.reject(s);var o=s.data.Model.List.map(function(e){return P.putRaw(e)});if(o.length>0&&Array.prototype.push.apply(i,o),i.length<s.data.Model.RowCount)e.Skip=i.length,this.loadColleaguesInternal(e,n,i);else{var r=i.findItem(function(e){return e.getId()===this.user.getId()},this);null!==r&&i.removeElement(r),i=_.sortBy(i,function(e){return e.getName()}),n.resolve(i)}}.bind(this),function(e){n.reject(e)})},getUserStatuses:function(e){var n=e.map(function(e){return e.getId()});d.getUserStatuses(n).then(function(t){var n,i;for(n in t)i=e.findItem(function(e){return e.getId()===n}),i.setStatus(t[n])}.bind(this),function(e){t.error("Failed to get users statuses."+e)})},updateContactsStatuses:function(){for(var e,t,n=this.getAllContacts(),i=0;i<n.length;)t=Math.min(i+G,n.length),e=n.slice(i,t),i+=G},updateContacts:function(){
return this.loadFriends().then(function(t){return this.updateUserList(t,e.friends),this.loadColleagues()}.bind(this),function(e){return t.debug("Failed to load friends. "+e),o.reject(e)}).then(function(t){this.updateUserList(t,e.colleagues)}.bind(this),function(e){return t.debug("Failed to load colleagues. "+e),o.reject(e)})},updateUserList:function(e,t){var n,i,s;for(i=e.filter(function(e){return!t.containsById(e.getId())}),s=t.filter(function(t){return null===e.findItem(function(e){return e.getId()===t.getId()})}),n=0;n<s.length;n++)t.removeById(s.getId());for(n=0;n<i.length;n++)t.insertSorted(i[n],function(e){return e.getName()})},getAllContacts:function(){var t=e.friends.list.concat(e.colleagues.list);return t.filterDuplicates(function(e){return e.getId()})},getUnreadConversationsCount:function(){var t=e.conversations.filter(function(e){return e.hasUnreadMessages()});return t.length},loadConversation:function(e,n){var i={ConversationId:e,GetUnreadOnly:!1,MessagesPerConversation:j};return D.loadConversation(i).then(null,function(n){return t.error(String.format("Failed to load converation {0}. Error: {1}",e,n)),o.reject(n)})},onCreateBusinessObjectConversation:function(e){r.getCurrentProfile().then(function(t){this.onCreateBusinessObjectConversationInternal(e,t)}.bind(this),function(e){t.debug("Failed to load current global user. "+e)})},onCreateBusinessObjectConversationInternal:function(e,t){if(this.ConnectionState===T.HubConnectionState.Connected){if(W.isNullOrUndefined(e.data.businessObjectType)||W.isNullOrUndefined(e.data.businessObjectId)||W.isNullOrUndefined(e.data.businessTransactionId))throw new Error("Invalid CreateBusinessObjectConversation request.");var n=n=new g({Id:null,DisplayName:null,Participants:[t.getId()],Messages:[],BusinessObjecType:e.data.businessObjectType,BusinessObjecId:e.data.businessObjectId,BusinessTransactionId:e.data.businessTransactionId,Type:C.ConversationType.Public},this.user);this.pendingConversations.push(n),this.openConversation(n)}},onCreateCustomConversation:function(e){if(this.ConnectionState===T.HubConnectionState.Connected){var t,n=e.data.messageText;e.data.type===C.ConversationType.Private?V(e.data.participants[0]).then(function(e){this.openPrivateConversation(e,{messageText:n})}.bind(this)):(t={displayName:e.data.displayName,participants:e.data.participants,parentConversationId:e.data.parentConversation?e.data.parentConversation.getId():null},this.createGroupConversation(t))}},onCreateStreamConversation:function(e){H(e.data.SubscriberMasterUserId,e.data.Stream.CompanyId).then(function(t){this.createStreamConversation(t,e.data.Stream,e.data.CompanyName)}.bind(this),function(n){t.debug(String.format("Failed to load subscriber global user (master:{0}, company:{1}). {2}"),n,e.data.SubscriberMasterUserId,e.data.Stream.CompanyId)})},createStreamConversation:function(e,n,i){r.getCurrentProfile().then(function(t){this.createStreamConversationInternal(e,n,i,t)}.bind(this),function(e){t.debug("Failed to load current global user. "+e)})},createStreamConversationInternal:function(e,t,n,i){var s=String.format("{0} ({1})",t.Name,n?n:e.getContextName()),o=new g({DisplayName:s,Participants:[e,i],Type:C.ConversationType.Group,BusinessObjecType:y.StreamObjectType,BusinessObjecId:t.GlobalId},this.user);this.pendingConversations.push(o),this.openConversation(o)},onOpenChildConversation:function(e){var t=D.get(e.data.conversationId);return t?void this.openConversation(t):void this.loadConversation(e.data.conversationId).then(function(e){R.common.isNullOrUndefined(e)||(this.addConversation(e),this.openConversation(e))}.bind(this))},onConversationOpenedOnPage:function(e){this.conversationOpenedOnPage=e.data.conversation},onConversationOpen:function(e){this.openedConversations.push(e.conversation)},onCloseConversation:function(e){R.common.isNullOrEmpty(e.conversation.getId())&&this.pendingConversations.remove(e.conversation),this.openedConversations.remove(e.conversation)},onOpenMessenger:function(e){if(!R.common.isNullOrUndefined(e.state))switch(e.state){case C.MessengerPanelOpenAction.Minimize:this.minimize();break;case C.MessengerPanelOpenAction.Maximize:this.maximize()}},onCurrentCompanyChanged:function(n,i){var s=(o.defer(),null===i?null:i.Id);this.ConnectionState===T.HubConnectionState.Connected&&this.currentCompanyId!==s&&(this.currentCompanyId=s,null===s?r.logoutCompany():r.changeCompany(s),t.debug("Company changed: "+JSON.stringify(i)),e.colleagues.clear(),a.disconnect(),a.connect().then(function(){}.bind(this)))},onCurrentUserAvatarChanged:function(e){var t,n=e.data.ResizedImages.findByField("micro","Size");n&&(t=n.Url),r.getCurrentUser().then(function(e){e.setAvatarThumbUrl(t),e.Profiles.forEach(function(e){e.setAvatarThumbUrl(t)})})},onSetupUnavailableMessage:function(){this.setupAwayStatusSettings()},onSetUserStatus:function(e){switch(e.data.status){case C.UserStatuses.Online:this.setOnlineStatus();break;case C.UserStatuses.Offline:this.setOfflineStatus();break;case C.UserStatuses.Away:this.setAwayStatus();break;case C.UserStatuses.Busy:this.setBusyStatus()}},bindMessengerEvents:function(){a.bindStateChanged(this.onMessengerStateChanged,this),d.bindConversationCreated(this.onConversationCreated,this),d.bindMessageReceived(this.onMessageReceived,this),d.bindUserStatusChanged(this.onUserStatusChanged,this),d.bindLoadUserSettings(this.onLoadUserSettings,this),d.bindMessageRead(this.onMessageRead,this),d.bindMessagesDeleted(this.onMessagesDeleted,this),d.bindConversationMuted(this.onConversationMuted,this),d.bindConversationUnmuted(this.onConversationUnmuted,this),d.bindStartVideoChat(this.onStartVideoChat,this),c.bindNotifyContactAdded(this.onContactAdded,this),c.bindContactRemoved(this.onContactRemoved,this),c.bindUserInfoChanged(this.onUserInfoChanged,this),c.bindCompanyInfoChanged(this.onCompanyInfoChanged,this),c.bindCompanyUserAdded(this.onCompanyUserAdded,this),e.$on("$destroy",function(){a.unbindStateChanged(this.onMessengerStateChanged,this),d.unbindConversationCreated(this.onConversationCreated,this),d.unbindMessageReceived(this.onMessageReceived,this),d.unbindUserStatusChanged(this.onUserStatusChanged,this),d.unbindLoadUserSettings(this.onLoadUserSettings,this),d.unbindMessageRead(this.onMessageRead,this),d.unbindMessagesDeleted(this.onMessagesDeleted,this),d.unbindConversationMuted(this.onConversationMuted,this),d.unbindConversationUnmuted(this.onConversationUnmuted,this),c.unbindNotifyContactAdded(this.onContactAdded,this),c.unbindContactRemoved(this.onContactRemoved,this),c.unbindUserInfoChanged(this.onUserInfoChanged,this),c.unbindCompanyInfoChanged(this.onCompanyInfoChanged,this),c.unbindCompanyUserAdded(this.onCompanyUserAdded,this)}.bind(this))},onMessengerStateChanged:function(e){this.ConnectionState=e.newState,e.newState===T.HubConnectionState.Connected&&this.onConnected(),e.newState===T.HubConnectionState.Disconnected&&(this.currentUserStatus=C.UserStatuses.Offline)},onConnected:function(){this.wasConnected&&(this.updateContacts().then(function(){this.updateContactsStatuses()}.bind(this)),this.loadUnreadConversations())},onConversationCreated:function(e){var t,n,i=D.get(e.conversation.Id);if(null===i){if(!R.common.isNullOrEmpty(e.conversation.RequestId)&&(i=this.pendingConversations.findByRequestId(e.conversation.RequestId)))return;i=new g(e.conversation,this.user),this.addConversation(i,!0)}if(!this.userSettings.Settings.Mute){if(this.requestCorrelationIds.hasOwnProperty(i.getRequestId()))return this.openConversation(i,this.requestCorrelationIds[i.getRequestId()]),void delete this.requestCorrelationIds[i.getRequestId()];for(t=i.Messages.filter(function(e){return!this.user.Profiles.containsById(e.getAuthorId())&&!e.isNotificationMessage()},this),n=0;n<t.length;n++)this.openMessage(t[n])}},onStartVideoChat:function(e){var t=D.get(e.videoChat.ConversationId);if(!t.videoRoomCtrl||!t.videoRoomCtrl.videoRoom||t.videoRoomCtrl.videoRoom.room!==parseInt(e.videoChat.VideoRoomId)){FloatDivMng.pathPrefix=FloatDivMng.pathPrefixFull;var n=e.videoChat.Subject;confirmIncomingRing(n+" calling",function(n){this.openConversation(t),aCtx().getVideoRoomMng().connectServerAndJoinVideoRoom(null,e.videoChat.VideoRoomId)}.bind(this))}},onMessageReceived:function(t){var n,i,s;return this.processNewReceivedMessage(t),(n=D.get(t.message.ConversationId))?(i=new h(t.message),!R.common.isNullOrUndefined(i.getRequestId())&&n.Messages.containsById(i.getRequestId())?(s=n.Messages.findById(i.getRequestId()),s.setId(i.getId()),s.setState(C.MessageState.Success),s.setCreateDate(i.getCreateDate())):n.isStream()&&i.getMessageType()===C.MessageType.AddParticipants&&n.Participants.containsAll(i.getAddedParticipants())||n.Messages.push(i),e.conversations.containsById(t.message.ConversationId)||e.conversations.unshift(n),void this.openMessage(i)):void this.loadConversation(t.message.ConversationId).then(function(e){var n;R.common.isNullOrUndefined(e)||(n=e.Messages.findById(t.message.Id),null===n&&(n=new h(t.message),e.Messages.push(n)),this.addConversation(e,!0),null!==n&&this.openMessage(n))}.bind(this))},processNewReceivedMessage:function(e){switch(e.message.MessageType){case C.MessageType.AddParticipants:this.onParticipantsAdded(e);break;case C.MessageType.LeaveConversation:this.onLeaveConversation(e);break;case C.MessageType.ParticipantJoined:this.onJoinConversation(e);break;case C.MessageType.RenameConversation:this.onConversationRenamed(e);break;case C.MessageType.Attachment:break;case C.MessageType.ParticipantRemoved:this.onParticipantsRemoved(e)}},onMessageRead:function(e){var t,n,i=D.get(e.data.ConversationId);if(i)for(n=0;n<e.data.ReadMessagesLocalMasterIds.length;n++)t=i.Messages.findReverse(function(t){return e.data.ReadMessagesLocalMasterIds[n]}),null!=t&&t.markReadByUser(e.data.ReadBy)},onMessagesDeleted:function(e){var t,n,i=D.get(e.data.ConversationId);if(null!==i)for(n=0;n<e.data.MessageIds.length;n++)t=i.Messages.findById(e.data.MessageIds[n]),t&&t.setIsDeleted(!0)},onParticipantsAdded:function(e){var n,i,s=D.get(e.message.ConversationId);return s?(n=e.message.Content.ParticipantsProfileIds.filter(function(e){return!s.Participants.contains(function(t){return t.getId()===e})}),i=n.map(function(e){return I.get(e)}),void s.Participants.push(i)):void t.debug("Conversation for participants is not found.")},onParticipantsRemoved:function(e){var n,i=D.get(e.message.ConversationId);if(!i)return void t.debug("Conversation for participant is not found.");n=e.message.Content.ParticipantsProfileIds;for(var s=0;s<n.length;s++)i.Participants.removeById(n[s])},onLeaveConversation:function(e){var n=D.get(e.message.ConversationId);return n?void I.getp(e.message.AuthorId).then(function(e){this.removeFromConversationByIndexId(n,e.getGroupId())}.bind(this),function(e){t.debug("Failed to load global user leaving conversation.")}):void t.error("Conversation for leaving is not found.")},onConversationMuted:function(e){var t=D.get(e.data);null!=t&&t.setIsMuted(!0)},onConversationUnmuted:function(e){var t=D.get(e.data);null!=t&&t.setIsMuted(!1)},removeFromConversationByIndexId:function(e,t){var n=e.Participants.find(function(e){return e.getGroupId()===t},this);null!==n&&e.Participants.remove(n)},onJoinConversation:function(n){var i,s=e.businessConversations.findById(n.message.ConversationId);return s||(s=D.get(n.message.ConversationId)),s?(i=I.get(n.message.AuthorId),void s.Participants.push(i)):void t.error("Conversation for join is not found.")},onConversationRenamed:function(e){var n=D.get(e.message.ConversationId);return n?void n.setDisplayName(e.message.Content.Name):void t.error("Conversation for renaming is not found.")},onUserStatusChanged:function(t){var n;return t.data.UserId===this.user.getId()?void(t.data.Status!==C.UserStatuses.Offline&&(this.currentUserStatus=t.data.Status)):(n=e.colleagues.findById(t.data.UserId))?void n.setStatus(t.data.Status):(n=e.friends.findById(t.data.UserId),void(n&&n.setStatus(t.data.Status)))},onContactAdded:function(n){var i=n.data.SenderGlobalMasterId===this.user.getId()?n.data.ContactGlobalIndexId:n.data.SenderGlobalIndexId;return i===this.user.getId()?void t.debug("User just tried to add himself to contacts."):void(e.friends.containsById(i)||P.getp(i).then(function(e){this.addContactInternal(e)}.bind(this),function(e){t.debug("Failed to load contact by index id.")}))},onContactRemoved:function(n){var i=n.data.SenderGlobalIndexId===this.user.getId()?n.data.ContactGlobalIndexId:n.data.SenderGlobalIndexId;return i===this.user.getId()?void t.debug("User just tried to remove himself from contacts."):void(e.friends.containsById(i)&&e.friends.removeById(i))},addContactInternal:function(t){e.friends.insertSorted(t,function(e){return e.getName()}),this.getUserStatuses([t])},onUserInfoChanged:function(e){var t;P.isCached(e.data.GroupId)&&P.get(e.data.GroupId).setData(e.data),t=I.getAll().filter(function(t){return t.getGroupId()===e.data.GroupId}),_.forEach(t,function(t){t.setUserData(e.data)})},onCompanyInfoChanged:function(e){var t=I.getAll().filter(function(t){return t.getContextGlobalMasterId()===e.data.ContextGlobalMasterId});_.forEach(t,function(t){t.setContextName(e.data.ContextName)})},onCompanyUserAdded:function(t){var n,i=I.putRaw(t.data);P.isCached(i.getGroupId())&&(n=P.get(t.data.GroupId),n.Profiles.insertSorted(i,function(e){return e.getName()})),w.getCurrentCompanyId()===t.data.ContextGlobalMasterId&&P.getp(i.getGroupId()).then(function(t){e.colleagues.insertSorted(t,function(e){return e.getName()})})},onLoadUserSettings:function(e){this.userSettings.SettingStatus=e.data.Value.SettingStatus,this.userSettings.Settings=angular.extend({},e.data.Value),this.currentUserStatus=e.data.Value.SettingStatus,this.currentUserStatus===C.UserStatuses.Offline&&(this.currentUserStatus=C.UserStatuses.Online),delete this.userSettings.Settings.CurrentStatus,delete this.userSettings.Settings.SettingStatus,delete this.userSettings.Settings.UserId,W.isNullOrUndefined(this.newUserStatus)||this.newUserStatus==this.currentUserStatus||this.saveUserStatusOnServer(this.newUserStatus).then(function(){this.newUserStatus=null}.bind(this)),W.isNullOrUndefined(this.userSettings.Settings.InactivityTimeout)&&(this.userSettings.Settings.InactivityTimeout=$),this.fireMuteAllChanged(this.userSettings.Settings.Mute),this.createIdleTimer()},getUserStatusName:function(){return z(this.currentUserStatus)},isUnknown:function(){return this.currentUserStatus===C.UserStatuses.Unknown},isOffline:function(){return this.currentUserStatus===C.UserStatuses.Offline},isOnline:function(){return this.currentUserStatus===C.UserStatuses.Online},isAway:function(){return this.currentUserStatus===C.UserStatuses.Away},isBusy:function(){return this.currentUserStatus===C.UserStatuses.Busy},saveUserStatusOnServer:function(e){return d.setUserStatus(e).then(function(){this.currentUserStatus=e,this.userSettings.SettingStatus=e}.bind(this),function(e){return t.error("Failed to change user status. "+e),o.reject(e)}.bind(this))},setUserConnectedStatus:function(e){return this.isIntermediateConectionState()?!1:void(this.ConnectionState!==T.HubConnectionState.Connected?(a.connect(),this.newUserStatus=e):this.saveUserStatusOnServer(e))},setOnlineStatus:function(){this.setUserConnectedStatus(C.UserStatuses.Online)},setOfflineStatus:function(){this.ConnectionState!==T.HubConnectionState.Disconnected&&a.disconnect(),this.currentUserStatus=C.UserStatuses.Offline},setAwayStatus:function(){this.setUserConnectedStatus(C.UserStatuses.Away)},setAwayTemporary:function(e){if(this.ConnectionState!==T.HubConnectionState.Connected)return!1;if((!e||this.currentUserStatus!==C.UserStatuses.Away)&&(e||this.currentUserStatus!==C.UserStatuses.Online))return d.setTemporaryAwayStatus(e).then(function(){e?this.currentUserStatus=C.UserStatuses.Away:this.currentUserStatus=C.UserStatuses.Online}.bind(this),function(e){return t.error("Failed to change user status. "+e),o.reject(e)}.bind(this))},setBusyStatus:function(){this.setUserConnectedStatus(C.UserStatuses.Busy)},createIdleTimer:function(){i.idleTimer("destroy"),this.userSettings.Settings.InactivityTimeout>0&&i.idleTimer(1e3*this.userSettings.Settings.InactivityTimeout*60)},setupAwayStatusSettings:function(){if(!this.isOffline()){var e=s.open({templateUrl:"/Application/Modules/Messenger/Html/SetupAwayStatusDialog.html",controller:"SetupAwayStatusDialogController",size:"smm",backdrop:!1,resolve:{settings:function(){return angular.extend({},this.userSettings.Settings)}.bind(this),contacts:function(){return this.getAllContacts()}.bind(this)}});e.result.then(function(e){var t=this.userSettings.Settings.InactivityTimeout;angular.extend(this.userSettings.Settings,e),t!==e.InactivityTimeout&&this.createIdleTimer()}.bind(this))}},bindEvents:function(){M.bind(S.login,this.onLoggedIn,this),M.bind(S.logout,this.onLoggedOut,this),M.bind(S.conversationClosed,this.onCloseConversation,this),M.bind(S.createBusinessObjectConversation,this.onCreateBusinessObjectConversation,this),M.bind(S.createConversation,this.onCreateCustomConversation,this),M.bind(S.createStreamConversation,this.onCreateStreamConversation,this),M.bind(S.openChildConversation,this.onOpenChildConversation,this),M.bind(S.conversationOpenedOnPage,this.onConversationOpenedOnPage,this),M.bind(S.conversationOpen,this.onConversationOpen,this),M.bind(S.openMessenger,this.onOpenMessenger,this),M.bind(S.currentUserAvatarChanged,this.onCurrentUserAvatarChanged,this),M.bind(S.setUserStatus,this.onSetUserStatus,this),M.bind(S.setupUnavailableMessage,this.onSetupUnavailableMessage,this),M.bind(S.setMuteAllConversations,this.onSetMuteAllConversations,this),e.conversations.bindCollectionChanged(this.conversations_CollectionChanged,this),this.unregisterGetUnreadConversationsCountWatch=e.$watch(this.getUnreadConversationsCount.bind(this),function(e){M.fire({type:S.unreadConversationsChanged,count:e})}),this.unregisterUserStatusWatch=e.$watch(function(){return this.currentUserStatus}.bind(this),function(e){M.fire({type:S.userStatusChanged,status:e})}),this.unregisterSearchKeywordWatch=e.$watch(function(){return e.searchKeyword}.bind(this),function(){this.buildRecentConversationsList()}.bind(this)),this.unregisterIdleIdleTimer=function(){this.currentUserStatus===C.UserStatuses.Online&&this.setAwayTemporary(!0)}.bind(this),this.unregisterActiveIdleTimer=function(){this.currentUserStatus===C.UserStatuses.Away&&this.userSettings.SettingStatus===C.UserStatuses.Online&&this.setAwayTemporary(!1)}.bind(this),i(document).on("idle.idleTimer",this.unregisterIdleIdleTimer),i(document).on("active.idleTimer",this.unregisterActiveIdleTimer),this.unregisterOnCurrentCompanyChanged=e.$on(S.currentCompanyChanged,this.onCurrentCompanyChanged.bind(this)),e.$on("$destroy",this.onDestroy.bind(this))},onDestroy:function(){M.detach(S.conversationClosed,this.onCloseConversation,this),M.detach(S.login,this.onLoggedIn,this),M.detach(S.logout,this.onLoggedOut,this),M.detach(S.createBusinessObjectConversation,this.onCreateBusinessObjectConversation,this),M.detach(S.createConversation,this.onCreateCustomConversation,this),M.detach(S.createStreamConversation,this.onCreateStreamConversation,this),M.detach(S.openChildConversation,this.onOpenChildConversation,this),M.detach(S.conversationOpenedOnPage,this.onConversationOpenedOnPage,this),M.detach(S.conversationOpen,this.onConversationOpen,this),M.detach(S.openMessenger,this.onOpenMessenger,this),M.detach(S.currentUserAvatarChanged,this.onCurrentUserAvatarChanged,this),M.detach(S.setMuteAllConversations,this.onSetMuteAllConversations,this),this.unregisterGetUnreadConversationsCountWatch(),this.unregisterUserStatusWatch(),this.unregisterSearchKeywordWatch(),this.unregisterOnCurrentCompanyChanged(),i(document).off("idle.idleTimer",this.unregisterIdleIdleTimer),i(document).off("active.idleTimer",this.unregisterActiveIdleTimer),e.conversations.unbindCollectionChanged(this.conversations_CollectionChanged,this),this.pendingConversations.clear()},fireMuteAllChanged:function(e){M.fire({type:S.muteAllConversationsChanged,value:e})},onSetMuteAllConversations:function(e){var n=angular.extend({},this.userSettings.Settings);n.Mute=e.value,d.setUserSettings(n).then(function(){this.userSettings.Settings.Mute=n.Mute,this.fireMuteAllChanged(n.Mute)}.bind(this),function(e){t.error("Failed to save mute settings. "+e)})},onCreateGroupConversation:function(){r.getCurrentProfile().then(function(e){this.createGroupConversationInternal(e)}.bind(this),function(e){t.error("Failed to load current global user info. "+e)})},createGroupConversationInternal:function(e){var t=new g({Id:null,DisplayName:null,Participants:[e.getId()],Messages:[],Type:C.ConversationType.Group},this.user);this.pendingConversations.push(t),this.openConversation(t)},buildRecentConversationsList:function(){var t;t=W.isNullOrEmpty(e.searchKeyword)?e.conversations.slice(0,B):e.conversations.filter(function(e){return this.searchConversation(e)}.bind(this)).slice(0,B),e.recentConversations=t},searchConversation:function(t){if(W.isNullOrEmpty(e.searchKeyword))return!0;var n,i,s,o=e.searchKeyword.toLowerCase();if(!W.isNullOrEmpty(t.getTitle())&&(s=t.getTitle().toLowerCase(),s.indexOf(o)>-1))return!0;for(n=0;n<t.Participants.length();n++)if(i=t.Participants.get(n),!this.user.Profiles.containsById(i.getId())&&!W.isNullOrEmpty(i.getName())&&(s=i.getName().toLowerCase(),s.indexOf(o)>-1))return!0;return!1},contactSearch:function(t){if(W.isNullOrEmpty(e.searchKeyword))return!0;var n=t.getName(),i=e.searchKeyword.toLowerCase();return W.isNullOrEmpty(n)?!1:(n=n.toLowerCase(),n.indexOf(i)>-1)},conversations_CollectionChanged:function(t){(W.isNullOrEmpty(e.searchKeyword)||R.common.isDefined(t.newStartingIndex)&&t.newStartingIndex<B||R.common.isDefined(t.oldStartingIndex)&&t.oldStartingIndex<B)&&this.buildRecentConversationsList(),t.action===T.CollectionAction.Add&&0===t.newStartingIndex&&(this.processNewBoConversations(t.newItems),this.processNewStreamConversations(t.newItems))},processNewBoConversations:function(t){var n,i=N.getCurrentObject();null!==i&&(n=t.filter(function(e){return e.getBusinessObjecId()===i.id}),e.businessConversations.unshift(n))},processNewStreamConversations:function(t){var n,i;E.hasStreams()&&(n=E.getCurrentStreams(),i=t.filter(function(e){return n.indexOf(e.getBusinessObjecId())>-1}),e.streamConversations.unshift(i))}}),e.conversationOrderFunction=function(e){return e.getLastMessageDate()},new L(e)}])}(window),function(e){"use strict";e.app.controller("SetupAwayStatusDialogController",["settings","contacts","BasePopupController","profileCacheService","messengerHub","MessengerEnums","$scope","$log","$q","$uibModalInstance","$","utils",function(e,t,n,i,s,o,r,a,d,c,l,u){var h=n.extend({init:function(n){var s;this._super(n,c),r.c=this,this.$scope.settings=e,r.contacts=this.buildContactList(t),this.$scope.user={},u.common.isNullOrEmpty(this.$scope.settings.RedirectProfileId)?this.$scope.user.selected=null:(this.$scope.user.selected=i.get(this.$scope.settings.RedirectProfileId),s=r.contacts.findItem(function(e){return e.getId()===this.$scope.settings.RedirectProfileId},this),u.common.isNullOrUndefined(s)&&r.contacts.push(this.$scope.user.selected)),r.contacts=_.sortBy(r.contacts,function(e){return e.getTitle()})},buildContactList:function(e){var t,n,i,s=[];for(t=0;t<e.length;t++)for(i=e[t],n=0;n<i.Profiles.length();n++)s.push(i.Profiles.get(n));return s},loadData:function(){},onUserSelected:function(e){},apply:function(){u.common.isNullOrUndefined(this.$scope.user.selected)?this.$scope.settings.RedirectProfileId=null:this.$scope.settings.RedirectProfileId=this.$scope.user.selected.getId(),s.setUserSettings(this.$scope.settings).then(function(){c.close(this.$scope.settings)}.bind(this),function(e){a.error("Failed to save chat settings. "+e)})}});return new h(r)}])}(window),function(e){"use strict";e.app.controller("TagDeleteDialogController",["entity","BasePopupController","messengerHub","MessengerEnums","$scope","$log","$q","$uibModalInstance","$","utils",function(e,t,n,i,s,o,r,a,d,c){var l=t.extend({init:function(t){this._super(t,a),s.controller=this,this.tag=e,this.MoveToArchive=!1},apply:function(){var e={FolderId:this.tag.getId(),MoveToArchive:this.MoveToArchive};n.deleteTag(e).then(function(){a.close()}.bind(this),function(e){o.error("Failed to save folder."+e)})}});return new l(s)}])}(window),function(e){"use strict";e.app.controller("TagEditDialogController",["entity","BasePopupController","messengerHub","MessengerEnums","$scope","$log","$q","$uibModalInstance","$","utils",function(t,n,i,s,o,r,a,d,c,l){var u=n.extend({init:function(n){this._super(n,d),o.controller=this,null===t?this.entity={FolderType:s.TagType.CustomFolder}:this.entity=e.angular.extend({},t.get())},isEditing:function(){return null!==t},apply:function(){i.saveTag(this.entity).then(function(){t&&t.setDisplayName(this.entity.DisplayName),d.close()}.bind(this),function(e){r.error("Failed to save folder."+e)})}});return new u(o)}])}(window),function(e){"use strict";e.realineMessenger.directive("chatBubbleMessages",[function(){return{restrict:"E",replace:!0,templateUrl:"/Application/Modules/Messenger/Html/Common/ChatBubbleMessages.html",scope:{},controller:"ChatBubbleMessagesController",link:function(e,t,n){}}}])}(window),function(e){"use strict";e.realineMessenger.directive("currentUserConnectionState",["$log","$",function(e,t){return{restrict:"E",replace:!0,scope:{},template:'<i title="{{status}}" class="fa fa-circle user-status" data-ng-class="{online: isOnline(), offline: isOffline(), away:isAway(), busy: isBusy()}"></i>',link:function(e,t,n){},controller:["$scope","messageBus","events","MessengerEnums",function(e,t,n,i){function s(t){e.status=t.status}e.status=i.UserStatuses.Offline,e.isOnline=function(){return e.status===i.UserStatuses.Online},e.isOffline=function(){return e.status===i.UserStatuses.Offline},e.isAway=function(){return e.status===i.UserStatuses.Away},e.isBusy=function(){return e.status===i.UserStatuses.Busy},t.bind(n.userStatusChanged,s,this),e.$on("$destroy",function(){t.detach(n.userStatusChanged,s,this)}.bind(this))}]}}])}(window),function(e){"use strict";e.realineMessenger.directive("downloadFileForm",["cookieService","authConstants","$timeout","$",function(e,t,n,i){return{restrict:"E",replace:!0,transclude:!0,template:"<span ng-transclude></span>",link:function(s,o,r){var a='<form class="download-form" method="post" target="_blank"><input class="js-token" type="hidden"/><button class="js-button file-download-btn" type="submit"></button></form>',d=(e.cookie(t.cookie),o.html()),c=i(a);c.attr("action",r.fileUrl),c.find(".js-button").html(d),o.removeAttr("file-url"),o.removeAttr("file-name"),o.empty(),c.submit(function(){var i=e.cookie(t.cookie);c.find(".js-token").attr("name",t.header).val(i),n(function(){c.find(".js-token").attr("name",t.header).val("")},1e3)}),o.append(c)}}}])}(window),function(e){"use strict";e.realineMessenger.directive("messengerPageTitle",["$log","$",function(e,t){return{restrict:"A",scope:{},link:function(e,t,n){e.setTitle=function(e){t.text(e)},e.controller.readConversationsData()},controller:["conversationService","CoreEnums","MessengerEnums","observable","$scope","$rootScope","$interval","$window","$",function(e,n,i,s,o,r,a,d){function c(){var e=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var t=0;t<e.length;t++)if(e[t]+"Hidden"in document)return e[t]+"Hidden";return null}function l(){var e=c();return e?document[e]:!0}var u={Default:0,ConversationsCount:1,OneConversation:2},h=Class.extend({init:function(){o.controller=this,this.unreadConversationsCount=0,this.unreadConversation=null,this.lastMessageDate=null,this.isWindowsActive=!l(),this.timer=null,this.currentStage=u.Default,this.conversations=e.getList(),this.bindEvents()},pageTitleChanged:function(e,t){this.updatePageTitle()},initLastMessageDate:function(){var e;null===this.lastMessageDate&&(e=this.conversations.find(function(e){return e.hasUnreadMessages()}),null===conversations?this.lastMessageDate=new Date(2e3,1,1):this.lastMessageDate=e.getLastMessageDate())},readConversationsData:function(e){var t=this.conversations.filter(function(e){return e.hasUnreadMessages()});this.unreadConversationsCount=t.length,t.length>0?this.unreadConversation=t[0]:this.unreadConversation=null,this.updatePageTitle(),e===!0&&(this.unreadConversation?this.lastMessageDate=this.unreadConversation.getLastMessageDate():this.lastMessageDate=new Date(2e3,1,1)),this.unreadConversationsCount>0&&!this.isWindowsActive&&this.unreadConversation.getLastMessageDate()>this.lastMessageDate?this.startTimer():this.stopTimer()},updatePageTitle:function(){var e;if(this.isWindowsActive)e=r.title;else switch(this.currentStage){case u.Default:e=r.title;break;case u.ConversationsCount:e=String.format("({0}) {1}",this.unreadConversationsCount,r.title);break;case u.OneConversation:e=String.format("{0} - {1}",this.unreadConversation.getTitle(),this.unreadConversation.getUnreadMessagesCount())}o.setTitle(e)},startTimer:function(){null===this.timer&&(this.timerIteration(),this.timer=setInterval(this.timerIteration.bind(this),1e3))},timerIteration:function(){switch(this.currentStage){case u.Default:this.currentStage=u.ConversationsCount;break;case u.ConversationsCount:this.currentStage=u.OneConversation;break;case u.OneConversation:this.currentStage=u.ConversationsCount}this.updatePageTitle()},stopTimer:function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null,this.currentStage=u.Default,this.updatePageTitle())},onWindowActivated:function(){this.isWindowsActive=!0,this.stopTimer()},onWindowDeactivated:function(){this.isWindowsActive=!1,this.readConversationsData(!0)},conversations_CollectionChanged:function(e){switch(e.action){case n.CollectionAction.Add:this.onConversations_Added(e);break;case n.CollectionAction.Remove:this.onConversations_Removed(e)}},onConversations_Added:function(e){var t=e.newItems.filter(function(e){return e.hasUnreadMessages()});s.bindPropertyChanged(e.newItems,this.Conversation_PropertyChanged,this),t.length>0&&this.readConversationsData()},onConversations_Removed:function(e){var t=e.oldItems.filter(function(e){return e.hasUnreadMessages()});s.unbindPropertyChanged(e.oldItems,this.Conversation_PropertyChanged,this),t.length>0&&this.readConversationsData()},Conversation_PropertyChanged:function(e){e.property===i.PropertyNames.UnreadMessagesCount&&this.readConversationsData()},bindEvents:function(){this.conversations.bindCollectionChanged(this.conversations_CollectionChanged,this),s.bindPropertyChanged(this.conversations,this.Conversation_PropertyChanged,this),this.unregisterTitleWatcher=r.$watch("title",this.pageTitleChanged.bind(this)),o.$on("$destroy",this.onDestroy.bind(this)),t(d).blur(this.onWindowDeactivated.bind(this)),t(d).focus(this.onWindowActivated.bind(this))},onDestroy:function(){this.conversations.unbindCollectionChanged(this.conversations_CollectionChanged,this),s.unbindPropertyChanged(this.conversations,this.Conversation_PropertyChanged,this),this.unregisterTitleWatcher(),this.stopTimer()}});return new h}]}}])}(window),function(e){"use strict";e.realineMessenger.directive("messengerToolbar",[function(){return{restrict:"E",replace:!0,templateUrl:"/Application/Modules/Messenger/Html/MessengerToolbar.html",scope:{isSideBarCollapsed:"="},controller:"MessengerToolbarController",link:function(e,t,n){}}}])}(window),function(e){"use strict";e.realineMessenger.directive("reconnector",["$log","$",function(e,t){return{restrict:"E",replace:!0,scope:{},template:'<div class="reconnector_widget" data-ng-show="isReconnecting || isWaiting"><div class="inner"><span class="reconection_text" data-ng-if="isReconnecting"><i class="font_icon icon-spin3"></i> Connecting...</span><span class="reconnection_wait" data-ng-if="isWaiting"><i class="font_icon icon-spin3"></i> Reconnecting in {{reconnectInInterval}} sec... (<a data-ng-click="reconnect()">Do it now</a>)</span></div></div>',link:function(e,t,n){},
controller:["$scope","$interval","hubConnection","CoreEnums",function(e,t,n,i){function s(){e.numberOfAttempts<3?e.reconnectInInterval=r:e.reconnectInInterval=a,e.isWaiting=!0,d=t(o,1e3)}function o(){e.reconnectInInterval--,0===e.reconnectInInterval&&e.reconnect()}var r=3,a=6,d=null;e.isReconnecting=n.getState()===i.HubConnectionState.Reconnecting||n.getState()===i.HubConnectionState.Connecting,e.isWaiting=!1,e.reconnectInInterval=0,e.numberOfAttempts=0,e.onMessengerStateChanged=function(t){switch(e.isReconnecting=t.newState===i.HubConnectionState.Reconnecting||t.newState===i.HubConnectionState.Connecting,t.newState){case i.HubConnectionState.Reconnecting:case i.HubConnectionState.Connecting:this.onReconnecting();break;case i.HubConnectionState.Connected:this.onConnected()}},e.onReconnecting=function(){this.isReconnecting=!0,this.isWaiting=!1},e.onConnected=function(){this.resetAttempts()},e.onDisconnected=function(t){t.triedToReconnect&&(e.numberOfAttempts++,1===e.numberOfAttempts?n.connect():s())},e.resetAttempts=function(){e.numberOfAttempts=0},e.reconnect=function(){d&&(t.cancel(d),d=null),n.connect()},n.bindStateChanged(e.onMessengerStateChanged.bind(e)),n.bindDisconnected(e.onDisconnected.bind(e))}]}}])}(window),function(e){"use strict";e.realineMessenger.directive("unreadConversationsCount",["$log","$",function(e,t){return{restrict:"E",replace:!0,scope:{},template:'<span class="label label-success" data-ng-if="conversationCount>0">{{conversationCount}}</span>',link:function(e,t,n){},controller:["$scope","messageBus","events",function(e,t,n){function i(t){e.conversationCount=t.count}e.conversationCount=0,t.bind(n.unreadConversationsChanged,i,this),e.$on("$destroy",function(){t.detach(n.unreadConversationsChanged,i,this)})}]}}])}(window),function(e){"use strict";e.realineMessenger.directive("userStatus",["contactsCacheService","MessengerEnums","utils","$log","$",function(e,t,n,i,s){return{restrict:"A",link:function(i,s,o){function r(e){switch(e){case t.UserStatuses.Unknown:return"unknown";case t.UserStatuses.Online:return"online";case t.UserStatuses.Offline:return"offline";case t.UserStatuses.Away:return"away";case t.UserStatuses.Busy:return"busy"}}var a=Class.extend({init:function(){var e;this.contact=null,this.user=null,this.profile=null,this.userExpression=o.userStatus,e=i.$eval(this.userExpression),n.common.isNullOrUndefined(e)||this.setupContact(e),this.bindEvents()},setupContact:function(e){this.contact=e,"UserModel"===this.contact.__ClassName?this.setupUser(this.contact):this.setupProfile(this.contact)},setupUser:function(e){this.user=e,this.user.bindPropertyChanged(this.onUser_PropertyChanged,this),this.updateUIState(this.user.getStatus())},setupProfile:function(e){this.profile=e,this.profile.isLoaded?this.onProfileLoaded():this.profile.bindLoaded(this.onProfileLoaded,this)},onProfileLoaded:function(n){var i,s=this.profile.getGroupId();e.isCached(s)?(i=e.get(s),this.setupUser(i)):this.updateUIState(t.UserStatuses.Unknown)},onUser_PropertyChanged:function(e){e.property===t.PropertyNames.Status&&this.updateUIState(e.newValue,e.oldValue)},updateUIState:function(e,t){n.common.isNullOrUndefined(t)||s.removeClass(r(t)),n.common.isNullOrUndefined(e)||s.addClass(r(e))},bindEvents:function(){i.$on("$destroy",function(){this.onDestroy()}.bind(this))},onDestroy:function(){n.common.isNullOrUndefined(this.user)||this.user.unbindPropertyChanged(this.onUser_PropertyChanged,this),n.common.isNullOrUndefined(this.profile)||this.profile.unbindLoaded(this.onProfileLoaded,this)}});i.directive=new a},controller:["$scope",function(e){}]}}])}(window),function(e){"use strict";e.realineMessenger.directive("conversationContainer",["$",function(e){return{restrict:"E",replace:!0,templateUrl:"/Application/Modules/Messenger/Html/ConversationContainer.html",scope:{currentUser:"=",conversation:"=",isConversationActive:"=isActive"},controller:"ConversationContainerController",compile:function(){return{post:function(t,n,i){t.initialized=!0,t.hideParticipantsPanel=function(){e(n).find(".participants").hide()}}}},link:function(e,t,n){}}}])}(window),function(e){"use strict";e.realineMessenger.directive("conversationDayMessagesContainer",[function(){return{restrict:"E",replace:!0,template:'<div class="messages-day-group">    <h4 class="stripe-bg">        <span ng-bind="dayGroup.day|friendlyDate"></span>        <hr>    </h4>    <conversation-message-group o-repeat="messageGroup in messageGroups"></conversation-message-group></div>',controller:"ConversationDayMessagesContainerController",link:function(e,t,n){}}}])}(window),function(e){"use strict";e.realineMessenger.directive("conversationList",[function(){return{restrict:"E",replace:!0,template:'<div class="table-responsive margin-top1 padding-top1 full-height" infinite-scroll="controller.loadMoreConversations()"><table class="table table-hover dataTable chats" style="margin-bottom:0;"><tbody><tr conversation-list-item ng-repeat="conversationRecord in conversationRecords.list" conversation-record="conversationRecord"             on-conversation-open="controller.onConversationOpen(conversation)"></tr></tbody></table></div>',scope:{onConversationOpen:"&"},controller:"ConversationListController",link:function(e,t,n){}}}])}(window),function(e){"use strict";e.realineMessenger.directive("conversationListItem",[function(){return{restrict:"EA",replace:!0,template:'<tr data-ng-click="controller.onConversationOpen()">    <td width="16"><input type="checkbox"/></td>    <td width="16"><a class="btn btn-box-tool" data-ng-click="controller.onStarConversation($event)"><i class="star-js fa fa-star-o"></i></a></td>    <td width="25%" class="overflow"><a class="participants"></a></td>    <td align="center" width="16"><span class="unread_messages"></span></td>    <td width="55%" class="overflow text-muted"><a class="title"></a> - <span class="text-muted msg_text"></span></td>    <td align="right" class="time"></td></tr>',scope:{conversationRecord:"=",onConversationOpen:"&"},controller:"ConversationListItemController",link:function(e,t,n){e.setSelection=function(e){e?t.addClass("active"):t.removeClass("active")},e.setTitle=function(e){t.find(".title").text(e)},e.setParticipants=function(e){t.find(".participants").text(e)},e.setTime=function(e){t.find(".time").text(e)},e.setLastMessageText=function(e){t.find(".msg_text").text(e)},e.setUnreadMessagesCount=function(e){var n=t.find(".unread_messages");0===e?(n.hide(),t.removeClass("text-bold")):(n.text("("+e+")"),n.show(),t.addClass("text-bold"))},e.starConversation=function(e){e?(t.find("star-js").removeClass("fa-star-o"),t.find("star-js").addClass("fa-star")):(t.find("star-js").removeClass("fa-star"),t.find("star-js").addClass("fa-star-o"))},e.controller.initUI()}}}])}(window),function(e){"use strict";e.realineMessenger.directive("conversationMessageGroup",["$document","$compile","MessengerEnums","utils","$","$log",function(e,t,n,i,s,o){return{restrict:"E",replace:!0,templateUrl:"/Application/Modules/Messenger/Html/ConversationMessageGroup.html",controller:"ConversationMessageGroupController",link:function(o,r,a){var d,c,l=!1;o.usersScope=null,o.setIsReadStatus=function(e){e?r.find(".unread_mark-js").addClass("removed"):r.find(".unread_mark-js").show()},o.showReadByOthersMark=function(e){e?r.find(".read_by_others-js").show():r.find(".read_by_others-js").hide()},o.showReadersPanel=function(n){var i,a='<li ng-repeat="user in users">    <a>        <span class="pull-left margin-right">            <img width="16" ng-src="{{user.getAvatarThumbUrl() | defaultValue:\'/images/no_profile_photo.png\'}}" class="img-circle"> {{user.getName()}}        </span>        <i class="fa fa-check pull-right no-margin"></i>        <span class="clearfix">        </span>    </a></li>   ';o.usersScope||(i=r.find(".read_by_others-js"),d=r.find(".readers-js").clone(),o.usersScope=o.$new(),o.usersScope.users=n,a=t(a)(o.usersScope),d.append(a),d.removeClass("ng-hide"),s.positionDropdownMenu(i,d),s("body").append(d),d.show(),e.on("click",o.onDocumentClick_Readers))},o.hideReadersPanel=function(){null!==o.usersScope&&(e.off("click",o.onDocumentClick_Readers),d.detach(),o.usersScope.$destroy(),o.usersScope=null,d=null)},o.onDocumentClick_Readers=function(e){var t=r.find(".read_by_others-js").find(e.target).length>0;t||r.find(".read_by_others-js").is(e.target)||o.hideReadersPanel()},o.onErrorOptionsClick=function(t){var n;l||(n=r.find(".error-options-js"),c||(c=r.find(".error-options-menu-js").detach(),c.removeClass("ng-hide")),s.positionDropdownMenu(n,c),s("body").append(c),c.show(),l=!0,e.on("click",o.onDocumentClick_ErrorOptions))},o.hideErrorOptionsPanel=function(){e.off("click",o.onDocumentClick_ErrorOptions),c.detach(),l=!1},o.onDocumentClick_ErrorOptions=function(e){var t=r.find(".error-options-js").find(e.target).length>0;t||r.find(".error-options-js").is(e.target)||o.hideErrorOptionsPanel()},o.markAsDeleted=function(e){var t,n;t=String.format("[msgid={0}]",e.getId()),n=r.find(t),n.find("attachment-js").remove(),r.find(".content-js").remove(),n.addClass("removed_message").text(e.getPlainText()).removeClass("ng-hide")},o.changeMsgId=function(e,t){var n=String.format("[msgid={0}]",e),i=r.find(n);i.attr("msgid",e)},o.setMessageState=function(e,t){var i=e.getState();switch(i){case n.MessageState.Sending:o.markAsError(e,t,!1),o.markAsSending(e,t,!0);break;case n.MessageState.Error:o.markAsSending(e,t,!1),o.markAsError(e,t,!0);break;default:o.markAsSending(e,t,!1),o.markAsError(e,t,!1),0===e.Readers.length()&&o.controller.isOutgoingMessage(e)&&o.markAsSent(e,!0,t)}},o.markAsSending=function(e,t,n){t&&(n?r.find(".sending_msg_mark-js").show():r.find(".sending_msg_mark-js").hide())},o.markAsSent=function(e,t,n){t&&(n?r.find(".msg_sent_mark-js").show():r.find(".msg_sent_mark-js").hide())},o.markAsError=function(e,t,n){var i=String.format(".text_message[msgid={0}]",e.getId()),s=r.find(i);n?s.addClass("error_message"):s.removeClass("error_message")},o.setCommonErrorState=function(e){e?r.find(".error-options-js").show():r.find(".error-options-js").hide()},o.updateAvatar=function(e){i.common.isNullOrEmpty(e)&&(e=r.find(".user_piture-js").attr("data-default-src")),r.find(".user_piture-js").attr("src",e)},o.updateUserName=function(e){r.find(".user_name").text(e)},o.msgController.updateUI()}}}])}(window),function(e){"use strict";e.realineMessenger.directive("conversationMessagesContainer",[function(){return{restrict:"E",replace:!0,template:'<div class="conversation-messages-container full-height"><conversation-day-messages-container o-repeat="dayGroup in controller.messageDayGroups"></conversation-day-messages-container></div>',scope:{currentUser:"=",messages:"=",onContactRedirectDestinationUser:"&",onOpenChildGroupConversation:"&",onResendMessages:"&",onDeleteMessages:"&"},controller:"ConversationMessagesContainerController",link:function(e,t,n){}}}])}(window),function(e){"use strict";e.realineMessenger.directive("conversationParticipantsPicker",["$document","$timeout","$log",function(e,t,n){return{restrict:"E",replace:!0,templateUrl:"/Application/Modules/Messenger/Html/ConversationParticipantsPicker.html",scope:{conversation:"=",currentUser:"="},controller:"ConversationParticipantsPickerController",link:function(e,t,n){}}}])}(window),function(e){"use strict";e.realineMessenger.directive("fileUploaderContainer",[function(){return{restrict:"E",replace:!0,templateUrl:"/Application/Modules/Messenger/Html/FileUploaderContainer.html",scope:{files:"=",conversation:"="},controller:"FileUploaderContainerController",link:function(e,t,n){}}}])}(window),function(e){"use strict";e.realineMessenger.directive("messengerFolders",[function(){return{restrict:"E",replace:!0,templateUrl:"/Application/Modules/Messenger/Html/MessengerFolders.html",scope:{},controller:"MessengerFoldersController",link:function(e,t,n){}}}])}(window),function(e){"use strict";e.realineMessenger.directive("messengerPanel",[function(){return{restrict:"E",replace:!0,templateUrl:"/Application/Modules/Messenger/Html/MessengerPanel.html",scope:{},controller:"MessengerPanelController",link:function(e,t,n){e.messenger.initContainer()}}}])}(window),window.videoRoomAppContext=new VideoRoomAppContext,function(e){e.realineMessenger.controller("VideoRoomController",["$scope","$log","messenger","messengerHub","MessageModel","CoreEnums","MessengerEnums","utils",function(e,t,n,i,s,o,r,a){var d=this;d.videoRoom=null,d.createNewVideoRoom=function(){aCtx().getVideoRoomMng().connectServerAndCreateVideoRoom(d.vrLifeCycleListener)},d.canCreateNewVideoRoom=function(){return!0},d.joinVideoRoom=function(e){aCtx().getVideoRoomMng().connectServerAndJoinVideoRoom(d.vrLifeCycleListener,e)},d.canJoinVideoRoom=function(){return!0},d.exitVideoRoom=function(){d.videoRoom.exitRoom()},d.vrLifeCycleListener=function(e,t){switch(t){case"created":d.videoRoom=e,d.sendVideoRoomInvitation();break;case"joined":break;case"listener added":}},this.isMenuVisible=!1,d.onShowMenu=function(){this.isMenuVisible=!0},d.onHideMenu=function(){this.isMenuVisible=!1},this.scope=e,this.scope.conversation.videoRoomCtrl=this,this.messenger=n,this.messengerHub=i,d.sendVideoRoomInvitation=function(){return n.getCurrentProfile().then(function(e){return this._sendVideoRoomInvitation(e)}.bind(this),function(e){t.debug("Failed to get global user during videoChat creation.")})["finally"](function(){}.bind(this))}.bind(this),d._sendVideoRoomInvitation=function(e){this.messengerHub.startVideoChat({ConversationId:this.scope.conversation.getId(),VideoRoomId:""+this.videoRoom.room,Subject:e.getName()}).then(function(){t.debug("VideoChat started.")}.bind(this),function(e){t.debug("Failed to start videoChat. "+e)})}.bind(this)}])}(window),function(e){e.realineMessenger.factory("videoRoomService",function(){return aCtx().getVideoRoomMng()})}(window);var FloatDivMng={pathPrefixNull:"",pathPrefixFull:"Application/Modules/Messenger/Controllers/VideoConference/",pathPrefix:"",createFd:function(e,t,n){n||(n=window.document.body),e||(e="#fd_frame_template");var i=loadHtmlPage(this.pathPrefix+"floatDiv.html",e,!1);if(i=n.ownerDocument.adoptNode(i),this.pathPrefix){var s=i.querySelector("img.fd_close").src.lastIndexOf(window.location.origin);s=0>s?0:window.location.origin.length+1;for(var o=i.querySelectorAll("img"),r=0;r<o.length;r++)o[r].src=o[r].src.substr(0,s)+this.pathPrefix+o[r].src.substr(s)}return i.id=t?t:"fd_"+(new Date).valueOf(),n.appendChild(i),i.FDD=new FloatDiv,i.FDD.fdFrameTemplate_Selector=e,i.FDD.bornArea=n,i.FDD.fd_element=i,bringToTop(i),i},showFD:function(e,t,n,i,s,o,r,a,d,c){var l=window.document.body;e instanceof Element&&d&&(l=e);var u=l.querySelector("#"+t);if(u)bringToTop(u);else{if(a){var h=l.querySelector('link[rel="stylesheet"][type="text/css"][href="'+a+'"]');h||(h=l.ownerDocument.createElement("link"),h.setAttribute("rel","stylesheet"),h.setAttribute("type","text/css"),h.setAttribute("href",a),l.querySelector("html>head").appendChild(h))}if(u=this.createFd("#fd_frame_template",t,l),s){var g=s.split(" ");g.forEach(function(e){u.classList.add(e)})}u.FDD.template_htmlFileName=n,u.FDD.template_elementId=i,u.FDD.divCSSClassName=s,u.FDD.iconFileName=o,u.FDD.title=r,o&&(u.querySelector(".fd_icon").src=o),r&&(u.querySelector(".fd_title").textContent=r);var f=loadHtmlPage(n,i,!1);f=u.ownerDocument.adoptNode(f),u.querySelector(".fd_body").appendChild(f),u.style.display="block",c!==!1&&this.setFDPosition(u,e),u.FDD.fillFDDInitSizeAndPosition(u)}return u.style.display="block",u},setFDPosition:function(e,t){if(t)if(t instanceof Element||"clientHeight"in t)e.FDD.bornArea=t,t.amountOfChildFDs||(t.amountOfChildFDs=0),e.style.top=t.offsetTop+(t.clientHeight-e.scrollHeight)/5*(t.amountOfChildFDs%10)+"px",e.style.left=t.offsetLeft+(t.clientWidth-e.scrollWidth)/10*(t.amountOfChildFDs%20)+"px",t.amountOfChildFDs++;else if(t.clientY)e.style.top=t.clientY-9+"px",e.style.left=t.clientX-9+"px";else{var n=t.target.getBoundingClientRect();e.style.top=n.top+10+"px",e.style.left=n.left+10+"px"}else e.style.top=(window.innerHeight-e.scrollHeight)/2+"px",e.style.left=(window.innerWidth-e.scrollWidth)/2+"px";adjustElementPosition(e)},setNotResizing:function(e){e.querySelector(".fd_leftupper_corner").style.display="none",e.querySelector(".fd_rightupper_corner").style.display="none",e.querySelector(".fd_leftbottom_corner").style.display="none",e.querySelector(".fd_rightbottom_corner").style.display="none"}};FloatDivMng.TOP_Z=1e3;var FloatDiv=function(){this.fdFrameTemplate_Selector=null,this.template_htmlFileName=null,this.template_elementId=null,this.divCSSClassName=null,this.iconFileName=null,this.title=null,this.bornArea=null,this.leftInitial=null,this.topInitial=null,this.widthInitial=null,this.heightInitial=null,this.left=null,this.top=null,this.width=null,this.height=null,this.aspectRatio=0,this.fd_element=null};FloatDiv.prototype.fillFDDInitSizeAndPosition=function(e){this.bornArea||(this.bornArea=e.ownerDocument.body),this.leftInitial=e.offsetLeft,this.topInitial=e.offsetTop,this.widthInitial=e.clientWidth,this.heightInitial=e.clientHeight,this.left=e.offsetLeft,this.top=e.offsetTop,this.width=e.clientWidth,this.height=e.clientHeight};var fdSizeAndPosition=new FDSizeAndPosition,_getFDRootNode=function(e){var t=e.currentTarget;return getFDRootNode(t)},getFDRootNode=function(e){for(;!e.classList.contains("float_div");)e=e.parentNode;return e},startMoving=function(e){return e.stopPropagation(),e.preventDefault(),fdSizeAndPosition.el=_getFDRootNode(e),bringToTop(fdSizeAndPosition.el),fdSizeAndPosition.nX=fdSizeAndPosition.el.offsetLeft,fdSizeAndPosition.X=e.pageX,fdSizeAndPosition.nY=fdSizeAndPosition.el.offsetTop,fdSizeAndPosition.Y=e.pageY,fdSizeAndPosition.gapPX=getRootElementFontSize()*fdSizeAndPosition.gapEM,window.document.addEventListener("mousemove",doMoving,!0),window.document.addEventListener("mouseup",stopMoving,!0),!1},doMoving=function(e){return fdSizeAndPosition.el?(e.stopPropagation(),e.preventDefault(),fdSizeAndPosition.nX+=e.pageX-fdSizeAndPosition.X,fdSizeAndPosition.X=e.pageX,fdSizeAndPosition.nX<=0?fdSizeAndPosition.el.style.left="0px":fdSizeAndPosition.nX>=window.innerWidth-fdSizeAndPosition.gapPX?fdSizeAndPosition.el.style.left=window.innerWidth-fdSizeAndPosition.gapPX+"px":fdSizeAndPosition.el.style.left=fdSizeAndPosition.nX+"px",fdSizeAndPosition.nY+=e.pageY-fdSizeAndPosition.Y,fdSizeAndPosition.Y=e.pageY,fdSizeAndPosition.nY<=0?fdSizeAndPosition.el.style.top="0px":fdSizeAndPosition.nY>=window.innerHeight-fdSizeAndPosition.gapPX?fdSizeAndPosition.el.style.top=window.innerHeight-fdSizeAndPosition.gapPX+"px":fdSizeAndPosition.el.style.top=fdSizeAndPosition.nY+"px",!1):!0},stopMoving=function(e){e.stopPropagation(),e.preventDefault(),fdSizeAndPosition.el=null,window.document.removeEventListener("mousemove",doMoving,!0),window.document.removeEventListener("mouseup",stopMoving,!0)},startFDResizing=function(e){fdSizeAndPosition.el=_getFDRootNode(e),bringToTop(fdSizeAndPosition.el),startResizing(e,fdSizeAndPosition.el),fdSizeAndPosition.el.FDD.lastAction="Resizing"},startAbuttingResizing=function(e,t){var n=e.currentTarget.parentNode,i=window.document.querySelector(t);startResizing(e,n,i)},startResizing=function(e,t,n){if(e.stopPropagation(),e.preventDefault(),t||(t=e.currentTarget.parentNode),fdSizeAndPosition.el=t,fdSizeAndPosition.initWidth=fdSizeAndPosition.el.clientWidth,fdSizeAndPosition.initHeight=fdSizeAndPosition.el.clientHeight,fdSizeAndPosition.initLeft=fdSizeAndPosition.el.offsetLeft,fdSizeAndPosition.initTop=fdSizeAndPosition.el.offsetTop,fdSizeAndPosition.X=e.pageX,fdSizeAndPosition.Y=e.pageY,fdSizeAndPosition.gapPX=getRootElementFontSize()*fdSizeAndPosition.gapEM,fdSizeAndPosition.abuttingEl=n,e.currentTarget.classList.contains("fd_leftupper_corner"))window.document.addEventListener("mousemove",fdSizeAndPosition.resizingMethod=doLUResizing,!0);else if(e.currentTarget.classList.contains("fd_rightupper_corner"))window.document.addEventListener("mousemove",fdSizeAndPosition.resizingMethod=doRUResizing,!0);else if(e.currentTarget.classList.contains("fd_leftbottom_corner"))window.document.addEventListener("mousemove",fdSizeAndPosition.resizingMethod=doLBResizing,!0);else if(e.currentTarget.classList.contains("fd_rightbottom_corner"))window.document.addEventListener("mousemove",fdSizeAndPosition.resizingMethod=doRBResizing,!0);else if(e.currentTarget.classList.contains("fd_ruler_top"))window.document.addEventListener("mousemove",fdSizeAndPosition.resizingMethod=doUResizing,!0);else if(e.currentTarget.classList.contains("fd_ruler_left"))window.document.addEventListener("mousemove",fdSizeAndPosition.resizingMethod=doLResizing,!0);else if(e.currentTarget.classList.contains("fd_ruler_right"))if(fdSizeAndPosition.abuttingEl){var i=fdSizeAndPosition.el.offsetWidth/window.innerWidth*100;fdSizeAndPosition.el.style.width=i+"%",fdSizeAndPosition.el.style.right="auto",fdSizeAndPosition.abuttingEl.style.width=100-i+"%",fdSizeAndPosition.abuttingEl.style.right="auto",window.document.addEventListener("mousemove",fdSizeAndPosition.resizingMethod=doJointRResizing,!0)}else window.document.addEventListener("mousemove",fdSizeAndPosition.resizingMethod=doRResizing,!0);else e.currentTarget.classList.contains("fd_ruler_bottom")&&window.document.addEventListener("mousemove",fdSizeAndPosition.resizingMethod=doBResizing,!0);return window.document.addEventListener("mouseup",stopResizing,!0),fdSizeAndPosition},doRBResizing=function(e){return fdSizeAndPosition.el?(e.stopPropagation(),e.preventDefault(),e.pageX>=0&&e.pageX<=window.innerWidth&&(fdSizeAndPosition.nX=fdSizeAndPosition.initWidth+(e.pageX-fdSizeAndPosition.X),fdSizeAndPosition.nX<=fdSizeAndPosition.gapPX?fdSizeAndPosition.el.style.width=fdSizeAndPosition.gapPX+"px":fdSizeAndPosition.el.style.width=fdSizeAndPosition.nX+"px"),e.pageY>=0&&e.pageY<=window.innerHeight&&(fdSizeAndPosition.nY=fdSizeAndPosition.initHeight+(e.pageY-fdSizeAndPosition.Y),fdSizeAndPosition.nY<=fdSizeAndPosition.gapPX?fdSizeAndPosition.el.style.height=fdSizeAndPosition.gapPX+"px":fdSizeAndPosition.el.style.height=fdSizeAndPosition.nY+"px"),!1):!0},doLBResizing=function(e){return fdSizeAndPosition.el?(e.stopPropagation(),e.preventDefault(),e.pageX>=0&&e.pageX<=window.innerWidth&&(fdSizeAndPosition.nX=fdSizeAndPosition.initWidth-(e.pageX-fdSizeAndPosition.X),fdSizeAndPosition.nX<=fdSizeAndPosition.gapPX?(fdSizeAndPosition.el.style.width=fdSizeAndPosition.gapPX+"px",fdSizeAndPosition.el.style.left=fdSizeAndPosition.initLeft+fdSizeAndPosition.initWidth-fdSizeAndPosition.gapPX+"px"):(fdSizeAndPosition.el.style.width=fdSizeAndPosition.nX+"px",fdSizeAndPosition.el.style.left=fdSizeAndPosition.initLeft+(e.pageX-fdSizeAndPosition.X)+"px")),e.pageY>=0&&e.pageY<=window.innerHeight&&(fdSizeAndPosition.nY=fdSizeAndPosition.initHeight+(e.pageY-fdSizeAndPosition.Y),fdSizeAndPosition.nY<=fdSizeAndPosition.gapPX?fdSizeAndPosition.el.style.height=fdSizeAndPosition.gapPX+"px":fdSizeAndPosition.el.style.height=fdSizeAndPosition.nY+"px"),!1):!0},doLUResizing=function(e){return fdSizeAndPosition.el?(e.stopPropagation(),e.preventDefault(),e.pageX>=0&&e.pageX<=window.innerWidth&&(fdSizeAndPosition.nX=fdSizeAndPosition.initWidth-(e.pageX-fdSizeAndPosition.X),fdSizeAndPosition.nX<=fdSizeAndPosition.gapPX?(fdSizeAndPosition.el.style.width=fdSizeAndPosition.gapPX+"px",fdSizeAndPosition.el.style.left=fdSizeAndPosition.initLeft+fdSizeAndPosition.initWidth-fdSizeAndPosition.gapPX+"px"):(fdSizeAndPosition.el.style.width=fdSizeAndPosition.nX+"px",fdSizeAndPosition.el.style.left=fdSizeAndPosition.initLeft+(e.pageX-fdSizeAndPosition.X)+"px")),e.pageY>=0&&e.pageY<=window.innerHeight&&(fdSizeAndPosition.nY=fdSizeAndPosition.initHeight-(e.pageY-fdSizeAndPosition.Y),fdSizeAndPosition.nY<=fdSizeAndPosition.gapPX?(fdSizeAndPosition.el.style.height=fdSizeAndPosition.gapPX+"px",fdSizeAndPosition.el.style.top=fdSizeAndPosition.initTop+fdSizeAndPosition.initHeight-fdSizeAndPosition.gapPX+"px"):(fdSizeAndPosition.el.style.height=fdSizeAndPosition.nY+"px",fdSizeAndPosition.el.style.top=fdSizeAndPosition.initTop+(e.pageY-fdSizeAndPosition.Y)+"px")),!1):!0},doRUResizing=function(e){return fdSizeAndPosition.el?(e.stopPropagation(),e.preventDefault(),e.pageX>=0&&e.pageX<=window.innerWidth&&(fdSizeAndPosition.nX=fdSizeAndPosition.initWidth+(e.pageX-fdSizeAndPosition.X),fdSizeAndPosition.nX<=fdSizeAndPosition.gapPX?fdSizeAndPosition.el.style.width=fdSizeAndPosition.gapPX+"px":fdSizeAndPosition.el.style.width=fdSizeAndPosition.nX+"px"),e.pageY>=0&&e.pageY<=window.innerHeight&&(fdSizeAndPosition.nY=fdSizeAndPosition.initHeight-(e.pageY-fdSizeAndPosition.Y),fdSizeAndPosition.nY<=fdSizeAndPosition.gapPX?(fdSizeAndPosition.el.style.height=fdSizeAndPosition.gapPX+"px",fdSizeAndPosition.el.style.top=fdSizeAndPosition.initTop+fdSizeAndPosition.initHeight-fdSizeAndPosition.gapPX+"px"):(fdSizeAndPosition.el.style.height=fdSizeAndPosition.nY+"px",fdSizeAndPosition.el.style.top=fdSizeAndPosition.initTop+(e.pageY-fdSizeAndPosition.Y)+"px")),!1):!0},doUResizing=function(e){return fdSizeAndPosition.el?(e.stopPropagation(),e.preventDefault(),e.pageY<0||e.pageY>window.innerHeight?void 0:(fdSizeAndPosition.nY=fdSizeAndPosition.initHeight-(e.pageY-fdSizeAndPosition.Y),fdSizeAndPosition.nY<=fdSizeAndPosition.gapPX?(fdSizeAndPosition.el.style.height=fdSizeAndPosition.gapPX+"px",fdSizeAndPosition.el.style.top=fdSizeAndPosition.initTop+fdSizeAndPosition.initHeight-fdSizeAndPosition.gapPX+"px"):(fdSizeAndPosition.el.style.height=fdSizeAndPosition.nY+"px",fdSizeAndPosition.el.style.top=fdSizeAndPosition.initTop+(e.pageY-fdSizeAndPosition.Y)+"px"),!1)):!0},doLResizing=function(e){return fdSizeAndPosition.el?(e.stopPropagation(),e.preventDefault(),e.pageX<0||e.pageX>window.innerWidth?void 0:(fdSizeAndPosition.nX=fdSizeAndPosition.initWidth-(e.pageX-fdSizeAndPosition.X),fdSizeAndPosition.nX<=fdSizeAndPosition.gapPX?(fdSizeAndPosition.el.style.width=fdSizeAndPosition.gapPX+"px",fdSizeAndPosition.el.style.left=fdSizeAndPosition.initLeft+fdSizeAndPosition.initWidth-fdSizeAndPosition.gapPX+"px"):(fdSizeAndPosition.el.style.width=fdSizeAndPosition.nX+"px",fdSizeAndPosition.el.style.left=fdSizeAndPosition.initLeft+(e.pageX-fdSizeAndPosition.X)+"px"),!1)):!0},doRResizing=function(e){return fdSizeAndPosition.el?(e.stopPropagation(),e.preventDefault(),e.pageX<0||e.pageX>window.innerWidth?void 0:(fdSizeAndPosition.nX=fdSizeAndPosition.initWidth+(e.pageX-fdSizeAndPosition.X),fdSizeAndPosition.nX<=fdSizeAndPosition.gapPX?fdSizeAndPosition.el.style.width=fdSizeAndPosition.gapPX+"px":fdSizeAndPosition.el.style.width=fdSizeAndPosition.nX+"px",!1)):!0},doBResizing=function(e){return fdSizeAndPosition.el?(e.stopPropagation(),e.preventDefault(),e.pageY<0||e.pageY>window.innerHeight?void 0:(fdSizeAndPosition.nY=fdSizeAndPosition.initHeight+(e.pageY-fdSizeAndPosition.Y),fdSizeAndPosition.nY<=fdSizeAndPosition.gapPX?fdSizeAndPosition.el.style.height=fdSizeAndPosition.gapPX+"px":fdSizeAndPosition.el.style.height=fdSizeAndPosition.nY+"px",!1)):!0},doJointRResizing=function(e){if(!fdSizeAndPosition.el)return!0;if(e.stopPropagation(),e.preventDefault(),!(e.pageX<0||e.pageX>window.innerWidth)){fdSizeAndPosition.nX=fdSizeAndPosition.initWidth+(e.pageX-fdSizeAndPosition.X),fdSizeAndPosition.nX<=fdSizeAndPosition.gapPX&&(fdSizeAndPosition.nX=fdSizeAndPosition.gapPX);var t=fdSizeAndPosition.abuttingEl.offsetWidth-(fdSizeAndPosition.nX-fdSizeAndPosition.el.offsetWidth);return t<fdSizeAndPosition.gapPX&&(fdSizeAndPosition.nX=fdSizeAndPosition.nX-(fdSizeAndPosition.gapPX-t)),fdSizeAndPosition.el.style.width=fdSizeAndPosition.nX/window.innerWidth*100+"%",fdSizeAndPosition.abuttingEl.style.left=fdSizeAndPosition.nX/window.innerWidth*100+"%",fdSizeAndPosition.abuttingEl.style.width=100-fdSizeAndPosition.nX/window.innerWidth*100+"%",!1}},stopResizing=function(e){if(e.stopPropagation(),e.preventDefault(),0!==fdSizeAndPosition.el.FDD.aspectRatio){var t=fdSizeAndPosition.el.clientHeight;fdSizeAndPosition.el.style.height=t+"px",fdSizeAndPosition.el.style.width=t*fdSizeAndPosition.el.FDD.aspectRatio+"px"}fdSizeAndPosition.el=null,fdSizeAndPosition.abuttingEl=null,window.document.removeEventListener("mousemove",fdSizeAndPosition.resizingMethod,!0),window.document.removeEventListener("mouseup",stopResizing,!0)},hideFD=function(e){e.stopPropagation(),e.preventDefault();var t=_getFDRootNode(e);t.style.display="none"},removeFD=function(e){e.stopPropagation(),e.preventDefault();var t=_getFDRootNode(e);t.parentNode.removeChild(t)},maximizeFD=function(e){e.stopPropagation(),e.preventDefault();var t=_getFDRootNode(e);"maximizeFD"!=t.FDD.lastAction&&(t.FDD.left=t.offsetLeft,t.FDD.top=t.offsetTop,t.FDD.width=t.clientWidth,t.FDD.height=t.clientHeight),t.style.top=t.FDD.bornArea.offsetTop+"px",t.style.left=t.FDD.bornArea.offsetLeft+"px",t.style.height=t.FDD.bornArea.scrollHeight+"px",t.style.width=t.FDD.bornArea.scrollWidth+"px",t.querySelector(".fd_maximize").style.display="none",t.querySelector(".fd_normilize").style.display="inline-block",t.FDD.lastAction="maximizeFD"},minimizeFD=function(e){e.stopPropagation(),e.preventDefault();var t=_getFDRootNode(e);"minimizeFD"!=t.FDD.lastAction&&(t.FDD.left=t.offsetLeft,t.FDD.top=t.offsetTop,t.FDD.width=t.clientWidth,t.FDD.height=t.clientHeight),fdSizeAndPosition.gapPX=getRootElementFontSize()*fdSizeAndPosition.gapEM,t.style.top=t.FDD.bornArea.offsetTop+t.FDD.bornArea.offsetHeight-fdSizeAndPosition.gapPX+"px",t.style.left=t.FDD.bornArea.offsetLeft+t.FDD.bornArea.offsetWidth-t.FDD.widthInitial+"px",t.style.height=fdSizeAndPosition.gapPX+"px",t.style.width=t.FDD.widthInitial+"px",t.querySelector(".fd_maximize").style.display="none",t.querySelector(".fd_normilize").style.display="inline-block",t.FDD.lastAction="minimizeFD"},normalizeFD=function(e){e.stopPropagation(),e.preventDefault();var t=_getFDRootNode(e);"maximizeFD"==t.FDD.lastAction||"minimizeFD"==t.FDD.lastAction?(t.style.top=t.FDD.top+"px",t.style.left=t.FDD.left+"px",t.style.height=t.FDD.height+"px",t.style.width=t.FDD.width+"px"):(t.style.top=t.FDD.topInitial+"px",t.style.left=t.FDD.leftInitial+"px",t.style.height=t.FDD.heightInitial+"px",t.style.width=t.FDD.widthInitial+"px"),t.querySelector(".fd_maximize").style.display="inline-block",t.querySelector(".fd_normilize").style.display="none",t.FDD.lastAction="normalizeFD"},bringToTop=function(e){e.style.zIndex=++FloatDivMng.TOP_Z},stickToTop=function(e){bringToTop(e)},hideElementByMouseMoving=function(e,t){e.preventDefault(),e.stopPropagation();for(var n=e.relatedTarget;n;){if(n===e.currentTarget)return;n=n.parentNode}e.currentTarget.style.display="none",t===!0&&e.currentTarget.parentNode&&e.currentTarget.parentNode.removeChild(e.currentTarget)},removeElementByMouseMoving=function(e){hideElementByMouseMoving(e,!0)},loadHtmlPage=function(e,t,n,i){var s=window.document.querySelector("#_html_loader");for(s||(s=window.document.createElement("div"),s.id="_html_loader",s.style.display="none",window.document.body.appendChild(s));s.firstChild;)s.removeChild(s.firstChild);var o=new XMLHttpRequest;if(o.open("GET",e+"?anticache="+(new Date).getTime(),n),o.send(),!n){s.innerHTML=o.responseText;for(var r=s.querySelector(t);s.firstChild;)s.removeChild(s.firstChild);return r}o.onreadystatechange=function(){if(4==o.readyState)if(200==o.status){s.innerHTML=o.responseText;for(var e=s.querySelector(t);s.firstChild;)s.removeChild(s.firstChild);i.appendChild(e)}else{var n=window.document.createElement("span");n.textContent="Error loading document",i.appendChild(n)}}},MessengerUIMng={isUIActivated:function(){return!0}},alertError=function(e,t){if(!MessengerUIMng.isUIActivated())return void logMessage("error",e,t);t&&(t.preventDefault(),t.stopPropagation());var n=FloatDivMng.createFd("#fd_popup_template");n.querySelector(".fd_header").classList.add("alert_error_header"),n.querySelector(".fd_body").classList.add("alert_error_body"),n.querySelector(".fd_footer").classList.add("alert_error_footer"),n.querySelector(".fd_icon").src=FloatDivMng.pathPrefix+"_img/common/warning.png";
var i=n.querySelector(".fp_popup_msg");e instanceof Array?(e.forEach(function(e){var t=aCtx().mUI.mWnd.document.createElement("span");t.textContent=e,t.classList.add("block"),i.appendChild(t)}),n.style.height=parseInt(aCtx().mUI.mWnd.getComputedStyle(n).height)+getRootElementFontSize()*(e.length-1)+"px"):i.textContent=e,FloatDivMng.setFDPosition(n,t),stickToTop(n)},alertInfo=function(e,t){if(!MessengerUIMng.isUIActivated())return void logMessage("info",e,t);t&&(t.preventDefault(),t.stopPropagation());var n=FloatDivMng.createFd("#fd_popup_template");n.querySelector(".fd_header").classList.add("alert_info_header"),n.querySelector(".fd_body").classList.add("alert_info_body"),n.querySelector(".fd_footer").classList.add("alert_info_footer"),n.querySelector(".fd_icon").src=FloatDivMng.pathPrefix+"_img/common/info.png";var i=n.querySelector(".fp_popup_msg");e instanceof Array?(e.forEach(function(e){var t=aCtx().mUI.mWnd.document.createElement("span");t.textContent=e,t.classList.add("block"),i.appendChild(t)}),n.style.height=parseInt(aCtx().mUI.mWnd.getComputedStyle(n).height)+getRootElementFontSize()*(e.length-1)+"px"):i.textContent=e,FloatDivMng.setFDPosition(n,t),stickToTop(n)},showInfo=function(e,t){if(!MessengerUIMng.isUIActivated())return void logMessage("info",e,t);t&&(t.preventDefault(),t.stopPropagation());var n=FloatDivMng.createFd("#fd_frame_template"),i=n.querySelector(".fd_body");i.classList.add("show_info_body"),(e instanceof String||"string"==typeof e)&&(e=e.split("\n")),e instanceof Array?(e.forEach(function(e){var t=aCtx().mUI.mWnd.document.createElement("span");t.textContent=e,t.classList.add("block"),i.appendChild(t)}),n.style.height=parseInt(aCtx().mUI.mWnd.getComputedStyle(n).height)+getRootElementFontSize()*(e.length-1)+"px"):i.textContent=e,FloatDivMng.setFDPosition(n,t),stickToTop(n)},Option=function(e,t,n,i,s){this.title=e,this.action=t,this.img=n,this.tooltip=i,this.isDefault=s===!0},optionDlg=function(e,t,n,i,s){n&&(n.preventDefault(),n.stopPropagation());var o=FloatDivMng.createFd("#fd_frame_template");o.classList.add("option_dlg"),o.querySelector(".fd_header").classList.add("alert_info_header"),o.querySelector(".fd_body").classList.add("alert_info_body"),o.querySelector(".fd_footer").classList.add("alert_info_footer"),o.querySelector(".fd_icon").src=FloatDivMng.pathPrefix+"_img/common/questionMark.png",o.querySelector(".fd_title").textContent=i||"Choose an option";var r=o.querySelector(".fd_body"),a=aCtx().mUI.mWnd.document.createElement("div");e instanceof Array?(e.forEach(function(e){var t=aCtx().mUI.mWnd.document.createElement("span");t.textContent=e,t.classList.add("block"),a.appendChild(t)}),o.style.height=parseInt(aCtx().mUI.mWnd.getComputedStyle(o).height)+getRootElementFontSize()*(e.length-1)+"px"):a.textContent=e,r.appendChild(a);var d=null;return t.forEach(function(e){var t=aCtx().mUI.mWnd.document.createElement("button");if(t.textContent=e.title,t.onclick=e.action,e.img){var n=aCtx().mUI.mWnd.document.createElement("img");n.src=FloatDivMng.pathPrefix+e.img,t.appendChild(n)}r.appendChild(t),e.isDefault===!0&&(d=t)}),o.querySelector(".fd_close").onclick=function(e){s&&s(e),removeFD(e)}.bind(this),FloatDivMng.setFDPosition(o,n),d&&d.focus(),o},RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;if(navigator.mozGetUserMedia)console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=function(e,t){return maybeFixConfiguration(e),new mozRTCPeerConnection(e,t)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,MediaStreamTrack.getSources=function(e){setTimeout(function(){var t=[{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}];e(t)},0)},window.createIceServer=function(e,t,n){var i=null,s=e.split(":");if(0===s[0].indexOf("stun"))i={url:e};else if(0===s[0].indexOf("turn"))if(27>webrtcDetectedVersion){var o=e.split("?");(1===o.length||0===o[1].indexOf("transport=udp"))&&(i={url:o[0],credential:n,username:t})}else i={url:e,credential:n,username:t};return i},window.createIceServers=function(e,t,n){for(var i=[],s=0;s<e.length;s++){var o=window.createIceServer(e[s],t,n);null!==o&&i.push(o)}return i},attachMediaStream=function(e,t){console.log("Attaching media stream"),e.mozSrcObject=t},reattachMediaStream=function(e,t){console.log("Reattaching media stream"),e.mozSrcObject=t.mozSrcObject};else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome";var result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);webrtcDetectedVersion=null!==result?parseInt(result[2],10):999,window.createIceServer=function(e,t,n){var i=null,s=e.split(":");return 0===s[0].indexOf("stun")?i={url:e}:0===s[0].indexOf("turn")&&(i={url:e,credential:n,username:t}),i},window.createIceServers=function(e,t,n){return{urls:e,credential:n,username:t}},RTCPeerConnection=function(e,t){return new webkitRTCPeerConnection(e,t)},getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(e,t){"undefined"!=typeof e.srcObject?e.srcObject=t:"undefined"!=typeof e.mozSrcObject?e.mozSrcObject=t:"undefined"!=typeof e.src?e.src=URL.createObjectURL(t):console.log("Error attaching stream to element.")},reattachMediaStream=function(e,t){e.src=t.src}}else navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)?(console.log("This appears to be Edge"),webrtcDetectedBrowser="edge",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)[2],10),webrtcMinimumVersion=10525,getUserMedia=navigator.getUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,MediaStreamTrack.getSources=function(e){setTimeout(function(){var t=[{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}];e(t)},0)},attachMediaStream=function(e,t){console.log("Attaching media stream"),e.srcObject=t},reattachMediaStream=function(e,t){console.log("Reattaching media stream"),e.srcObject=t.srcObject},RTCIceGatherer&&(window.RTCIceCandidate=function(e){return e},window.RTCSessionDescription=function(e){return e},window.RTCPeerConnection=function(e){var t=this;if(this.onicecandidate=null,this.onaddstream=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return t.localStreams},this.getRemoteStreams=function(){return t.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},e&&e.iceTransportPolicy)switch(e.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=e.iceTransportPolicy;break;case"none":console.warn('can not map iceTransportPolicy none,falling back to "all"')}this.tracks=[],this._iceCandidates=[],this._peerConnectionId="PC_"+Math.floor(65536*Math.random()),this._cname=Math.random().toString(36).substr(2,10)},window.RTCPeerConnection.prototype.addStream=function(e){this.localStreams.push(e.clone())},window.RTCPeerConnection.prototype.removeStream=function(e){var t=this.localStreams.indexOf(e);t>-1&&this.localStreams.splice(t,1)},window.RTCPeerConnection.prototype._toCandidateJSON=function(e){var t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");for(var n={foundation:t[0],component:t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)"raddr"===t[i]?n.relatedAddress=t[i+1]:"rport"===t[i]?n.relatedPort=parseInt(t[i+1],10):"generation"===t[i]?n.generation=t[i+1]:"tcptype"===t[i]&&(n.tcpType=t[i+1]);return n},window.RTCPeerConnection.prototype._toCandidateSDP=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),("srflx"===n||"prflx"===n||"relay"===n)&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"TCP"===e.protocol.toUpperCase()&&(t.push("tcptype"),t.push(e.tcpType)),"a=candidate:"+t.join(" ")},window.RTCPeerConnection.prototype._parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.numChannels=3===t.length?parseInt(t[2],10):1,n},window.RTCPeerConnection.prototype._getRemoteCapabilities=function(e){var t,n={codecs:[],headerExtensions:[],fecMechanisms:[]},i=e.split("\r\n"),s=i[0].substr(2).split(" "),o=function(e){return 0===e.indexOf("a=rtpmap:"+s[t])},r=function(e){return 0===e.indexOf("a=fmtp:"+s[t])},a=function(e){for(var n,i={},o=e.substr(("a=fmtp:"+s[t]).length+1).split(";"),r=0;r<o.length;r++)n=o[r].split("="),i[n[0].trim()]=n[1];return console.log("fmtp",s[t],i),i},d=function(e){return 0===e.indexOf("a=rtcp-fb:"+s[t])},c=function(e){var n=e.substr(("a=rtcp-fb:"+s[t]).length+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}};for(t=3;t<s.length;t++){var l=i.filter(o)[0];if(l){var u=this._parseRtpMap(l);if("opus"!==u.name.toLowerCase()&&"pcma"!==u.name.toLowerCase()&&"pcmu"!==u.name.toLowerCase()&&"h264"!==u.name.toLowerCase()&&"x-h264uc"!==u.name.toLowerCase()&&"vp8"!==u.name.toLowerCase())continue;var h=i.filter(r);u.parameters=h.length?a(h[0]):{},u.rtcpFeedback=i.filter(d).map(c),n.codecs.push(u)}}return n},window.RTCPeerConnection.prototype._capabilitiesToSDP=function(e){var t="";return e.codecs.forEach(function(e){var n=e.payloadType;void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),t+="a=rtpmap:"+n+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n",e.parameters&&e.parameters.length&&(t+="a=ftmp:"+n+" ",Object.keys(e.parameters).forEach(function(n){t+=n+"="+e.parameters[n]}),t+="\r\n"),e.rtcpFeedback&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+" "+e.parameter+"\r\n"})}),t},window.RTCPeerConnection.prototype._getCommonCapabilities=function(e,t){console.warn(e),console.warn(t);var n={codecs:[],headerExtensions:[],fecMechanisms:[]};return e.codecs.forEach(function(e){for(var i=0;i<t.codecs.length;i++){var s=t.codecs[i];if(e.name.toLowerCase()===s.name.toLowerCase()&&e.clockRate===s.clockRate&&e.numChannels===s.numChannels){n.codecs.push(s);break}}}),e.headerExtensions.forEach(function(e){for(var i=0;i<t.headerExtensions.length;i++){var s=t.headerExtensions[i];if(e.uri===s.uri){n.headerExtensions.push(s);break}}}),n},window.RTCPeerConnection.prototype._getDtlsParameters=function(e,t){var n=e.split("\r\n");n=n.concat(t.split("\r\n"));var i=n.filter(function(e){return 0===e.indexOf("a=fingerprint:")});i=i[0].substr(14);var s={role:"auto",fingerprints:[{algorithm:i.split(" ")[0],value:i.split(" ")[1]}]};return s},window.RTCPeerConnection.prototype._dtlsParametersToSDP=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},window.RTCPeerConnection.prototype._getIceParameters=function(e,t){var n=e.split("\r\n");n=n.concat(t.split("\r\n"));var i={usernameFragment:n.filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:n.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)};return i},window.RTCPeerConnection.prototype._iceParametersToSDP=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},window.RTCPeerConnection.prototype._getEncodingParameters=function(e){return{ssrc:e,codecPayloadType:0,fec:0,rtx:0,priority:1,maxBitrate:2e6,minQuality:0,framerateBias:.5,resolutionScale:1,framerateScale:1,active:!0,dependencyEncodingId:void 0,encodingId:void 0}},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(e,t){var n=this,i=new RTCIceGatherer(n.iceOptions),s=new RTCIceTransport(i);i.onlocalcandidate=function(i){var o={};o.candidate={sdpMid:e,sdpMLineIndex:t};var r=i.candidate,a=!(r&&Object.keys(r).length>0);a?o.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates":(r.component="RTCP"===s.component?2:1,o.candidate.candidate=n._toCandidateSDP(r)),null!==n.onicecandidate&&(n.localDescription&&""===n.localDescription.type?n._iceCandidates.push(o):n.onicecandidate(o))},s.onicestatechange=function(){console.log(n._peerConnectionId,"ICE state change",s.state),n._updateIceConnectionState(s.state)};var o=new RTCDtlsTransport(s);return o.ondtlsstatechange=function(){},o.onerror=function(e){console.error("dtls error",e)},{iceGatherer:i,iceTransport:s,dtlsTransport:o}},window.RTCPeerConnection.prototype.setLocalDescription=function(e){var t=this;if("offer"===e.type)e.ortc&&(this.tracks=e.ortc);else if("answer"===e.type){var n=t.remoteDescription.sdp.split("\r\nm="),i=n.shift();n.forEach(function(e,n){e="m="+e;var s=t.tracks[n].iceGatherer,o=t.tracks[n].iceTransport,r=t.tracks[n].dtlsTransport,a=t.tracks[n].rtpSender,d=t.tracks[n].localCapabilities,c=t.tracks[n].remoteCapabilities,l=t.tracks[n].sendSSRC,u=t.tracks[n].recvSSRC;for(var h in t.tracks[n].remoteCandidates){var g=t.tracks[n].remoteCandidates[h];t.addIceCandidate(g)}var f=t._getIceParameters(e,i);o.start(s,f,"controlled");var p=t._getDtlsParameters(e,i);if(r.start(p),a){var m=t._getCommonCapabilities(d,c);m.muxId=l,m.encodings=[t._getEncodingParameters(l)],m.rtcp={cname:t._cname,reducedSize:!1,ssrc:u,mux:!0},a.send(m)}})}switch(this.localDescription=e,e.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable")}return window.setTimeout(function(){t._iceCandidates.forEach(function(e){null!==t.onicecandidate&&t.onicecandidate(e)}),t._iceCandidates=[]},50),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),new Promise(function(e){e()})},window.RTCPeerConnection.prototype.setRemoteDescription=function(e){var t=this,n=e.sdp.split("\r\nm="),i=n.shift(),s=new MediaStream;switch(n.forEach(function(n,o){n="m="+n;var r,a,d,c,l,u,h,g,f,p,m,v=n.split("\r\n"),C=v[0].substr(2).split(" "),y=C[0],b=v.filter(function(e){return 0===e.indexOf("a=mid:")})[0].substr(6);if("offer"===e.type){var S=t._createIceAndDtlsTransports(b,o),M=RTCRtpReceiver.getCapabilities(y);if(p=t._getRemoteCapabilities(n),r=v.filter(function(e){return 0===e.indexOf("a=ssrc:")&&0===e.split(" ")[1].indexOf("cname:")}),h=1001*(2*o+2),r&&(g=r[0].split(" ")[0].split(":")[1],f=r[0].split(" ")[1].split(":")[1]),u=new RTCRtpReceiver(S.dtlsTransport,y),m=t._getCommonCapabilities(M,p),m.muxId=g,m.encodings=[t._getEncodingParameters(g)],m.rtcp={cname:f,reducedSize:!1,ssrc:h,mux:!0},console.warn("rtpReceiver:",m),u.receive(m),s.addTrack(u.track),t.localStreams.length>0&&t.localStreams[0].getTracks().length>=o){var P=t.localStreams[0].getTracks()[o];l=new RTCRtpSender(P,S.dtlsTransport)}t.tracks[o]={iceGatherer:S.iceGatherer,iceTransport:S.iceTransport,dtlsTransport:S.dtlsTransport,localCapabilities:M,remoteCapabilities:p,rtpSender:l,rtpReceiver:u,kind:y,mid:b,sendSSRC:h,recvSSRC:g,remoteCandidates:[]}}else a=t.tracks[o].iceGatherer,d=t.tracks[o].iceTransport,c=t.tracks[o].dtlsTransport,l=t.tracks[o].rtpSender,u=t.tracks[o].rtpReceiver,h=t.tracks[o].sendSSRC,g=t.tracks[o].recvSSRC;var I=t._getIceParameters(n,i),w=t._getDtlsParameters(n,i),T=function(e){return 0===e.indexOf("a=candidate:")},R=v.filter(T);if(R.length){for(var A=0;A<R.length;A++){var U={candidate:R[A].substr(2),sdpMid:y,sdpMLineIndex:o};t.tracks[o].remoteCandidates.push(U)}var D={candidate:"candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates",sdpMid:y,sdpMLineIndex:o};t.tracks[o].remoteCandidates.push(D)}if("answer"===e.type){for(var _ in t.tracks[o].remoteCandidates){var U=t.tracks[o].remoteCandidates[_];t.addIceCandidate(U)}d.start(a,I,"controlling"),c.start(w),p=t._getRemoteCapabilities(n);var N=v.filter(function(e){return 0===e.indexOf("a=ssrc:")}).length>0;u&&N&&(r=v.filter(function(e){return 0===e.indexOf("a=ssrc:")&&0===e.split(" ")[1].indexOf("cname:")}),r&&(g=r[0].split(" ")[0].split(":")[1],f=r[0].split(" ")[1].split(":")[1]),m=p,m.muxId=g,m.encodings=[t._getEncodingParameters(g)],m.rtcp={cname:f,reducedSize:!1,ssrc:h,mux:!0},console.warn("rtpReceiver:",m,y),u.receive(m,y),s.addTrack(u.track),t.tracks[o].recvSSRC=g),l&&(m=p,m.muxId=h,m.encodings=[t._getEncodingParameters(h)],m.rtcp={cname:t._cname,reducedSize:!1,ssrc:g,mux:!0},console.warn("rtpSender:",m),l.send(m))}}),this.remoteDescription=e,e.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable")}return window.setTimeout(function(){null!==t.onaddstream&&s.getTracks().length&&window.setTimeout(function(){t.onaddstream({stream:s})},0)},0),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),new Promise(function(e){e()})},window.RTCPeerConnection.prototype.close=function(){this.tracks.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._updateSignalingState("closed"),this._updateIceConnectionState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(e){this.signalingState=e,null!==this.onsignalingstatechange&&this.onsignalingstatechange()},window.RTCPeerConnection.prototype._updateIceConnectionState=function(e){var t=this;if(this.iceConnectionState!==e){var n=t.tracks.every(function(t){return t.iceTransport.state===e});n&&(t.iceConnectionState=e,null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange())}},window.RTCPeerConnection.prototype.createOffer=function(){var e,t=this;1===arguments.length&&"function"!=typeof arguments[0]?e=arguments[0]:3===arguments.length&&(e=arguments[2]);var n=[],i=0,s=0;for(this.localStreams.length&&(i=this.localStreams[0].getAudioTracks().length,s=this.localStreams[0].getAudioTracks().length),e&&(e.mandatory?(e.mandatory.OfferToReceiveAudio?i=1:e.mandatory.OfferToReceiveAudio===!1&&(i=0),e.mandatory.OfferToReceiveVideo?s=1:e.mandatory.OfferToReceiveVideo===!1&&(s=0)):(void 0!==e.offerToReceiveAudio&&(i=e.offerToReceiveAudio),void 0!==e.offerToReceiveVideo&&(s=e.offerToReceiveVideo))),this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(e){n.push({kind:e.kind,track:e,wantReceive:"audio"===e.kind?i>0:s>0}),"audio"===e.kind?i--:"video"===e.kind&&s--});i>0||s>0;)i>0&&(n.push({kind:"audio",wantReceive:!0}),i--),s>0&&(n.push({kind:"video",wantReceive:!0}),s--);var o="v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n",r=[];n.forEach(function(e,n){var i,s,a=e.track,d=e.kind,c=Math.random().toString(36).substr(2,10),l=t._createIceAndDtlsTransports(c,n),u=RTCRtpSender.getCapabilities(d),h=1001*(2*n+1);a&&(i=new RTCRtpSender(a,l.dtlsTransport));var g;e.wantReceive&&(g=new RTCRtpReceiver(l.dtlsTransport,d)),r[n]={iceGatherer:l.iceGatherer,iceTransport:l.iceTransport,dtlsTransport:l.dtlsTransport,localCapabilities:u,remoteCapabilities:null,rtpSender:i,rtpReceiver:g,kind:d,mid:c,sendSSRC:h,recvSSRC:s,remoteCandidates:[]},o+="m="+d+" 9 UDP/TLS/RTP/SAVPF ",o+=u.codecs.map(function(e){return e.preferredPayloadType}).join(" ")+"\r\n",o+="c=IN IP4 0.0.0.0\r\n",o+="a=rtcp:9 IN IP4 0.0.0.0\r\n",o+=t._iceParametersToSDP(l.iceGatherer.getLocalParameters()),o+=t._dtlsParametersToSDP(l.dtlsTransport.getLocalParameters(),"actpass"),o+="a=mid:"+c+"\r\n",o+=i&&g?"a=sendrecv\r\n":i?"a=sendonly\r\n":g?"a=recvonly\r\n":"a=inactive\r\n",o+="a=rtcp-mux\r\n",o+=t._capabilitiesToSDP(u),a&&(o+="a=msid:"+t.localStreams[0].id+" "+a.id+"\r\n",o+="a=ssrc:"+h+" msid:"+t.localStreams[0].id+" "+a.id+"\r\n"),o+="a=ssrc:"+h+" cname:"+t._cname+"\r\n"});var a=new RTCSessionDescription({type:"offer",sdp:o,ortc:r});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,a),new Promise(function(e){e(a)})},window.RTCPeerConnection.prototype.createAnswer=function(){var e,t=this;1===arguments.length&&"function"!=typeof arguments[0]?e=arguments[0]:3===arguments.length&&(e=arguments[2]);var n="v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n";this.tracks.forEach(function(e){var i=e.iceGatherer,s=e.dtlsTransport,o=e.localCapabilities,r=e.remoteCapabilities,a=e.rtpSender,d=e.rtpReceiver,c=e.kind,l=e.sendSSRC,u=t._getCommonCapabilities(o,r);n+="m="+c+" 9 UDP/TLS/RTP/SAVPF ",n+=u.codecs.map(function(e){return e.payloadType}).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n+=t._iceParametersToSDP(i.getLocalParameters()),n+=t._dtlsParametersToSDP(s.getLocalParameters(),"active"),n+="a=mid:"+e.mid+"\r\n",n+=a&&d?"a=sendrecv\r\n":d?"a=sendonly\r\n":a?"a=recvonly\r\n":"a=inactive\r\n",n+="a=rtcp-mux\r\n",n+=t._capabilitiesToSDP(u),a&&(n+="a=msid:"+t.localStreams[0].id+" "+a.track.id+"\r\n",n+="a=ssrc:"+l+" msid:"+t.localStreams[0].id+" "+a.track.id+"\r\n"),n+="a=ssrc:"+l+" cname:"+t._cname+"\r\n"});var i=new RTCSessionDescription({type:"answer",sdp:n});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,i),new Promise(function(e){e(i)})},window.RTCPeerConnection.prototype.addIceCandidate=function(e){var t=this.tracks[e.sdpMLineIndex];if(console.log("addIceCandidate:",e),t){console.log("track:",t);var n=Object.keys(e.candidate).length>0?this._toCandidateJSON(e.candidate):{};if("endOfCandidates"===n.type&&(n={}),"tcp"===n.protocol&&0===n.port)return n={},void window.setTimeout(function(){t.iceTransport.addRemoteCandidate(n)},5e3);t.iceTransport.addRemoteCandidate(n)}return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),new Promise(function(e){e()})})):console.log("Browser does not appear to be WebRTC-capable");var alertMng={tracingAreaElm:null,trace:function(e,t){if(this.tracingAreaElm||(this.tracingAreaElm=document.querySelector("#tracing_area")),this.tracingAreaElm){var n=document.createElement("div");return n.classList.add("tracing_msg"),t&&n.classList.add(t),n.textContent=e,this.tracingAreaElm.appendChild(n),n.scrollIntoView(),!0}return console.log(e),!0},log:function(e){this.trace(e)},debug:function(e){this.trace(e)},alert:function(e){this.trace(e)||alert(e)},error:function(e){this.trace("ERROR: "+e,"tracing_msg_error")},warn:function(e){this.trace("WARNING: "+e,"tracing_msg_warning")}};genRandomString.charSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",genRandomID.charSet="0123456789";var noOp=function(){};window.onunload=function(){aCtx().getJanusMng().disconnectJanusServer()};var JanusMng={};JanusMng.serverURL="wss://webrtc.realine.net:8189",JanusMng.myusername="user_"+genRandomString(4),JanusMng.myuserid=genRandomID(3),JanusMng.iceServers=[{url:"stun:stun.l.google.com:19302"}],JanusMng.ipv6Support=!1,JanusMng.wsTransport=null,JanusMng.janusSignalSession=null,JanusMng.getOptimalSignalSession=function(){return JanusMng.janusSignalSession},JanusMng.connectJanusServer=function(e){JanusMng.wsTransport=new WSTransport(JanusMng.serverURL),JanusMng.janusSignalSession=new JanusSignalSession(JanusMng.wsTransport),JanusMng.janusSignalSession.createSession(e)},JanusMng.disconnectJanusServer=function(){aCtx().getVideoRoomMng().exitAllRooms(),aCtx().getVideoRoomMng().videoRoomMngPluginHandler.destroyHandler(),JanusMng.janusSignalSession.closeSession(),JanusMng.wsTransport.ws.close(0,"bye")},NotificationMng.prototype.notifyEvent=function(e,t){},PluginHandler.prototype.phOnSignal=function(e){},PluginHandler.prototype.phOnDetached=function(){},PluginHandler.prototype.getId=function(){return this.handlerId},PluginHandler.prototype.getPlugin=function(){return this.plugin},PluginHandler.prototype.attachPlugin=function(e){var t={janus:"attach",plugin:this.plugin};this.janusSignalSession.sendSignal(t,function(t){return this.onPluginAttached(t,e),!0}.bind(this))},PluginHandler.prototype.onPluginAttached=function(e,t){if("success"!==e.janus||!e.data.id)return alertMng.alert(this,"error attaching plugin: "+e),t&&t.onEvError("error attaching plugin: "+e,this),!0;var n=e.data.id;return alertMng.alert("Created pluginHandler: "+n),this.handlerId=n,this.janusSignalSession.pluginHandlers[this.handlerId]=this,t&&t.onEvSuccess("Plugin attached ("+this.getPlugin()+", id="+this.getId()+")",this,this),!0},PluginHandler.prototype.sendMsgSignal=function(e,t,n,i){var s={janus:"message",body:e,handle_id:this.handlerId};n&&(s.jsep=n),this.janusSignalSession.sendSignal(s,t,i)},PluginHandler.prototype.sendPlainSignal=function(e,t,n){e.handle_id=this.handlerId,this.janusSignalSession.sendSignal(e,t,n)},PluginHandler.prototype.destroyHandler=function(e,t){t=t===!0,alertMng.log("Destroying handle "+this.handlerId+" (sync="+t+")"),e=e||new EventCallback;var n={janus:"detach",transaction:genRandomString(12)};this.sendPlainSignal(n),delete this.janusSignalSession.pluginHandlers[this.handlerId],e.onEvSuccess("PluginHandler destroyed")},JSIG.getPluginName=function(e){try{return e.plugindata.plugin}catch(t){return null}},JSIG.getPluginData=function(e,t){try{return e.plugindata.data[t]}catch(n){return null}},JSIG.getJsep=function(e){try{return e.jsep}catch(t){return null}},VideoRoom.construct=function(e){var t=new VideoRoom;return t.setRoomInfo(e),t},VideoRoom.prototype.setRoomInfo=function(e){this.room=e.room,this.description=e.description,this.max_publishers=e.max_publishers,this.bitrate=e.bitrate,this.fir_freq=e.fir_freq,this.record=e.record,this.num_participants=e.num_participants},VideoRoom.prototype.applyRoomInfo=function(e){this.setRoomInfo(e),this.getRoomPanel().querySelector("#participants_amount").textContent=""+this.num_participants},VideoRoom.prototype.addLifeCycleListener=function(e){e&&(this.vrLifeCycleListeners.push(e),e(this,"listener added"))},VideoRoom.prototype.attachPluginAndCreateThisNewVideoRoomOnServer=function(){this.publisherPluginHandler=new PluginHandlerVideoRoom(aCtx().getJanusMng().getOptimalSignalSession(),this);var e=new EventCallback;e.onEvSuccess=function(e,t,n){this.createThisRoomOnServer()}.bind(this),this.publisherPluginHandler.attachPlugin(e)},VideoRoom.prototype.createThisRoomOnServer=function(){var e={request:"create",description:this.description,bitrate:0,record:this.record,rec_dir:aCtx().getVideoRoomMng().RECORDING_DIR+this.publisherPluginHandler.handlerId,publishers:this.max_publishers};this.publisherPluginHandler.sendMsgSignal(e,this.ehOnNewVideoRoomCreated.bind(this))},VideoRoom.prototype.ehOnNewVideoRoomCreated=function(e){var t=JSIG.getPluginData(e,"videoroom");if(alertMng.debug("Event: "+t),"created"!==t)return alertError("Error creating videoRoom"),!1;this.room=JSIG.getPluginData(e,"room"),aCtx().getVideoRoomMng().activeRooms[this.room+""]=this,alertMng.alert("Room created: "+this.room);for(var n=0;n<this.vrLifeCycleListeners.length;n++)try{this.vrLifeCycleListeners[n](this,"created")}catch(i){}return this.joinAsPublisher(),!0},VideoRoom.prototype.joinAsPublisher=function(){this.publisherPluginHandler.joinRoom()},VideoRoom.prototype.attachPluginAndJoinVideoRoom=function(){this.publisherPluginHandler=new PluginHandlerVideoRoom(aCtx().getJanusMng().getOptimalSignalSession(),this);var e=new EventCallback;e.onEvSuccess=function(e,t,n){aCtx().getVideoRoomMng().activeRooms[this.room+""]=this,this.publisherPluginHandler.joinRoom()}.bind(this),this.publisherPluginHandler.attachPlugin(e)},VideoRoom.prototype.publishOwnFeed=function(){this.publisherPluginHandler.publishMyself()},VideoRoom.prototype.unpublishOwnFeed=function(){this.publisherPluginHandler.unpublishMyself()},VideoRoom.prototype.processSignal=function(e){var t=JSIG.getPluginData(e,"room");if(t!=this.room)return void alertMng.error('Wrong roomID: "'+t+'" <> "'+this.room+'"');var n=JSIG.getPluginData(e,"id"),i=JSIG.getPluginData(e,"videoroom");switch(i){case"joined":alertMng.alert("Successfully joined room "+t+" with ID "+n);for(var s=0;s<this.vrLifeCycleListeners.length;s++)try{this.vrLifeCycleListeners[s](this,"joined")}catch(o){}this.publishOwnFeed();var r=JSIG.getPluginData(e,"publishers");if(r){alertMng.debug("Got a list of available publishers/feeds:"),alertMng.debug(r);for(var a=0;a<r.length;a++){var d=r[a].id,c=r[a].display;alertMng.debug("  >> ["+d+"] "+c),this.newRemoteFeed(d,c)}}break;case"event":var r=JSIG.getPluginData(e,"publishers");if(r){alertMng.debug("Got a list of available publishers/feeds:"),alertMng.debug(r);for(var l=0;l<r.length;l++){var d=r[l].id,c=r[l].display;alertMng.debug("  >> ["+d+"] "+c),this.newRemoteFeed(d,c)}return}var u=JSIG.getPluginData(e,"unpublished");if("ok"===u){var h=this.publisherPluginHandler.janusSignalSession.pluginHandlers[e.sender];return void h.onMyselfUnpublished()}var g=JSIG.getPluginData(e,"leaving"),f=g||u;if(f){alertMng.alert("Publisher left: "+f);var p=null;for(var m in this.remoteFeedsPluginHandlers)if(this.remoteFeedsPluginHandlers[m].feed==f){p=this.remoteFeedsPluginHandlers[m];break}if(p){alertMng.debug("Feed "+p.feed+" ("+p.rfdisplay+") has left the room, detaching");var v=this.videoRoomUI.wnd.document.querySelector("#remote_video_panel_"+p.feed);v&&v.parentNode.removeChild(v),g&&(p.destroyHandler(),delete this.remoteFeedsPluginHandlers[p.feed])}return void this.publisherPluginHandler.getRoomInfo()}var C=JSIG.getPluginData(e,"started");if(C)return void alertMng.debug("Feed started: "+C);var y=JSIG.getPluginData(e,"error");if(y)return void alertMng.error(y);alertMng.error("Error: unknown signal's event - "+JSON.stringify(e));break;default:return void alertMng.error("Error: unknown signal - "+JSON.stringify(e))}},VideoRoom.prototype.onRemoteFeedPluginAttached=function(e,t,n,i,s){this.remoteFeedsPluginHandlers[n.handlerId]=n,n.joinRoom(i),alertMng.alert(e),alertMng.alert("PluginHandler has been added for the remote feed.")},VideoRoom.prototype.newRemoteFeed=function(e,t){var n=new EventCallback;n.onEvSuccess=function(n,i,s){this.onRemoteFeedPluginAttached(n,i,s,e,t)}.bind(this);var i=new PluginHandlerVideoRoomFeed(aCtx().getJanusMng().getOptimalSignalSession(),this);i.feed=e,i.rfdisplay=t,i.attachPlugin(n)},VideoRoom.prototype.exitRoom=function(e,t){alertMng.log("Exiting room: "+(this.description||""+this.room)+" (roomId="+this.room+")"),e=e||new EventCallback;for(var n in this.remoteFeedsPluginHandlers){var i=this.remoteFeedsPluginHandlers[n];i&&i.destroyHandler&&i.destroyHandler(e,t)}this.publisherPluginHandler.destroyHandler(e,t);var s=this.getRoomPanel();s.parentNode.removeChild(s),this.videoRoomUI.wnd&&this.videoRoomUI.wnd.close(),delete aCtx().getVideoRoomMng().activeRooms[this.room+""],aCtx().getVideoRoomMng().refreshRoomList()},VideoRoom.prototype.getRoomPanel=function(){return this.roomPanel=this.videoRoomUI.wnd.document.querySelector("#room_panel_"+this.room),this.roomPanel||(this.roomPanel=loadHtmlPage("videoRoomTemplates.html","#room_panel_template"),this.roomPanel=this.videoRoomUI.wnd.document.adoptNode(this.roomPanel),this.roomPanel.id="room_panel_"+this.room,this.roomPanel.querySelector("#roomName").textContent=this.description||""+this.room,this.roomPanel.querySelector("#roomName").title="roomId: "+this.room,this.roomPanel.querySelector("#exit_room_btn").onclick=function(){this.exitRoom()}.bind(this),this.videoRoomUI.wnd.document.body.appendChild(this.roomPanel)),this.roomPanel.classList.remove("hidden"),this.roomPanel},VideoRoom.prototype.toString=function(){return objToString(this)};var VideoRoomMng={};VideoRoomMng.vrSettings={},VideoRoomMng.vrSettings.archiveRoom=!0,VideoRoomMng.vrSettings.MAX_PUBLISHERS=32,
VideoRoomMng.RECORDING_DIR="/tmp/janus/videorooms/",VideoRoomMng.videoRoomMngPluginHandler=null,VideoRoomMng.activeRooms={},VideoRoomMng.availableRooms={},VideoRoomMng.getAspectRatio=function(){return 640/480},VideoRoomMng.onStartingPluginAttached=function(e,t,n){VideoRoomMng.videoRoomMngPluginHandler=n,VideoRoomMng.refreshRoomList(),alertMng.alert(e),alertMng.alert("  -- This is a VideoRoomMng"),document.querySelector("#mm_room_create").disabled=!1,document.querySelector("#mm_rooms_list_btn").disabled=!1},VideoRoomMng.buildRoomsList=function(e){VideoRoomMng.availableRooms={};for(var t=document.querySelector("#mm_rooms_list");t.firstChild;)t.removeChild(t.firstChild);for(var n=document.querySelector("#mm_room_item_template"),i=0;i<e.length;i++){var s=VideoRoom.construct(e[i]);VideoRoomMng.availableRooms[s.room]=s;var o=n.cloneNode(!0);o.id="mm_room_list_item_"+s.room,o.title=s.toString(),o.querySelector(".mm_room").textContent=""+s.room,o.querySelector(".mm_room_description").textContent=s.description,o.querySelector(".mm_room_num_participants").textContent=""+s.num_participants,o.querySelector(".mm_room_join_btn").id="mm_room_join_btn_"+s.room,o.querySelector(".mm_room_join_btn")["data-room"]=s.room+"",o.querySelector(".mm_room_join_btn").onclick=function(){VideoRoomMng.joinExistentVideoRoomAsPublisher(this["data-room"])},o.querySelector(".mm_room_join_btn").textContent=VideoRoomMng.activeRooms[s.room+""]?"To":"Join",t.appendChild(o),o.classList.remove("hidden")}},VideoRoomMng.refreshRoomList=function(){VideoRoomMng.getRoomsList()},VideoRoomMng.getRoomsList=function(){var e={request:"list"};VideoRoomMng.videoRoomMngPluginHandler.sendMsgSignal(e,function(e){return VideoRoomMng.buildRoomsList(e.plugindata.data.list),!0})},VideoRoomMng.switchToRoom=function(e){var t=document.querySelector("#mm_rooms_working_panel");if(t)for(var n=t.querySelectorAll(".room_panel"),i=0;i<n.length;i++)n[i].classList.add("hidden");return e.getRoomPanel()};var resizedTimer;VideoRoomMng.joinExistentVideoRoomAsPublisher=function(e){if(VideoRoomMng.activeRooms[e+""])return void VideoRoomMng.switchToRoom(VideoRoomMng.activeRooms[e+""]);var t=openWin("Application/Modules/Messenger/Controllers/VideoConference/videoRoom.html","");t.onload=function(){var n=new t.VideoRoom(e);n.videoRoomUI.wnd=t,n.attachPluginAndJoinVideoRoom(),n.videoRoomUI.wnd.addEventListener("resize",onWndResized)}},VideoRoomMng.connectServerAndCreateVideoRoom=function(e,t,n,i){t=t||"Room "+genRandomID(4),n=n||VideoRoomMng.vrSettings.archiveRoom,i=i||VideoRoomMng.vrSettings.MAX_PUBLISHERS;var s=new EventCallback;s.onEvSuccess=function(s,o){alertMng.alert("Session created: "+o.sessionId),VideoRoomMng.createNewVideoRoomOnServer(e,t,n,i)},s.onEvError=function(e,t){alertMng.alert("VideoRoom error: "+e)},aCtx().getJanusMng().connectJanusServer(s)},VideoRoomMng.connectServerAndJoinVideoRoom=function(e,t){var n=new EventCallback;n.onEvSuccess=function(e,n){alertMng.alert("Session created: "+n.sessionId),VideoRoomMng.joinExistentVideoRoomAsPublisher(t)},n.onEvError=function(e,t){alertMng.alert("VideoRoom error: "+e)},aCtx().getJanusMng().connectJanusServer(n)},VideoRoomMng.createNewVideoRoomOnServer=function(e,t,n,i){var s=openWin("Application/Modules/Messenger/Controllers/VideoConference/videoRoom.html",t);s.onload=function(){var o=new s.VideoRoom;o.videoRoomUI.wnd=s,o.addLifeCycleListener(e),o.description=t,o.max_publishers=i||VideoRoomMng.vrSettings.MAX_PUBLISHERS,o.record=n===!0,o.attachPluginAndCreateThisNewVideoRoomOnServer(),o.videoRoomUI.wnd.addEventListener("resize",onWndResized)}},VideoRoomMng.exitAllRooms=function(){for(var e in VideoRoomMng.activeRooms){var t=VideoRoomMng.activeRooms[e];t&&t.exitRoom&&t.exitRoom()}},PluginHandlerVideoRoom.prototype=Object.create(PluginHandler.prototype),PluginHandlerVideoRoom.prototype.constructor=PluginHandlerVideoRoom,PluginHandlerVideoRoom.PLUGIN_NAME_VIDEOROOM="janus.plugin.videoroom",PluginHandlerVideoRoom.prototype.getRoomsList=function(){var e={request:"list"};this.sendMsgSignal(e,function(e){return aCtx().getVideoRoomMng().buildRoomsList(e.plugindata.data.list),!0}.bind(this))},PluginHandlerVideoRoom.prototype.getRoomInfo=function(){var e={request:"list"};this.sendMsgSignal(e,function(e){for(var t=JSIG.getPluginData(e,"list"),n=0;t&&n<t.length;n++)if(t[n].room+""==this.vRoom.room+""){this.vRoom.applyRoomInfo(t[n]);break}return!0}.bind(this))},PluginHandlerVideoRoom.prototype.getParticipantsList=function(){var e={request:"listparticipants",room:parseInt(this.vRoom.room+"")};this.sendMsgSignal(e,function(e){return this.vRoom.getRoomPanel().querySelector("#participants_amount").textContent=""+JSIG.getPluginData(e,"participants").length,!0}.bind(this))},PluginHandlerVideoRoom.prototype.joinRoom=function(){var e={request:"join",room:parseInt(this.vRoom.room+""),ptype:"publisher",id:aCtx().getJanusMng().myuserid,display:aCtx().getJanusMng().myusername};this.sendMsgSignal(e)},PluginHandlerVideoRoom.prototype.processIncomingSDP=function(e){alertMng.debug("PluginHandlerVideoRoom: Handling SDP ..."),alertMng.debug(JSON.stringify(e)),this.webRTCSession.handleRemoteJsep(e)},PluginHandlerVideoRoom.prototype.phOnSignal=function(e){alertMng.debug(" PluginHandlerVideoRoom.phOnSignal ");var t=JSIG.getPluginData(e,"room"),n=aCtx().getVideoRoomMng().activeRooms[t+""],i=(JSIG.getPluginData(e,"id"),JSIG.getJsep(e));if(i)return this.processIncomingSDP(i),void this.getRoomInfo();var s=JSIG.getPluginData(e,"videoroom");switch(s){case"destroyed":alertMng.warn("The room has been destroyed!"),alertMng.error(error,function(){});break;default:n.processSignal(e)}},PluginHandlerVideoRoom.prototype.aawConsentDialog=function(e){},PluginHandlerVideoRoom.prototype.publishMyself=function(){this.localVideoPanel&&(this.localVideoPanel.querySelector("#unpublishCtrl").disabled=!0,this.localVideoPanel.querySelector("#unpublishCtrl").onclick=null);var e={audioRecv:!1,videoRecv:!1,audioSend:!0,videoSend:!0},t=new EventCallback;t.onEvSuccess=function(e){alertMng.debug("Got publisher SDP!"),alertMng.debug(e);var t={request:"configure",audio:!0,video:!0};this.sendMsgSignal(t,null,e)}.bind(this),t.onEvError=function(e){alertMng.error("WebRTC error:",e),this.localVideoPanel&&(this.localVideoPanel.querySelector("#unpublishCtrl").title="Publish",this.localVideoPanel.querySelector("#unpublishCtrl").src="_img/publish.png",this.localVideoPanel.querySelector("#unpublishCtrl").onclick=this.publishMyself)}.bind(this),this.webRTCSession.prepareOutgoingWebrtc(e,t)},PluginHandlerVideoRoom.prototype.unpublishMyself=function(){this.localVideoPanel.querySelector("#unpublishCtrl").disabled=!0,this.localVideoPanel.querySelector("#unpublishCtrl").onclick=null;var e={request:"unpublish"};this.sendMsgSignal(e)},PluginHandlerVideoRoom.prototype.onMyselfUnpublished=function(){this.localVideoPanel.querySelector(".videoPausedCover").style.display="block",this.localVideoPanel.querySelector(".videoPausedCover").onclick=this.publishMyself,this.localVideoPanel.querySelector("#unpublishCtrl").disabled=!1,this.localVideoPanel.querySelector("#unpublishCtrl").title="Publish",this.localVideoPanel.querySelector("#unpublishCtrl").src="_img/publish.png",this.localVideoPanel.querySelector("#unpublishCtrl").onclick=this.publishMyself,this.webRTCSession.cleanupWebrtc()},PluginHandlerVideoRoom.prototype.muteMe=function(){this.webRTCSession.enableMyAudio(!1),this.localVideoPanel.querySelector("#microphoneCtrlBtn").onclick=this.unMuteMe,this.localVideoPanel.querySelector("#microphoneCtrlBtn").src="_img/microphoneOn.png",this.localVideoPanel.querySelector("#localAudioCtrl").onclick=this.unMuteMe,this.localVideoPanel.querySelector("#localAudioCtrl").title="Unmute",this.localVideoPanel.querySelector("#localAudioCtrl").src="_img/microphoneOn.png"},PluginHandlerVideoRoom.prototype.unMuteMe=function(){this.webRTCSession.enableMyAudio(!0),this.localVideoPanel.querySelector("#microphoneCtrlBtn").src="_img/microphoneOff.png",this.localVideoPanel.querySelector("#microphoneCtrlBtn").onclick=this.muteMe,this.localVideoPanel.querySelector("#localAudioCtrl").onclick=this.muteMe,this.localVideoPanel.querySelector("#localAudioCtrl").title="Mute",this.localVideoPanel.querySelector("#localAudioCtrl").src="_img/microphoneOff.png"},PluginHandlerVideoRoom.prototype.concealMyVideo=function(){this.webRTCSession.enableMyVideo(!1),this.localVideoPanel.querySelector("#localVideoCtrl").onclick=this.showMyVideo,this.localVideoPanel.querySelector("#localVideoCtrl").src="_img/videoOn.png",this.localVideoPanel.querySelector("#localVideoCtrl").title="Show",this.localVideoPanel.querySelector("#videoCtrlBtn").onclick=this.showMyVideo,this.localVideoPanel.querySelector("#videoCtrlBtn").src="_img/videoOn.png"},PluginHandlerVideoRoom.prototype.showMyVideo=function(){this.webRTCSession.enableMyVideo(!0),this.localVideoPanel.querySelector("#localVideoCtrl").onclick=this.concealMyVideo,this.localVideoPanel.querySelector("#localVideoCtrl").src="_img/videoOff.png",this.localVideoPanel.querySelector("#localVideoCtrl").title="Conceal",this.localVideoPanel.querySelector("#videoCtrlBtn").onclick=this.concealMyVideo,this.localVideoPanel.querySelector("#videoCtrlBtn").src="_img/videoOff.png"},PluginHandlerVideoRoom.prototype.aawOnLocalStream=function(e){alertMng.debug(" ::: Got a local stream :::"),this.roomPanel=aCtx().getVideoRoomMng().switchToRoom(this.vRoom);var t="local_video_panel_"+this.handlerId;this.localVideoPanel=this.roomPanel.querySelector("#"+t),this.localVideoPanel||(this.localVideoPanel=FloatDivMng.showFD(this.roomPanel,t,"videoRoomTemplates.html","#local_video_panel_template","localVideoFloatPanel","_img/floatDiv/floatDiv.png",aCtx().getJanusMng().myusername,null,!0,!1),this.localVideoPanel.FDD.aspectRatio=aCtx().getVideoRoomMng().getAspectRatio(),this.localVideoPanel.style.height=this.localVideoPanel.clientHeight+"px",this.localVideoPanel.style.width=(this.localVideoPanel.clientHeight-(this.localVideoPanel.querySelector(".videoCtrlPanel").clientHeight+this.localVideoPanel.querySelector(".fd_header").clientHeight+this.localVideoPanel.querySelector(".fd_footer").clientHeight))*aCtx().getVideoRoomMng().getAspectRatio()+"px",this.localVideoPanel.querySelector(".fd_header").title="HandleID: "+this.handlerId),this.localVideoPanel.querySelector(".videoPausedCover").style.display="none",this.localVideoPanel.querySelector("#localAudioCtrl").onclick=this.muteMe,this.localVideoPanel.querySelector("#localAudioCtrl").src="_img/microphoneOff.png",this.localVideoPanel.querySelector("#localAudioCtrl").title="Mute",this.localVideoPanel.querySelector("#microphoneCtrlBtn").onclick=this.muteMe,this.localVideoPanel.querySelector("#microphoneCtrlBtn").src="_img/microphoneOff.png",this.localVideoPanel.querySelector("#localVideoCtrl").onclick=this.concealMyVideo,this.localVideoPanel.querySelector("#localVideoCtrl").src="_img/videoOff.png",this.localVideoPanel.querySelector("#localVideoCtrl").title="Conceal",this.localVideoPanel.querySelector("#videoCtrlBtn").src="_img/videoOff.png",this.localVideoPanel.querySelector("#videoCtrlBtn").onclick=this.concealMyVideo,this.localVideoPanel.querySelector("#unpublishCtrl").title="Unpublish",this.localVideoPanel.querySelector("#unpublishCtrl").disabled=!1,this.localVideoPanel.querySelector("#unpublishCtrl").src="_img/unpublish.png",this.localVideoPanel.querySelector("#unpublishCtrl").onclick=this.unpublishMyself,this.localVideoPanel.querySelector("#unpublishCtrlBtn").disabled=!1,this.localVideoPanel.querySelector("#unpublishCtrlBtn").src="_img/unpublish.png",this.localVideoPanel.querySelector("#unpublishCtrlBtn").onclick=this.unpublishMyself;var n=this.localVideoPanel.querySelector(".localvideo");attachMediaStream(n,e);var i=this.roomPanel.querySelector(".mainvideo");i.src||reattachMediaStream(this.roomPanel.querySelector(".mainvideo"),n),this.getRoomInfo();var s=e.getVideoTracks();s&&0!==s.length||(n.classList.add("hidden"),this.localVideoPanel.innerHTML+='<div class="no-video-container"><i class="fa fa-video-camera fa-5 no-video-icon" style="height: 100%;"></i><span class="no-video-text" style="font-size: 16px;">No webcam available</span></div>')},PluginHandlerVideoRoom.prototype.aawOnRemoteStream=function(e){},PluginHandlerVideoRoom.prototype.destroyHandler=function(e,t){this.webRTCSession.cleanupWebrtc(),PluginHandler.prototype.destroyHandler.call(this,e,t)},PluginHandlerVideoRoomFeed.prototype=Object.create(PluginHandlerVideoRoom.prototype),PluginHandlerVideoRoomFeed.prototype.constructor=PluginHandlerVideoRoomFeed,PluginHandlerVideoRoomFeed.prototype.joinRoom=function(e){this.feed=e;var t={request:"join",room:parseInt(this.vRoom.room+""),ptype:"listener",id:aCtx().getJanusMng().myuserid,display:aCtx().getJanusMng().myusername,feed:this.feed};this.sendMsgSignal(t)},PluginHandlerVideoRoomFeed.prototype.processIncomingSDP=function(e){alertMng.debug("PluginHandlerVideoRoomFeed: Handling SDP ..."),alertMng.debug(e);var t={audioSend:!1,videoSend:!1},n=new EventCallback;n.onEvSuccess=function(e){alertMng.debug("Got SDP!"),alertMng.debug(e);var t={request:"start",room:parseInt(this.vRoom.room+"")};this.sendMsgSignal(t,null,e)}.bind(this),n.onEvError=function(e){alertMng.error("WebRTC error:",e),alertMng.alert("WebRTC error... "+JSON.stringify(e))},this.webRTCSession.streamsGotten(e,t,n)},PluginHandlerVideoRoomFeed.prototype.muteRemoteAudio=function(){this.remoteVideoPanel.querySelector(".remotevideo").muted=!0,this.remoteVideoPanel.querySelector("#remoteAudioCtrl").onclick=this.unmuteRemoteAudio,this.remoteVideoPanel.querySelector("#remoteAudioCtrl").src="_img/microphoneOn.png",this.remoteVideoPanel.querySelector("#remoteAudioCtrl").title="Unmute",this.remoteVideoPanel.querySelector("#microphoneCtrlBtn").onclick=this.unmuteRemoteAudio,this.remoteVideoPanel.querySelector("#microphoneCtrlBtn").src="_img/microphoneOn.png"},PluginHandlerVideoRoomFeed.prototype.unmuteRemoteAudio=function(){this.remoteVideoPanel.querySelector(".remotevideo").muted=!1,this.remoteVideoPanel.querySelector("#remoteAudioCtrl").onclick=this.muteRemoteAudio,this.remoteVideoPanel.querySelector("#remoteAudioCtrl").src="_img/microphoneOff.png",this.remoteVideoPanel.querySelector("#remoteAudioCtrl").title="Mute",this.remoteVideoPanel.querySelector("#microphoneCtrlBtn").onclick=this.muteRemoteAudio,this.remoteVideoPanel.querySelector("#microphoneCtrlBtn").src="_img/microphoneOff.png"},PluginHandlerVideoRoomFeed.prototype.pauseRemoteVideo=function(){this.remoteVideoPanel.querySelector(".remotevideo").pause(),this.remoteVideoPanel.querySelector("#remoteVideoCtrl").onclick=this.showRemoteVideo,this.remoteVideoPanel.querySelector("#remoteVideoCtrl").src="_img/videoOn.png",this.remoteVideoPanel.querySelector("#remoteVideoCtrl").title="Renew",this.remoteVideoPanel.querySelector("#videoCtrlBtn").src="_img/videoOn.png",this.remoteVideoPanel.querySelector("#videoCtrlBtn").onclick=this.showRemoteVideo},PluginHandlerVideoRoomFeed.prototype.showRemoteVideo=function(){this.remoteVideoPanel.querySelector(".remotevideo").play(),this.remoteVideoPanel.querySelector(".videoPausedCover").style.display="none",this.remoteVideoPanel.querySelector("#remoteVideoCtrl").onclick=this.pauseRemoteVideo,this.remoteVideoPanel.querySelector("#remoteVideoCtrl").src="_img/videoOff.png",this.remoteVideoPanel.querySelector("#remoteVideoCtrl").title="Pause",this.remoteVideoPanel.querySelector("#videoCtrlBtn").src="_img/videoOff.png",this.remoteVideoPanel.querySelector("#videoCtrlBtn").onclick=this.pauseRemoteVideo},PluginHandlerVideoRoomFeed.prototype.aawOnRemoteStream=function(e){alertMng.debug(" ::: Got a local stream :::"),aCtx().getNotificationMng().notifyEvent("New Remote feed. Remote: "+(this.rfdisplay||this.feed)+"; \nRoom: "+this.vRoom.description,this),this.roomPanel=this.vRoom.getRoomPanel(),this.remoteVideoPanel=loadHtmlPage("videoRoomTemplates.html","#remote_video_panel_template"),this.remoteVideoPanel=this.vRoom.videoRoomUI.wnd.document.adoptNode(this.remoteVideoPanel),this.remoteVideoPanel.id="remote_video_panel_"+this.feed,this.remoteVideoPanel.querySelector("#remoteFeed").textContent=this.rfdisplay||this.feed,this.remoteVideoPanel.querySelector("#remoteAudioCtrl").onclick=this.muteRemoteAudio,this.remoteVideoPanel.querySelector("#remoteAudioCtrl").src="_img/microphoneOff.png",this.remoteVideoPanel.querySelector("#remoteAudioCtrl").title="Mute",this.remoteVideoPanel.querySelector("#microphoneCtrlBtn").onclick=this.muteRemoteAudio,this.remoteVideoPanel.querySelector("#microphoneCtrlBtn").src="_img/microphoneOff.png",this.remoteVideoPanel.querySelector("#remoteVideoCtrl").onclick=this.pauseRemoteVideo,this.remoteVideoPanel.querySelector("#remoteVideoCtrl").src="_img/videoOff.png",this.remoteVideoPanel.querySelector("#remoteVideoCtrl").title="Pause",this.remoteVideoPanel.querySelector("#videoCtrlBtn").src="_img/videoOff.png",this.remoteVideoPanel.querySelector("#videoCtrlBtn").onclick=this.pauseRemoteVideo;var t=this.roomPanel.querySelector(".video_line"),n=getChildsWidthAmount(t);t.childElementCount>0&&t.clientWidth<n+n/t.childElementCount&&(t.style.width=n+n/t.childElementCount+"px"),t.appendChild(this.remoteVideoPanel),this.remoteVideoPanel.scrollIntoView(),this.remoteVideoPanel.classList.remove("hidden");var i=this.remoteVideoPanel.querySelector(".remotevideo");attachMediaStream(i,e),i.muted=!1,reattachMediaStream(this.roomPanel.querySelector(".mainvideo"),i)},JanusSignalSession.sessions={},JanusSignalSession.prototype.createSession=function(e){var t={janus:"create"},n=new TransportEventsHandler;n.onTEvMessage=this.handleSignallingEvent.bind(this),n.onTEvInit=function(){this.sendSignal(t,function(t){return this.handleSessionCreationAnswer(t,e),!0}.bind(this))}.bind(this),n.onTEvError=function(t,n){e.onEvError(t,n)},this.transport.initTransport(n)},JanusSignalSession.prototype.closeSession=function(){var e={janus:"destroy",transaction:randomString(12)};this.sendSignal(e),this.keepaliveTimeoutId&&clearTimeout(this.keepaliveTimeoutId)},JanusSignalSession.prototype.sendSignal=function(e,t,n){this.sessionId&&(e.session_id=this.sessionId),e.transaction=genRandomString(12),t&&(this.transactionHandlers[e.transaction]=t),n!==!1&&alertMng.trace("Sending signal: "+JSON.stringify(e)),this.transport.sendMsg(JSON.stringify(e))},JanusSignalSession.prototype.handleSessionCreationAnswer=function(e,t){return"success"===e.janus&&e.data.id?(this.connected=!0,this.sessionId=e.data.id,JanusSignalSession.sessions[this.sessionId]=this,this.keepAlive=this.keepAlive.bind(this),this.keepaliveTimeoutId=setTimeout(this.keepAlive,3e4),t&&t.onEvSuccess("",this),!0):(alertMng.alert(this,"wrong session creation answer: "+e),t&&t.onEvError("wrong session creation answer: "+e,this),!0)},JanusSignalSession.prototype.keepAlive=function(){this.keepaliveTimeoutId=setTimeout(this.keepAlive,3e4);var e={janus:"keepalive"};this.sendSignal(e,null,!1)},JanusSignalSession.prototype.handleSignallingEvent=function(e){var t=JSON.parse(e);"ack"!==t.janus&&alertMng.alert("got: "+JSON.stringify(t));var n=t.transaction;if(n&&this.transactionHandlers[n]){var i=this.transactionHandlers[n](t,this);if(delete this.transactionHandlers[n],i===!0)return}switch(t.janus){case"keepalive":return;case"ack":return;case"error":alertMng.error("Ooops: "+t.error.code+" "+t.error.reason);var n=t.transaction;if(null!==n&&void 0!==n){var s=this.transactionHandlers[n];null!==s&&void 0!==s&&s(t),delete this.transactionHandlers[n]}return;case"hangup":var o=t.sender;if(void 0===o||null===o)return void alertMng.warn("Missing sender...");var r=this.pluginHandlers[o];if(!r)return void alertMng.warn("This handle is not attached to this session");return;case"detached":var o=t.sender;if(void 0===o||null===o)return void alertMng.warn("Missing sender...");var r=this.pluginHandlers[o];return r?(r.phOnDetached(),void delete this.pluginHandlers[o]):void alertMng.warn("This handle is not attached to this session");case"event":var o=t.sender;if(void 0===o||null===o)return void alertMng.warn("Missing sender...");var a=t.plugindata;if(void 0===a||null===a)return void alertMng.warn("Missing plugindata...");alertMng.debug("  -- Event is coming from "+o+" ("+a.plugin+")");var r=(a.data,this.pluginHandlers[o]);return r?void r.phOnSignal(t):void alertMng.warn("This handle is not attached to this session");default:return void alertMng.warn('Unknown message "'+t.janus+'"')}},LPTransport.prototype.initTransport=function(){$.ajax({type:"POST",url:server,cache:!1,contentType:"application/json",data:JSON.stringify(request),success:function(e){return Janus.debug(e),"success"!==e.janus?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void callbacks.error(e.error.reason)):(this.connected=!0,this.sessionId=e.data.id,Janus.log("Created session: "+sessionId),Janus.sessions[sessionId]=that,eventHandler(),void callbacks.success())},error:function(e,t,n){return Janus.error(t+": "+n),$.isArray(servers)?(serversIndex++,serversIndex==servers.length?void callbacks.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(server=null,void setTimeout(function(){createSession(callbacks)},200))):void(""===n?callbacks.error(t+": Is the gateway down?"):callbacks.error(t+": "+n))},dataType:"json"})},LPTransport.prototype.sendKeepAliveMsg=function(e){},Transport.prototype.sendKeepAliveMsg=function(e){},Transport.prototype.initTransport=function(e){},Transport.prototype.sendMsg=function(e){},WRTCSession.isAudioSendEnabled=function(e){return alertMng.debug("isAudioSendEnabled:",e),void 0===e||null===e?!0:e.audio===!1?!1:void 0===e.audioSend||null===e.audioSend?!0:e.audioSend===!0},WRTCSession.isAudioRecvEnabled=function(e){return alertMng.debug("isAudioRecvEnabled:",e),void 0===e||null===e?!0:e.audio===!1?!1:void 0===e.audioRecv||null===e.audioRecv?!0:e.audioRecv===!0},WRTCSession.isVideoSendEnabled=function(e){return alertMng.debug("isVideoSendEnabled:",e),"edge"==webrtcDetectedBrowser?(alertMng.warn("Edge doesn't support compatible video yet"),!1):void 0===e||null===e?!0:e.video===!1?!1:void 0===e.videoSend||null===e.videoSend?!0:e.videoSend===!0},WRTCSession.isVideoRecvEnabled=function(e){return alertMng.debug("isVideoRecvEnabled:",e),"edge"==webrtcDetectedBrowser?(alertMng.warn("Edge doesn't support compatible video yet"),!1):void 0===e||null===e?!0:e.video===!1?!1:void 0===e.videoRecv||null===e.videoRecv?!0:e.videoRecv===!0},WRTCSession.isDataEnabled=function(e){return alertMng.debug("isDataEnabled:",e),"edge"==webrtcDetectedBrowser?(alertMng.warn("Edge doesn't support data channels yet"),!1):void 0===e||null===e?!1:e.data===!0},WRTCSession.isTrickleEnabled=function(e){return alertMng.debug("isTrickleEnabled:",e),void 0===e||null===e?!0:e===!0},WRTCSession.prototype.prepareOutgoingWebrtc=function(e,t){this.appAgentWebRTC.aawConsentDialog(!0);var n=0,i=0,s=0;"lowres"===e.video?(i=240,s=240,n=320):"lowres-16:9"===e.video?(i=180,s=180,n=320):"hires"===e.video||"hires-16:9"===e.video?(i=720,s=720,n=1280):"stdres"===e.video?(i=480,s=480,n=640):"stdres-16:9"===e.video?(i=360,s=360,n=640):(alertMng.log("Default video setting ("+e.video+") is stdres 4:3"),i=480,s=480,n=640),alertMng.log("Adding media constraint "+e.video);var o=null;o=navigator.mozGetUserMedia?{height:{ideal:i},width:{ideal:n}}:{mandatory:{maxHeight:s,minHeight:i,maxWidth:n,minWidth:n},optional:[]},alertMng.debug(o),MediaStreamTrack.getSources(function(n){var i=n.some(function(e){return"audio"===e.kind}),s=n.some(function(e){return"video"===e.kind});if(!i&&!s)return this.appAgentWebRTC.aawConsentDialog(!1),t.onEvError("No capture device found"),!1;var r=this.appAgentWebRTC.vRoom.videoRoomUI.wnd.navigator;r.getUserMedia=r.getUserMedia||r.webkitGetUserMedia||r.mozGetUserMedia||r.msGetUserMedia,this.appAgentWebRTC.vRoom.videoRoomUI.wnd.navigator.getUserMedia({audio:i&&WRTCSession.isAudioSendEnabled(e),video:s?o:!1},function(n){this.appAgentWebRTC.aawConsentDialog(!1),this.streamsGotten(null,e,t,n)}.bind(this),function(e){this.appAgentWebRTC.aawConsentDialog(!1),t.onEvError(e)}.bind(this))}.bind(this))},WRTCSession.prototype.streamsGotten=function(e,t,n,i){var s=this.webrtcStuff;alertMng.debug("streamsGotten:",i),s.myStream=i;var o={iceServers:aCtx().getJanusMng().iceServers},r={optional:[{DtlsSrtpKeyAgreement:!0}]};if(aCtx().getJanusMng().ipv6Support===!0&&r.optional.push({googIPv6:!0}),alertMng.log("Creating PeerConnection"),alertMng.debug(r),s.pc=new RTCPeerConnection(o,r),alertMng.debug(s.pc),s.pc.getStats&&(s.volume.value=0,s.bitrate.value="0 kbits/sec"),alertMng.log("Preparing local SDP and gathering candidates (trickle="+s.trickle+")"),s.pc.onicecandidate=function(e){if(null===e.candidate||"edge"===webrtcDetectedBrowser&&e.candidate.candidate.indexOf("endOfCandidates")>0)alertMng.log("End of candidates."),s.iceDone=!0,s.trickle===!0?this.sendTrickleCandidate({completed:!0}):this.sendSDP(n);else{var t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};s.trickle===!0&&this.sendTrickleCandidate(t)}}.bind(this),i&&(alertMng.log("Adding local stream"),s.pc.addStream(i),this.appAgentWebRTC.aawOnLocalStream(i)),s.pc.onaddstream=function(e){alertMng.log("Handling Remote Stream"),alertMng.debug(e),s.remoteStream=e,this.appAgentWebRTC.aawOnRemoteStream(e.stream)}.bind(this),WRTCSession.isDataEnabled(t)){alertMng.log("Creating data channel");var a=function(e){alertMng.log("Received message on data channel: "+e.data),this.appAgentWebRTC.aawOnData(e.data)},d=function(){var e=null!==s.dataChannel?s.dataChannel.readyState:"null";alertMng.log("State change on data channel: "+e),"open"===e&&this.appAgentWebRTC.aawOnDataopen()},c=function(e){alertMng.error("Got error on data channel:",e)};s.dataChannel=s.pc.createDataChannel("JanusDataChannel",{ordered:!1}),s.dataChannel.onmessage=a,s.dataChannel.onopen=d,s.dataChannel.onclose=d,s.dataChannel.onerror=c}e?s.pc.setRemoteDescription(new RTCSessionDescription(e),function(){alertMng.log("Remote description accepted!"),this.createWebRTCAnswer(t,n)}.bind(this),n.error):this.createWebRTCOffer(t,n)},WRTCSession.prototype.sendTrickleCandidate=function(e){var t={janus:"trickle",candidate:e};this.appAgentWebRTC.sendPlainSignal(t,null,!1)},WRTCSession.prototype.sendSDP=function(e){e=e||{},e.success="function"==typeof e.success?e.success:noOp,e.error="function"==typeof e.error?e.error:noOp;var t=this.webrtcStuff;return alertMng.log("Sending offer/answer SDP..."),null===t.mySdp||void 0===t.mySdp?void alertMng.warn("Local SDP instance is invalid, not sending anything..."):(t.mySdp=t.pc.localDescription,t.sdpSent?void alertMng.log("Offer/Answer SDP already sent, not sending it again"):(alertMng.debug(e),t.sdpSent=!0,void e.success(t.mySdp)))},WRTCSession.prototype.createWebRTCOffer=function(e,t){var n=this.webrtcStuff;alertMng.log("Creating offer (iceDone="+n.iceDone+")");var i=null;i="firefox"==webrtcDetectedBrowser||"edge"==webrtcDetectedBrowser?{offerToReceiveAudio:WRTCSession.isAudioRecvEnabled(e),offerToReceiveVideo:WRTCSession.isVideoRecvEnabled(e)}:{mandatory:{OfferToReceiveAudio:WRTCSession.isAudioRecvEnabled(e),OfferToReceiveVideo:WRTCSession.isVideoRecvEnabled(e)}},alertMng.debug(i),n.pc.createOffer(function(e){if(alertMng.debug(e),(null===n.mySdp||void 0===n.mySdp)&&(alertMng.log("Setting local description"),n.mySdp=e.sdp,n.pc.setLocalDescription(e)),!n.iceDone&&!n.trickle)return void alertMng.log("Waiting for all candidates...");if(n.sdpSent)return void alertMng.log("Offer already sent, not sending it again");alertMng.log("Offer ready"),n.sdpSent=!0;var i={type:e.type,sdp:e.sdp};t.onEvSuccess(i)},t.onEvError,i)},WRTCSession.prototype.createWebRTCAnswer=function(e,t){t=t||new EventCallback;var n=this.webrtcStuff;alertMng.log("Creating answer (iceDone="+n.iceDone+")");var i=null;i="firefox"==webrtcDetectedBrowser||"edge"==webrtcDetectedBrowser?{offerToReceiveAudio:WRTCSession.isAudioRecvEnabled(e),offerToReceiveVideo:WRTCSession.isVideoRecvEnabled(e)}:{mandatory:{OfferToReceiveAudio:WRTCSession.isAudioRecvEnabled(e),OfferToReceiveVideo:WRTCSession.isVideoRecvEnabled(e)}},alertMng.debug(i),n.pc.createAnswer(function(e){if(alertMng.debug(e),(null===n.mySdp||void 0===n.mySdp)&&(alertMng.log("Setting local description"),n.mySdp=e.sdp,n.pc.setLocalDescription(e)),!n.iceDone&&!n.trickle)return void alertMng.log("Waiting for all candidates...");if(n.sdpSent)return void alertMng.log("Answer already sent, not sending it again");n.sdpSent=!0;var i={type:e.type,sdp:e.sdp};t.onEvSuccess(i)},t.onEvError,i)},WRTCSession.prototype.handleRemoteJsep=function(e,t){t=t||new EventCallback;var n=this.webrtcStuff;if(e){if(null===n.pc)return alertMng.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.onEvError("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");n.pc.setRemoteDescription(new RTCSessionDescription(e),function(){alertMng.log("Remote description accepted!"),t.onEvSuccess("Remote description accepted!")},t.onEvError)}else t.onEvError("Invalid JSEP")},WRTCSession.prototype.cleanupWebrtc=function(){alertMng.log("Cleaning WebRTC stuff");var e=this.webrtcStuff;if(null!==e&&void 0!==e){e.remoteStream=null,e.volume.timer&&clearInterval(e.volume.timer),e.volume.value=null,e.bitrate.timer&&clearInterval(e.bitrate.timer),e.bitrate.timer=null,e.bitrate.bsnow=null,e.bitrate.bsbefore=null,e.bitrate.tsnow=null,e.bitrate.tsbefore=null,e.bitrate.value=null;try{e.streamExternal||null===e.myStream||void 0===e.myStream||(alertMng.log("Stopping local stream"),e.myStream.stop())}catch(t){}try{if(!e.streamExternal&&null!==e.myStream&&void 0!==e.myStream){alertMng.log("Stopping local stream tracks");var n=e.myStream.getTracks();for(var i in n){var s=n[i];alertMng.log(s),null!==s&&void 0!==s&&s.stop()}}}catch(t){}e.streamExternal=!1,e.myStream=null;try{e.pc.close()}catch(t){}e.pc=null,e.mySdp=null,e.iceDone=!1,e.sdpSent=!1,e.dataChannel=null,e.dtmfSender=null}},WRTCSession.prototype.enableMyAudio=function(e){return this.webrtcStuff.pc&&this.webrtcStuff.myStream?this.webrtcStuff.myStream.getAudioTracks()&&0!==this.webrtcStuff.myStream.getAudioTracks().length?(this.webrtcStuff.myStream.getAudioTracks()[0].enabled=e!==!1,!0):(alertMng.warn("No audio track"),!1):(alertMng.warn("Invalid local MediaStream"),!1)},WRTCSession.prototype.enableMyVideo=function(e){return this.webrtcStuff.pc&&this.webrtcStuff.myStream?this.webrtcStuff.myStream.getVideoTracks()&&0!==this.webrtcStuff.myStream.getVideoTracks().length?(this.webrtcStuff.myStream.getVideoTracks()[0].enabled=e!==!1,!0):(alertMng.warn("No video track"),!1):(alertMng.warn("Invalid local MediaStream"),!1)},WSTransport.prototype.initTransport=function(e){this.transportEventsHandler=e||new TransportEventsHandler,this.ws=new WebSocket(this.serverURL,"janus-protocol");var t={error:function(){this.transportEventsHandler.onTEvError("Error connecting to the Janus WebSockets server: "+this.serverURL,this)}.bind(this),open:function(){this.transportEventsHandler.onTEvInit("",this)}.bind(this),message:function(e){this.transportEventsHandler.onTEvMessage(e.data,this)}.bind(this),close:function(){this.transportEventsHandler.onTEvClose("",this)}.bind(this)};for(var n in t)this.ws.addEventListener(n,t[n])},WSTransport.prototype.sendKeepAliveMsg=function(e){this.ws.send(e)},WSTransport.prototype.sendMsg=function(e){this.ws.send(e)};